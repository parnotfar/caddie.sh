#!/usr/bin/env bash

# Caddie.sh prompt helpers with PS1-safe color wrapping

__wrap_nonprint() {
  case "$1" in
    *"\["*"\]"*) printf '%s' "$1" ;;
    *)             printf '\[%s\]' "$1" ;;
  esac
}

RAW_RESET="$(tput sgr0 2>/dev/null || printf '\033[0m')"
RAW_RED="$(tput setaf 1 2>/dev/null || printf '\033[31m')"
RAW_GREEN="$(tput setaf 2 2>/dev/null || printf '\033[32m')"
RAW_YELLOW="$(tput setaf 3 2>/dev/null || printf '\033[33m')"
RAW_BLUE="$(tput setaf 4 2>/dev/null || printf '\033[34m')"
RAW_PURPLE="$(tput setaf 5 2>/dev/null || printf '\033[35m')"
RAW_CYAN="$(tput setaf 6 2>/dev/null || printf '\033[36m')"

PS_RESET="$(__wrap_nonprint "$RAW_RESET")"
PS_RED="$(__wrap_nonprint "$RAW_RED")"
PS_GREEN="$(__wrap_nonprint "$RAW_GREEN")"
PS_YELLOW="$(__wrap_nonprint "$RAW_YELLOW")"
PS_BLUE="$(__wrap_nonprint "$RAW_BLUE")"
PS_PURPLE="$(__wrap_nonprint "$RAW_PURPLE")"
PS_CYAN="$(__wrap_nonprint "$RAW_CYAN")"

__caddie_version() {
  if [ -f "$HOME/.caddie_version" ]; then
    # shellcheck disable=SC1090
    . "$HOME/.caddie_version"
    printf '%s' "${CADDIE_SH_VERSION:-unknown}"
  else
    printf 'unknown'
  fi
}

__csv_segment() {
  local csv_file="${CADDIE_CSV_FILE:-}"
  [ -n "$csv_file" ] || return 0
  case "$csv_file" in
    "$HOME"*) csv_file="~${csv_file#$HOME}" ;;
  esac
  printf '[%scsv:%s%s]' "$PS_CYAN" "$csv_file" "$PS_RESET"
}

__ps1_branch() {
  git rev-parse --abbrev-ref HEAD 2>/dev/null || return 0
}

set_caddie_prompt_ps1() {
  local version branch git_info github_info csv_info changes
  version="$(__caddie_version)"

  if github_status="$(gh auth status 2>/dev/null)"; then
    if printf '%s' "$github_status" | grep -q "Logged in to github.com account"; then
      local account
      account="$(printf '%s' "$github_status" | sed -n 's/.*account \([^ ]*\).*/\1/p')"
      github_info="[${PS_GREEN}gh:${account}${PS_RESET}]"
    else
      github_info="[${PS_YELLOW}gh:unknown${PS_RESET}]"
    fi
  else
    github_info="[${PS_RED}gh:none${PS_RESET}]"
  fi

  branch="$(__ps1_branch)"
  if [ -n "$branch" ]; then
    changes="$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')"
    if [ "${changes:-0}" -gt 0 ]; then
      git_info=" (${PS_PURPLE}${branch}${PS_RESET}|${PS_CYAN}+${changes}${PS_RESET})"
    else
      git_info=" (${PS_PURPLE}${branch}${PS_RESET}|${PS_GREEN}âœ“${PS_RESET})"
    fi
  else
    git_info=""
  fi

  csv_info="$(__csv_segment)"

  PROMPT_DIRTRIM=3
  PS1="[${PS_BLUE}Caddie-${version}${PS_RESET}]${github_info}${csv_info}${git_info}"
  PS1+=$'\n'"${PS_YELLOW}\w${PS_RESET} \$ "
}

PROMPT_COMMAND='set_caddie_prompt_ps1'
shopt -s checkwinsize

# Backward compatibility for modules still invoking set_caddie_prompt directly
set_caddie_prompt() {
  set_caddie_prompt_ps1
}
