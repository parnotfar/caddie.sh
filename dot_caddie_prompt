# Caddie.sh Prompt System
# This file provides a simple, reliable prompt using tput colors

# NOTE: Do NOT try to use the 'caddie cli' functions here.

source "$HOME/.caddie_modules/.caddie_github"

# Function to get caddie version
function get_caddie_version() {
    if [ -f "$HOME/.caddie_version" ]; then
        source "$HOME/.caddie_version"
        echo "$CADDIE_SH_VERSION"
    else
        echo "unknown"
    fi
}

# Function to set caddie prompt
function set_caddie_prompt() {
    local version=$(get_caddie_version)
    echo "[${BLUE}Caddie-${version}${RESET}] "
}

# Function to set git branch description prompt (optional)
function set-git-branch-description-prompt() {
    if [ -d '.git' ]; then
        local branch=`git symbolic-ref --short HEAD 2>/dev/null`
        local desc=`git config branch.${branch}.description`

        if [[ -n $desc ]]; then
            echo " ($desc) "
        fi
    fi
}

# Main prompt setup function
function set_caddie_git_prompt() {
    # Set the start of the git prompt (before git info)
    GIT_PROMPT_START='$(set_caddie_prompt)'
    
    # Set the end of the git prompt (after git info)
    GIT_PROMPT_END='$(set-git-branch-description-prompt)'
    export GIT_PROMPT_END+=' \n\[\033[0;37m\]$(date +%H:%M)\[\033[0;0m\] $ '
}

# Main prompt setup function
function set_caddie_prompt() {
    local version=$(get_caddie_version)
    local git_info=""
    local github_info=""
    
    # Add GitHub CLI authentication status
    local github_status=$(gh auth status 2>/dev/null)
    
    if [ -n "${github_status}" ]; then
        case "${github_status}" in
            "none")
                github_info="[${RED}gh:none${RESET}]"
                ;;
            *":unauthenticated")
                local account=$(echo "${github_status}" | cut -d: -f1)
                github_info="[${RED}gh:${account}${RESET}]"
                ;;
            *":authenticated")
                local account=$(echo "${github_status}" | cut -d: -f1)
                github_info="[${GREEN}gh:${account}${RESET}]"
                ;;
            *)
                github_info="[${YELLOW}gh:unknown${RESET}]"
                ;;
        esac
    fi
    
    if [ -d '.git' ]; then
        local branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo 'detached')
        local git_status=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
        
        if [ "$git_status" -gt 0 ]; then
            git_info=" (${PURPLE}${branch}${RESET}|${CYAN}+${git_status}${RESET})"
        else
            git_info=" (${PURPLE}${branch}${RESET}|${GREEN}âœ“${RESET})"
        fi
    fi
    
    export PS1="[${BLUE}Caddie-${version}${RESET}]${github_info}${git_info} ${YELLOW}\w${RESET} $ "
}

# Set PROMPT_COMMAND to rebuild prompt before each display
export PROMPT_COMMAND="set_caddie_prompt"
