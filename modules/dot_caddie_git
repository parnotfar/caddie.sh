#!/bin/bash

# Caddie.sh - Git Prompt and Custom File Management
# This file handles git prompt setup and custom file sourcing

source "$HOME/.caddie_modules/.caddie_cli"

# Function to source custom files
function caddie_source_custom_files() {
    # Source custom bash profile additions
    if [ -f "$HOME/.bash_profile-caddie-custom" ]; then
        source "$HOME/.bash_profile-caddie-custom"
    fi
    
    # Source custom bashrc additions
    if [ -f "$HOME/.bashrc-caddie-custom" ]; then
        source "$HOME/.bashrc-caddie-custom"
    fi

    return 0
}

# Set product name
export PRODUCT_NAME="Caddie"

# Source and set up our prompt
source ~/.caddie_prompt.sh
set_caddie_prompt

# Auto-setup when sourced
caddie_source_custom_files

# Git workflow functions
function caddie_git_status() {
    caddie cli:title "Git Status:"
    git status --short
    return 0
}

function caddie_git_branch() {
    caddie cli:title "Current branch: $(git branch --show-current)"
    caddie cli:title "All branches:"
    git branch -a
    return 0
}

function caddie_git_commit() {
    local message="$1"
    if [ -z "$message" ]; then
        caddie cli:red "Error: Please provide a commit message"
        caddie cli:usage "caddie git:commit <message>"
        return 1
    fi
    git add .
    git commit -m "$message"
    return 0
}

function caddie_git_push() {
    git push
    return 0
}

function caddie_git_push_set_upstream() {
    local remote="${1:-origin}"
    local branch="${2:-main}"
    
    caddie cli:title "Setting upstream for branch '${branch}' to '${remote}/${branch}'"
    git push --set-upstream "${remote}" "${branch}"
    return 0
}

function caddie_git_pull() {
    git pull
    return 0
}

function caddie_git_merge_main() {
    local remote="${1:-origin}"
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        caddie cli:red "Error: Not in a git repository"
        return 1
    fi

    local current_branch=""
    current_branch="$(git branch --show-current 2>/dev/null)"
    if [ -z "$current_branch" ]; then
        caddie cli:red "Error: Unable to detect current branch"
        return 1
    fi

    local mainline=""
    mainline="$(git symbolic-ref --quiet --short "refs/remotes/${remote}/HEAD" 2>/dev/null | sed "s#^${remote}/##")"
    if [ -z "$mainline" ]; then
        mainline="main"
    fi

    if [ "$current_branch" = "$mainline" ]; then
        caddie cli:red "Already on ${mainline}; nothing to merge"
        return 1
    fi

    caddie cli:title "Merging ${remote}/${mainline} into ${current_branch}"
    if ! git fetch "$remote" "$mainline"; then
        caddie cli:red "Failed to fetch ${remote}/${mainline}"
        return 1
    fi

    if git merge "${remote}/${mainline}"; then
        caddie cli:check "Merge completed"
        return 0
    fi

    caddie cli:red "Merge failed"
    return 1
}

function caddie_git_gacp() {
    local message="$1"
    if [ -z "$message" ]; then
        caddie cli:red "Error: Please provide a commit message"
        caddie cli:usage "caddie git:gacp <message>"
        return 1
    fi
    
    caddie cli:title "Adding all changes..."
    git add .
    
    caddie cli:title "Committing with message: '${message}'"
    git commit -m "$message"
    
    caddie cli:title "Pushing to remote..."
    git push
    return 0
}

function caddie_git_remote_add() {
    local name="$1"
    local url="$2"
    
    # If no arguments provided, auto-detect repository and use stored GitHub account
    if [ -z "${name}" ] && [ -z "${url}" ]; then
        local github_account=$(caddie_github_account_get)

        if [ -z "${github_account}" ]; then
            caddie cli:red "Error: No GitHub account set. Use 'caddie github:account:set <account>' first"
            caddie cli:usage "Or provide manual arguments: caddie git:remote:add <name> <url>"
            return 1
        fi
        
        # Auto-detect repository name from current directory
        local repo_name=$(basename "$(pwd)")
        name="origin"
        url="git@github.com:${github_account}/${repo_name}.git"
        
        caddie cli:title "Auto-detected repository: ${repo_name}"
        caddie cli:title "Using GitHub account: ${github_account}"
        caddie cli:title "Adding remote '${name}' pointing to '${url}'"
    elif [ -z "${name}" ] || [ -z "${url}" ]; then
        caddie cli:red "Error: Please provide both remote name and URL"
        caddie cli:usage "caddie git:remote:add <name> <url>"
        caddie cli:usage "Or use auto-detection: caddie git:remote:add"
        return 1
    fi
    
    git remote add "${name}" "${url}"
    caddie cli:title "Added remote '${name}' pointing to '${url}'"
    return 0
}

function caddie_git_remote_set_url() {
    local name="$1"
    local url="$2"

    if [ -z "$name" ] || [ -z "$url" ]; then
        caddie cli:red "Error: Please provide remote name and URL"
        caddie cli:usage "caddie git:remote:set-url <name> <url>"
        return 1
    fi

    git remote set-url "$name" "$url"
    caddie cli:title "Set remote '$name' URL to '$url'"

    return 0
}

function caddie_git_remote_list() {
    caddie cli:title "Remote repositories:"
    git remote -v
    return 0
}

function caddie_git_remote_remove() {
    local name="${1:-origin}"
    git remote remove "$name"
    caddie cli:title "Removed remote '$name'"
    return 0
}

function caddie_git_clone() {
    local repo_name="$1"
    
    if [ -z "${repo_name}" ]; then
        caddie cli:red "Error: Please provide repository name"
        caddie cli:usage "caddie git:clone <repo-name>"
        caddie cli:indent "Example: caddie git:clone my-project"
        return 1
    fi
    
    local github_account=$(caddie_github_account_get)
    if [ -z "${github_account}" ]; then
        caddie cli:red "Error: No GitHub account set. Use 'caddie github:account:set <account>' first"
        return 1
    fi
    
    local url="git@github.com:${github_account}/${repo_name}.git"
    
    caddie cli:title "Cloning repository: ${repo_name}"
    caddie cli:indent "Using GitHub account: ${github_account}"
    caddie cli:indent "URL: ${url}"
    
    git clone "${url}"
    return 0
}

function caddie_git_new_branch() {
    local branch_name="$1"
    
    if [ -z "${branch_name}" ]; then
        caddie cli:red "Error: Please provide a branch name"
        caddie cli:usage "caddie git:new:branch <branch-name>"
        caddie cli:indent "Example: caddie git:new:branch feature/new-feature"
        return 1
    fi
    
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        caddie cli:red "Error: Not in a git repository"
        return 1
    fi
    
    # Check if branch already exists locally
    if git show-ref --verify --quiet refs/heads/"${branch_name}"; then
        caddie cli:red "Error: Branch '${branch_name}' already exists locally"
        return 1
    fi
    
    # Check if branch already exists on remote
    if git show-ref --verify --quiet refs/remotes/origin/"${branch_name}"; then
        caddie cli:red "Error: Branch '${branch_name}' already exists on remote"
        return 1
    fi
    
    caddie cli:indent "Creating new branch: ${branch_name}"
    
    # Create and switch to new branch
    if git checkout -b "${branch_name}"; then
        caddie cli:check "Created and switched to branch '${branch_name}'"
        
        # Push branch to remote and set upstream
        caddie cli:indent "Pushing branch to remote and setting upstream..."

        if git push --set-upstream origin "${branch_name}"; then
            caddie cli:check "Branch '${branch_name}' pushed to remote and upstream set"
        else
            caddie cli:red "Failed to push branch to remote"
            return 1
        fi
    else
        caddie cli:red "Failed to create branch '${branch_name}'"
        return 1
    fi
    
    return 0
}

function caddie_git_worktree_completion_candidates() {
    local mode="${1:-all}"
    local current=""
    current=$(git rev-parse --show-toplevel 2>/dev/null || true)

    local path=""
    local locked="false"

    while IFS= read -r line; do
        case "$line" in
            worktree\ *)
                if [ -n "$path" ]; then
                    case "$mode" in
                        removable)
                            if [ "$path" != "$current" ] && [ "$locked" != "true" ]; then
                                printf '%s\n' "$path"
                            fi
                            ;;
                        lock)
                            if [ "$locked" != "true" ]; then
                                printf '%s\n' "$path"
                            fi
                            ;;
                        unlock)
                            if [ "$locked" = "true" ]; then
                                printf '%s\n' "$path"
                            fi
                            ;;
                        *)
                            printf '%s\n' "$path"
                            ;;
                    esac
                fi
                path="${line#worktree }"
                locked="false"
                ;;
            locked*)
                locked="true"
                ;;
        esac
    done < <(git worktree list --porcelain 2>/dev/null)

    if [ -n "$path" ]; then
        case "$mode" in
            removable)
                if [ "$path" != "$current" ] && [ "$locked" != "true" ]; then
                    printf '%s\n' "$path"
                fi
                ;;
            lock)
                if [ "$locked" != "true" ]; then
                    printf '%s\n' "$path"
                fi
                ;;
            unlock)
                if [ "$locked" = "true" ]; then
                    printf '%s\n' "$path"
                fi
                ;;
            *)
                printf '%s\n' "$path"
                ;;
        esac
    fi

    return 0
}

function caddie_git_worktree_list() {
    caddie cli:title "Git Worktrees"
    git worktree list
    return 0
}

function caddie_git_worktree_add() {
    local path="$1"
    local branch="$2"
    local create_flag="${3:-}"

    if [ -z "$path" ] || [ -z "$branch" ]; then
        caddie cli:red "Error: Worktree path and branch are required"
        caddie cli:usage "caddie git:worktree:add <path> <branch> [--new]"
        return 1
    fi

    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        caddie cli:red "Error: Not in a git repository"
        return 1
    fi

    if [ "$create_flag" = "--new" ] || [ "$create_flag" = "--create" ]; then
        caddie cli:title "Creating worktree (new branch: $branch)"
        if git worktree add -b "$branch" "$path"; then
            caddie cli:check "Worktree created at $path"
            return 0
        fi
        caddie cli:red "Failed to create worktree"
        return 1
    fi

    if ! git show-ref --verify --quiet "refs/heads/$branch" && ! git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
        caddie cli:red "Error: Branch '$branch' does not exist"
        caddie cli:thought "Create it first: caddie git:new:branch $branch"
        caddie cli:thought "Or create it with: caddie git:worktree:add $path $branch --new"
        return 1
    fi

    caddie cli:title "Creating worktree at $path (branch: $branch)"
    if git worktree add "$path" "$branch"; then
        caddie cli:check "Worktree created at $path"
        return 0
    fi

    caddie cli:red "Failed to create worktree"
    return 1
}

function caddie_git_worktree_remove() {
    local path="$1"
    if [ -z "$path" ]; then
        caddie cli:red "Error: Worktree path is required"
        caddie cli:usage "caddie git:worktree:remove <path>"
        caddie cli:blank
        caddie cli:title "Removable worktrees:"
        caddie_git_worktree_completion_candidates "removable" | while IFS= read -r line; do
            [ -n "$line" ] && caddie cli:indent "$line"
        done
        return 1
    fi
    caddie cli:title "Removing worktree: $path"
    if git worktree remove "$path"; then
        caddie cli:check "Worktree removed"
        return 0
    fi
    caddie cli:red "Failed to remove worktree"
    return 1
}

function caddie_git_worktree_prune() {
    caddie cli:title "Pruning worktrees"
    git worktree prune
    return $?
}

function caddie_git_worktree_lock() {
    local path="$1"
    if [ -z "$path" ]; then
        caddie cli:red "Error: Worktree path is required"
        caddie cli:usage "caddie git:worktree:lock <path>"
        caddie cli:blank
        caddie cli:title "Unlocked worktrees:"
        caddie_git_worktree_completion_candidates "lock" | while IFS= read -r line; do
            [ -n "$line" ] && caddie cli:indent "$line"
        done
        return 1
    fi
    caddie cli:title "Locking worktree: $path"
    if git worktree lock "$path"; then
        caddie cli:check "Worktree locked"
        return 0
    fi
    caddie cli:red "Failed to lock worktree"
    return 1
}

function caddie_git_worktree_unlock() {
    local path="$1"
    if [ -z "$path" ]; then
        caddie cli:red "Error: Worktree path is required"
        caddie cli:usage "caddie git:worktree:unlock <path>"
        caddie cli:blank
        caddie cli:title "Locked worktrees:"
        caddie_git_worktree_completion_candidates "unlock" | while IFS= read -r line; do
            [ -n "$line" ] && caddie cli:indent "$line"
        done
        return 1
    fi
    caddie cli:title "Unlocking worktree: $path"
    if git worktree unlock "$path"; then
        caddie cli:check "Worktree unlocked"
        return 0
    fi
    caddie cli:red "Failed to unlock worktree"
    return 1
}

function caddie_git_worktree_cd() {
    local path="$1"
    if [ -z "$path" ]; then
        caddie cli:red "Error: Worktree path is required"
        caddie cli:usage "caddie git:worktree:cd <path>"
        caddie cli:blank
        caddie cli:title "Available worktrees:"
        caddie_git_worktree_completion_candidates "all" | while IFS= read -r line; do
            [ -n "$line" ] && caddie cli:indent "$line"
        done
        return 1
    fi
    if [ ! -d "$path" ]; then
        caddie cli:red "Error: Worktree path not found: $path"
        return 1
    fi
    cd "$path" || return 1
    caddie cli:check "Now in: $(pwd)"
    return 0
}

function caddie_git_pr_create() {
    local title="$1"
    local body="$2"
    local base_branch="${3:-main}"
    
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        caddie cli:red "Error: Not in a git repository"
        return 1
    fi
    
    # Check if GitHub CLI is installed
    if ! command -v gh > /dev/null 2>&1; then
        caddie cli:red "Error: GitHub CLI (gh) is not installed"
        caddie cli:indent "Install with: brew install gh"
        caddie cli:indent "Then authenticate with: gh auth login"
        return 1
    fi
    
    # Check GitHub CLI authentication
    if ! gh auth status > /dev/null 2>&1; then
        caddie cli:red "Error: GitHub CLI authentication required"
        caddie cli:indent "Run: caddie git:auth:login to authenticate"
        caddie cli:indent "Or check status: gh auth status"
        return 1
    fi
    
    # Check if we're on a branch (not main/master)
    local current_branch=$(git branch --show-current)
    if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
        caddie cli:red "Error: Cannot create PR from main/master branch"
        caddie cli:indent "Create a feature branch first: caddie git:new:branch feature/your-feature"
        return 1
    fi
    
    # Check if there are commits to push
    local commits_ahead=$(git rev-list --count origin/$base_branch..HEAD 2>/dev/null || echo "0")
    if [ "$commits_ahead" -eq 0 ]; then
        caddie cli:red "Error: No commits to create PR with"
        caddie cli:indent "Make some commits and push them first"
        return 1
    fi
    
    # Push current branch if not already pushed
    caddie cli:indent "Ensuring branch is pushed to remote..."
    if ! git push --set-upstream origin "$current_branch" 2>/dev/null; then
        caddie cli:indent "Branch already up to date"
    fi
    
    # Generate title from commit messages if not provided
    if [ -z "$title" ]; then
        title=$(git log --oneline -1 --pretty=format:"%s")
        caddie cli:indent "Using commit message as title: $title"
    fi
    
    # Generate body from commit messages if not provided
    if [ -z "$body" ]; then
        body="## Changes\n\n"
        body+="$(git log --oneline origin/$base_branch..HEAD --pretty=format:"- %s")"
        body+="\n\n## Description\n\n"
        body+="This PR includes the changes from the current branch.\n\n"
        body+="## Testing\n\n"
        body+="- [ ] Code has been tested\n"
        body+="- [ ] All tests pass\n"
        body+="- [ ] Documentation updated (if needed)"
    fi
    
    caddie cli:indent "Creating pull request..."
    caddie cli:indent "Title: $title"
    caddie cli:indent "Base branch: $base_branch"
    caddie cli:indent "Head branch: $current_branch"
    
    # Create the pull request
    if gh pr create --title "$title" --body "$body" --base "$base_branch" --head "$current_branch"; then
        caddie cli:check "Pull request created successfully"
        caddie cli:indent "View at: $(gh pr view --web --json url --jq .url 2>/dev/null || echo "Check GitHub")"
    else
        caddie cli:red "Failed to create pull request"
        return 1
    fi
    
    return 0
}

function caddie_git_pr_approve() {
    local pr_identifier="$1"
    local pr_view pr_number pr_title pr_branch pr_url

    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        caddie cli:red "Error: Not in a git repository"
        return 1
    fi

    if ! command -v gh > /dev/null 2>&1; then
        caddie cli:red "Error: GitHub CLI (gh) is not installed"
        caddie cli:indent "Install with: brew install gh"
        return 1
    fi

    if ! gh auth status > /dev/null 2>&1; then
        caddie cli:red "Error: GitHub CLI authentication required"
        caddie cli:indent "Run: caddie git:auth:login to authenticate"
        return 1
    fi

    if [ -z "$pr_identifier" ]; then
        caddie cli:red "Error: Please provide a pull request number or branch"
        caddie cli:usage "caddie git:pr:approve <pr-number|branch>"
        return 1
    fi

    caddie cli:title "Approving pull request: $pr_identifier"

    pr_view=$(gh pr view "$pr_identifier" --json number,title,headRefName,url --jq '[.number, .title, .headRefName, .url] | @tsv' 2>/dev/null || true)
    if [ -n "$pr_view" ]; then
        local IFS=$'\t'
        read -r pr_number pr_title pr_branch pr_url <<< "$pr_view"
        if [ -n "$pr_number" ] && [ -n "$pr_title" ]; then
            caddie cli:indent "PR #${pr_number}: ${pr_title}"
        fi
        if [ -n "$pr_branch" ]; then
            caddie cli:indent "Branch: ${pr_branch}"
        fi
        if [ -n "$pr_url" ]; then
            caddie cli:indent "URL: ${pr_url}"
        fi
    else
        caddie cli:yellow "Unable to retrieve PR details; continuing with approval"
    fi

    if gh pr review "$pr_identifier" --approve; then
        caddie cli:check "Pull request approved"
        return 0
    fi

    caddie cli:red "Failed to approve pull request"
    return 1
}

function caddie_git_pr_completion_candidates() {
    local pr_lines
    declare -A seen_candidates=()
    local -a candidates=()

    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        return 0
    fi

    if ! command -v gh > /dev/null 2>&1; then
        return 0
    fi

    if ! gh auth status > /dev/null 2>&1; then
        return 0
    fi

    pr_lines=$(gh pr list --state open --limit 30 --json number,headRefName --jq '.[] | "\(.number)\t\(.headRefName)"' 2>/dev/null || true)
    if [ -z "$pr_lines" ]; then
        return 0
    fi

    while IFS=$'\t' read -r pr_number pr_head_ref; do
        if [ -n "$pr_number" ] && [ -z "${seen_candidates[$pr_number]}" ]; then
            candidates+=("$pr_number")
            seen_candidates[$pr_number]=1
        fi
        if [ -n "$pr_head_ref" ] && [ "$pr_head_ref" != "null" ] && [ -z "${seen_candidates[$pr_head_ref]}" ]; then
            candidates+=("$pr_head_ref")
            seen_candidates[$pr_head_ref]=1
        fi
    done <<< "$pr_lines"

    if [ ${#candidates[@]} -eq 0 ]; then
        return 0
    fi

    printf '%s\n' "${candidates[@]}"
    return 0
}

function caddie_git_auth_login() {
    # Check if GitHub CLI is installed
    if ! command -v gh > /dev/null 2>&1; then
        caddie cli:red "Error: GitHub CLI (gh) is not installed"
        caddie cli:indent "Install with: brew install gh"
        caddie cli:indent "Or run: make setup-github"
        return 1
    fi
    
    # Check if already authenticated
    if gh auth status > /dev/null 2>&1; then
        local auth_user=$(gh api user --jq .login 2>/dev/null)
        caddie cli:yellow "Already authenticated with GitHub CLI as: $auth_user"
        caddie cli:indent "To re-authenticate, run: gh auth logout && gh auth login"
        return 0
    fi
    
    caddie cli:title "GitHub CLI Authentication"
    caddie cli:blank
    caddie cli:indent "This will open your browser to authenticate with GitHub"
    caddie cli:indent "Choose your preferred authentication method:"
    caddie cli:blank
    caddie cli:indent "1. Login with a web browser (recommended)"
    caddie cli:indent "2. Paste an authentication token"
    caddie cli:indent "3. Login via SSH key"
    caddie cli:blank
    
    # Start the authentication process
    caddie cli:indent "Starting GitHub CLI authentication..."
    
    if gh auth login; then
        caddie cli:check "Successfully authenticated with GitHub CLI"
        
        # Get the authenticated user
        auth_user=$(gh api user --jq .login 2>/dev/null)
        if [ -n "$auth_user" ]; then
            caddie cli:indent "Authenticated as: $auth_user"
            
            # Check if we should set this as the stored account
            local stored_account=$(caddie_github_account_get)
            if [ -z "$stored_account" ]; then
                caddie cli:indent "Setting $auth_user as your default GitHub account..."
                caddie_github_account_set "$auth_user"
                caddie cli:check "GitHub account set to: $auth_user"
            elif [ "$auth_user" != "$stored_account" ]; then
                caddie cli:yellow "Authenticated as $auth_user but stored account is $stored_account"
                caddie cli:indent "Update stored account: caddie github:account:set $auth_user"
            else
                caddie cli:check "Authenticated account matches stored account: $auth_user"
            fi
        fi
        
        caddie cli:blank
        caddie cli:indent "You can now use:"
        caddie cli:indent "  caddie git:pr:create 'Create pull request'"
        caddie cli:indent "  caddie github:auth:check"
        caddie cli:indent "  gh pr list, gh issue list, etc."
        
    else
        caddie cli:red "Failed to authenticate with GitHub CLI"
        caddie cli:indent "Try running 'gh auth login' manually for more details"
        return 1
    fi
    
    return 0
}

function caddie_git_help() {
    caddie cli:title "Git Module Commands"
    caddie cli:blank
    
    caddie cli:usage "caddie git:<command>"
    caddie cli:blank
    
    caddie cli:title "Commands:"
    caddie cli:indent "status              Show git status"
    caddie cli:indent "branch              Show current and all branches"
    caddie cli:indent "new:branch <name>   Create new branch and push to remote"
    caddie cli:indent "commit <message>    Add all changes and commit with message"
    caddie cli:indent "gacp <message>      Add all changes, commit, and push in one command"
    caddie cli:indent "auth:login          Authenticate with GitHub CLI"
    caddie cli:indent "pr:create [title] [body] [base]  Create pull request using GitHub CLI"
    caddie cli:indent "pr:approve <pr>     Approve pull request using GitHub CLI"
    caddie cli:indent "push               Push to remote repository"
    caddie cli:indent "push:set:upstream [<remote>] [<branch>]  Set upstream branch (defaults: origin, main)"
    caddie cli:indent "pull               Pull from remote repository"
    caddie cli:indent "merge:main [remote]  Merge mainline into current branch"
    caddie cli:indent "clone <repo-name>  Clone repository using stored GitHub account"
    caddie cli:blank
    
    caddie cli:title "Worktrees:"
    caddie cli:indent "worktree:list                  List worktrees"
    caddie cli:indent "worktree:add <path> <branch> [--new]  Add worktree"
    caddie cli:indent "worktree:remove <path>         Remove worktree"
    caddie cli:indent "worktree:prune                 Prune stale worktrees"
    caddie cli:indent "worktree:lock <path>           Lock worktree"
    caddie cli:indent "worktree:unlock <path>         Unlock worktree"
    caddie cli:indent "worktree:cd <path>             Change to worktree directory"
    caddie cli:blank
    
    caddie cli:title "Remote Management:"
    caddie cli:indent "remote:add [<name> <url>]  Add remote (auto-detects if no args)"
    caddie cli:indent "remote:set-url <name> <url> Set remote URL"
    caddie cli:indent "remote:list                 List all remotes"
    caddie cli:indent "remote:remove [<name>]        Remove remote (defaults to origin)"
    caddie cli:blank
    
    caddie cli:title "Examples:"
    caddie cli:indent "caddie git:status"
    caddie cli:indent "caddie git:auth:login"
    caddie cli:indent "caddie git:new:branch feature/new-feature"
    caddie cli:indent "caddie git:commit 'Add new feature'"
    caddie cli:indent "caddie git:gacp 'Quick commit and push'"
    caddie cli:indent "caddie git:pr:create 'Add new feature' 'Description of changes'"
    caddie cli:indent "caddie git:pr:approve 42"
    caddie cli:indent "caddie git:remote:add"
    caddie cli:indent "caddie git:push"
    caddie cli:indent "caddie git:clone my-project"
    caddie cli:indent "caddie git:merge:main"
    caddie cli:indent "caddie git:worktree:add ../repo-worktree feature/analytics"
    caddie cli:indent "caddie git:worktree:list"
    caddie cli:blank
    caddie cli:title "Setup GitHub Integration:"
    caddie cli:indent "caddie github:account:set <account>  Set GitHub account"
    caddie cli:indent "caddie git:remote:add                Auto-add remote"
    caddie cli:blank
    return 0
}

function caddie_git_description() {
    # caddie:lint:disable
    echo 'Git workflow enhancements'
    # caddie:lint:enable
    return 0
}

# Export functions for external use
export -f caddie_source_custom_files
export -f caddie_git_status
export -f caddie_git_branch
export -f caddie_git_new_branch
export -f caddie_git_commit
export -f caddie_git_gacp
export -f caddie_git_auth_login
export -f caddie_git_pr_create
export -f caddie_git_pr_approve
export -f caddie_git_pr_completion_candidates
export -f caddie_git_worktree_completion_candidates
export -f caddie_git_push
export -f caddie_git_push_set_upstream
export -f caddie_git_pull
export -f caddie_git_merge_main
export -f caddie_git_remote_add
export -f caddie_git_remote_set_url
export -f caddie_git_remote_list
export -f caddie_git_remote_remove
export -f caddie_git_clone
export -f caddie_git_worktree_list
export -f caddie_git_worktree_add
export -f caddie_git_worktree_remove
export -f caddie_git_worktree_prune
export -f caddie_git_worktree_lock
export -f caddie_git_worktree_unlock
export -f caddie_git_worktree_cd
export -f caddie_git_help
export -f caddie_git_description
