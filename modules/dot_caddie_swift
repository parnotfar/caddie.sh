#!/bin/bash

# Caddie.sh - Swift Package Manager helpers

source "$HOME/.caddie_modules/.caddie_cli"

function caddie_swift_require_toolchain() {
    if ! command -v swift >/dev/null 2>&1; then
        caddie cli:red "Error: Swift toolchain not found"
        caddie cli:thought "Install Xcode or the command line tools via xcode-select --install"
        return 1
    fi
    return 0
}

function caddie_swift_require_package() {
    caddie_swift_require_toolchain || return 1
    if [ ! -f "Package.swift" ]; then
        caddie cli:red "Error: Not inside a Swift Package (Package.swift missing)"
        return 1
    fi
    return 0
}

function caddie_swift_init_internal() {
    caddie_swift_require_toolchain || return 1
    local name="$1"
    local type="$2"

    if [ -z "$name" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie swift:init <name>"
        caddie cli:thought "Use: caddie swift:init:library <name>"
        return 1
    fi
    if [ -z "$type" ]; then
        type="executable"
    fi
    if [ "$type" != "executable" ] && [ "$type" != "library" ]; then
        caddie cli:red "Error: Invalid package type '$type'"
        caddie cli:thought "Use: caddie swift:init:executable <name>"
        caddie cli:thought "Use: caddie swift:init:library <name>"
        return 1
    fi
    if [ -d "$name" ]; then
        caddie cli:red "Error: Directory '$name' already exists"
        return 1
    fi

    caddie cli:title "Creating Swift package '$name' (type: $type)..."
    if ! mkdir "$name"; then
        caddie cli:red "Failed to create directory '$name'"
        return 1
    fi
    (
        cd "$name" && swift package init --name "$name" --type "$type"
    )
    local status=$?
    if [ $status -ne 0 ]; then
        caddie cli:red "swift package init failed (exit $status)"
        return $status
    fi
    cat > "$name/.gitignore" <<'GIT'
/.build
/DerivedData
/.swiftpm
Package.resolved
GIT
    caddie cli:check "Swift package '$name' created"
    caddie cli:indent "Location: $(pwd)/$name"
    caddie cli:indent "Build: cd $name && caddie swift:build"
}

function caddie_swift_init() {
    local name="$1"
    shift || true
    if [ $# -gt 0 ]; then
        caddie cli:red "Error: swift:init no longer accepts flags"
        caddie cli:thought "Use: caddie swift:init:library <name>"
        caddie cli:thought "Use: caddie swift:init:executable <name>"
        return 1
    fi
    caddie_swift_init_internal "$name" "executable"
    return $?
}

function caddie_swift_init_executable() {
    local name="$1"
    shift || true
    if [ $# -gt 0 ]; then
        caddie cli:red "Error: Unexpected arguments for swift:init:executable"
        caddie cli:usage "caddie swift:init:executable <name>"
        return 1
    fi
    caddie_swift_init_internal "$name" "executable"
    return $?
}

function caddie_swift_init_library() {
    local name="$1"
    shift || true
    if [ $# -gt 0 ]; then
        caddie cli:red "Error: Unexpected arguments for swift:init:library"
        caddie cli:usage "caddie swift:init:library <name>"
        return 1
    fi
    caddie_swift_init_internal "$name" "library"
    return $?
}

function caddie_swift_build() {
    caddie_swift_require_package || return 1
    caddie cli:title "Building Swift package..."
    swift build "$@"
    local status=$?
    if [ $status -eq 0 ]; then
        caddie cli:check "Swift build completed"
    else
        caddie cli:red "Swift build failed ($status)"
    fi
    return $status
}

function caddie_swift_test() {
    caddie_swift_require_package || return 1
    caddie cli:title "Running Swift tests..."
    swift test "$@"
    local status=$?
    if [ $status -eq 0 ]; then
        caddie cli:check "Swift tests completed"
    else
        caddie cli:red "Swift tests failed ($status)"
    fi
    return $status
}

function caddie_swift_test_filter() {
    caddie_swift_require_package || return 1
    local filter="$1"
    if [ -z "$filter" ]; then
        caddie cli:red "Error: Provide an XCTest filter"
        caddie cli:usage "caddie swift:test:filter <TestCase/testMethod>"
        return 1
    fi
    caddie cli:title "Running tests matching '$filter'..."
    swift test --filter "$filter"
}

function caddie_swift_run() {
    caddie_swift_require_package || return 1
    caddie cli:title "Running Swift target..."
    swift run "$@"
}

function caddie_swift_run_tool() {
    caddie_swift_require_package || return 1
    local target="$1"
    shift || true
    if [ -z "$target" ]; then
        caddie cli:red "Error: Provide an executable target"
        caddie cli:usage "caddie swift:run:tool <target> [-- <args>]"
        return 1
    fi
    caddie cli:title "Running Swift target '$target'..."
    swift run "$target" "$@"
}

function caddie_swift_package_resolve() {
    caddie_swift_require_package || return 1
    caddie cli:title "Resolving Swift package dependencies..."
    swift package resolve
}

function caddie_swift_package_update() {
    caddie_swift_require_package || return 1
    caddie cli:title "Updating Swift package dependencies..."
    swift package update
}

function caddie_swift_package_clean() {
    caddie_swift_require_package || return 1
    caddie cli:title "Cleaning Swift package build artifacts..."
    swift package clean
    rm -rf .build
    caddie cli:check "Clean complete"
}

function caddie_swift_package_describe() {
    caddie_swift_require_package || return 1
    swift package describe
}

function caddie_swift_format() {
    caddie_swift_require_package || return 1
    if ! command -v swift-format >/dev/null 2>&1; then
        caddie cli:red "swift-format not installed"
        caddie cli:thought "Install via Homebrew: brew install swift-format"
        return 1
    fi
    if [ $# -gt 0 ]; then
        caddie cli:red "Error: swift:format no longer accepts flags"
        caddie cli:thought "Use: caddie swift:format:lint"
        return 1
    fi
    caddie cli:title "Formatting Swift sources..."
    swift-format format --in-place --recursive Sources Tests
}

function caddie_swift_format_lint() {
    caddie_swift_require_package || return 1
    if ! command -v swift-format >/dev/null 2>&1; then
        caddie cli:red "swift-format not installed"
        caddie cli:thought "Install via Homebrew: brew install swift-format"
        return 1
    fi
    caddie cli:title "Checking Swift formatting..."
    swift-format lint --recursive Sources Tests
}

function caddie_swift_lint() {
    caddie_swift_require_package || return 1
    if ! command -v swiftlint >/dev/null 2>&1; then
        caddie cli:red "SwiftLint not installed"
        caddie cli:thought "Install via Homebrew: brew install swiftlint"
        return 1
    fi
    caddie cli:title "Running SwiftLint..."
    swiftlint "$@"
}

function caddie_swift_gitignore() {
    caddie cli:title "Writing Swift .gitignore..."
    cat > .gitignore <<'GIT'
/.build
/DerivedData
/.swiftpm
Package.resolved
.xcodeproj
xcuserdata/
*.xcworkspace
*.xcodeproj
*.DS_Store
GIT
    caddie cli:check "Swift .gitignore ready"
    return 0
}

# MARK: - Xcode Project Commands (for projects using Swift Packages)

function caddie_swift_require_xcode_project() {
    local project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
    if [ -z "$project_file" ]; then
        caddie cli:red "Error: Not in an Xcode project directory (no .xcodeproj found)"
        return 1
    fi
    return 0
}

function caddie_swift_xcode_project() {
    caddie_swift_require_xcode_project || return 1
    local project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
    printf '%s\n' "$(basename "$project_file")"
}

function caddie_swift_xcode_packages_check() {
    caddie_swift_require_xcode_project || return 1
    local project_file=""
    local pbxproj=""
    local -a packages=()
    local line=""
    project_file=$(caddie_swift_xcode_project)
    pbxproj="$project_file/project.pbxproj"

    if [ ! -f "$pbxproj" ]; then
        caddie cli:red "Error: project.pbxproj not found in $project_file"
        return 1
    fi

    if ! grep -q "XCLocalSwiftPackageReference\|XCRemoteSwiftPackageReference" "$pbxproj" 2>/dev/null; then
        caddie cli:yellow "No Swift Package dependencies found in project"
        caddie cli:thought "Add packages in Xcode: Project Settings → Package Dependencies → Add Package"
        return 1
    fi

    while read -r line; do
        line="${line#*repositoryURL = }"
        line="${line#*path = }"
        line="${line%;}"
        line="${line#\"}"
        line="${line%\"}"
        if [ -n "$line" ]; then
            packages+=("$line")
        fi
    done < <(grep -E "repositoryURL =|path =" "$pbxproj" | sed -e 's/^[[:space:]]*//')

    caddie cli:check "Swift Package dependencies detected"
    if [ "${#packages[@]}" -gt 0 ]; then
        caddie cli:title "Packages"
        local package=""
        for package in "${packages[@]}"; do
            caddie cli:indent "$package"
        done
    fi

    return 0
}

function caddie_swift_xcode_packages_add() {
    caddie_swift_require_xcode_project || return 1
    local target="$1"
    shift || true

    if [ -z "$target" ] || [ "$#" -lt 2 ] || [ $(( $# % 2 )) -ne 0 ]; then
        caddie cli:red "Error: Provide a target and package/product pairs"
        caddie cli:usage "caddie swift:xcode:packages:add <target> <package_path> <product> [<package_path> <product> ...]"
        return 1
    fi

    if ! command -v ruby >/dev/null 2>&1; then
        caddie cli:red "Error: Ruby is required to add packages"
        caddie cli:indent "Install with: caddie ruby:setup"
        return 1
    fi

    if ! ruby -e "require 'xcodeproj'" >/dev/null 2>&1; then
        caddie cli:yellow "xcodeproj gem not found; installing..."
        if command -v caddie >/dev/null 2>&1; then
            caddie ruby:gem:install xcodeproj || return 1
        else
            caddie cli:red "Error: Unable to install xcodeproj gem"
            caddie cli:indent "Run: caddie ruby:gem:install xcodeproj"
            return 1
        fi
    fi

    local script_path=""
    local module_dir=""
    module_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    if [ -f "$module_dir/bin/add_swift_packages.rb" ]; then
        script_path="$module_dir/bin/add_swift_packages.rb"
    elif [ -f "$module_dir/../bin/add_swift_packages.rb" ]; then
        script_path="$module_dir/../bin/add_swift_packages.rb"
    elif [ -f "$HOME/.caddie_modules/bin/add_swift_packages.rb" ]; then
        script_path="$HOME/.caddie_modules/bin/add_swift_packages.rb"
    fi

    if [ -z "$script_path" ]; then
        caddie cli:red "Error: add_swift_packages.rb script not found"
        caddie cli:indent "Run: make install"
        return 1
    fi

    local project_file=""
    project_file=$(caddie_swift_xcode_project)

    caddie cli:title "Adding Swift packages to $project_file"
    caddie cli:indent "Target: $target"

    ruby "$script_path" "$project_file" "$target" "$@"
    return $?
}

function caddie_swift_xcode_ui_test_targets() {
    caddie_swift_require_xcode_project || return 1
    local project_file=$(caddie_swift_xcode_project)
    local pbxproj="$project_file/project.pbxproj"
    local in_target=""
    local name=""
    local is_ui=""
    if [ ! -f "$pbxproj" ]; then
        caddie cli:red "Error: project.pbxproj not found in $project_file"
        return 1
    fi
    awk '
        $0 ~ /isa = PBXNativeTarget;/ {
            in_target=1;
            name="";
            is_ui=0;
        }
        in_target && $0 ~ /name = / {
            name=$0;
            sub(/^[[:space:]]*name = /, "", name);
            sub(/;[[:space:]]*$/, "", name);
            gsub(/"/, "", name);
        }
        in_target && $0 ~ /productType = "com.apple.product-type.bundle.ui-testing"/ {
            is_ui=1;
        }
        in_target && $0 ~ /^[[:space:]]*};/ {
            if (is_ui && name != "") {
                print name;
            }
            in_target=0;
            name="";
            is_ui=0;
        }
    ' "$pbxproj"
    return 0
}


function caddie_swift_xcode_test_bundle() {
    caddie_swift_require_xcode_project || return 1
    local scheme="$1"
    if [ -z "$scheme" ]; then
        scheme=$(caddie_swift_xcode_scheme)
    fi
    local project_file=$(caddie_swift_xcode_project)
    local scheme_file="$project_file/xcshareddata/xcschemes/$scheme.xcscheme"
    local in_target=""
    local name=""
    local is_unit=""
    if [ ! -f "$scheme_file" ]; then
        scheme_file=$(find "$project_file/xcuserdata" -path "*/xcschemes/$scheme.xcscheme" -type f 2>/dev/null | head -1)
    fi

    local bundle=""
    if [ -f "$scheme_file" ]; then
        bundle=$(sed -n '/<TestAction/,/<\/TestAction>/p' "$scheme_file" | sed -n 's/.*BlueprintName="\([^"]\+\)".*/\1/p' | head -1)
        if [ -z "$bundle" ]; then
            bundle=$(sed -n '/<TestAction/,/<\/TestAction>/p' "$scheme_file" | sed -n 's/.*BuildableName="\([^"]\+\)".*/\1/p' | grep -E '\.xctest$' | sed 's/\.xctest$//' | head -1)
        fi
    fi

    if [ -z "$bundle" ]; then
        local pbxproj="$project_file/project.pbxproj"
        if [ -f "$pbxproj" ]; then
            bundle=$(awk '
                $0 ~ /isa = PBXNativeTarget;/ {in_target=1; name=""; is_unit=0;}
                in_target && $0 ~ /name = / {
                    name=$0;
                    sub(/^[[:space:]]*name = /, "", name);
                    sub(/;[[:space:]]*$/, "", name);
                    gsub(/"/, "", name);
                }
                in_target && $0 ~ /productType = "com.apple.product-type.bundle.unit-test"/ {is_unit=1;}
                in_target && $0 ~ /^[[:space:]]*};/ {
                    if (is_unit && name != "") print name;
                    in_target=0; name=""; is_unit=0;
                }
            ' "$pbxproj" | head -1)
        fi
    fi

    if [ -n "$bundle" ]; then
        printf '%s\n' "$bundle"
        return 0
    fi
    return 1
}

function caddie_swift_xcode_scheme() {
    local scheme="$1"
    if [ -z "$scheme" ]; then
        scheme="${CADDIE_SWIFT_XCODE_SCENE:-}"
    fi
    if [ -z "$scheme" ]; then
        # Try to find default scheme from project
        local project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
        if [ -n "$project_file" ]; then
            # List schemes and prefer app scheme (vCaddie) over package schemes
            local schemes=$(xcodebuild -list -project "$project_file" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v "^$")
            # Prefer scheme matching project name (without .xcodeproj) or common app scheme names
            local project_name=$(basename "$project_file" .xcodeproj)
            if echo "$schemes" | grep -q "^${project_name}$"; then
                scheme="$project_name"
            elif echo "$schemes" | grep -q "^vCaddie$"; then
                scheme="vCaddie"
            else
                # Fall back to first scheme
                scheme=$(echo "$schemes" | head -1 | xargs)
            fi
        fi
    fi
    printf '%s\n' "${scheme:-vCaddie}"
    return 0
}


function caddie_swift_xcode_schemes() {
    caddie_swift_require_xcode_project || return 1
    local project_file=$(caddie_swift_xcode_project)
    xcodebuild -list -project "$project_file" 2>/dev/null | awk '
        /Schemes:/ {in_schemes=1; next}
        in_schemes {
            if ($0 ~ /^[[:space:]]*$/) { exit }
            gsub(/^[[:space:]]+/, "")
            print
        }
    '
    return 0
}

function caddie_swift_xcode_scheme_exists() {
    local scheme="$1"
    if [ -z "$scheme" ]; then
        return 1
    fi
    if caddie_swift_xcode_schemes | grep -Fxq "$scheme"; then
        return 0
    fi
    return 1
}

function caddie_swift_xcode_simulator_udid() {
    local name="$1"
    if [ -z "$name" ]; then
        return 1
    fi
    # caddie:lint:disable
    # Awk variables (line, device, device_l) are awk script variables, not shell variables
    xcrun simctl list devices 2>/dev/null | awk -v name="$name" '
        BEGIN { target=tolower(name); best="" }
        {
            line=$0
            device=line
            sub(/[[:space:]]*\(.*/, "", device)
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", device)
            device_l=tolower(device)
            if (device_l == target) {
                if (match(line, /[0-9A-Fa-f-]{8,}/)) {
                    print substr(line, RSTART, RLENGTH)
                    exit
                }
            }
            if (best == "" && index(device_l, target) > 0) {
                if (match(line, /[0-9A-Fa-f-]{8,}/)) {
                    best=substr(line, RSTART, RLENGTH)
                }
            }
        }
        END { if (best != "") print best }
    '
    # caddie:lint:enable
}

function caddie_swift_xcode_device_udid() {
    local name="$1"
    if [ -z "$name" ]; then
        return 1
    fi
    # caddie:lint:disable
    # Awk variables (line, device, device_l) are awk script variables, not shell variables
    xcrun xctrace list devices 2>/dev/null | awk -v name="$name" '
        BEGIN { target=tolower(name); best="" }
        {
            line=$0
            device=line
            sub(/[[:space:]]*\(.*/, "", device)
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", device)
            device_l=tolower(device)
            if (device_l == target) {
                if (match(line, /[0-9A-Fa-f-]{8,}/)) {
                    print substr(line, RSTART, RLENGTH)
                    exit
                }
            }
            if (best == "" && index(device_l, target) > 0) {
                if (match(line, /[0-9A-Fa-f-]{8,}/)) {
                    best=substr(line, RSTART, RLENGTH)
                }
            }
        }
        END { if (best != "") print best }
    '
    # caddie:lint:enable
}

function caddie_swift_xcode_app_info() {
    caddie_swift_require_xcode_project || return 1
    local scheme="$1"
    local sdk="$2"
    local configuration="${3:-Debug}"
    if [ -z "$scheme" ]; then
        scheme=$(caddie_swift_xcode_scheme)
    fi
    if [ -z "$sdk" ]; then
        sdk="iphonesimulator"
    fi
    local project_file=$(caddie_swift_xcode_project)
    local settings
    settings=$(xcodebuild -project "$project_file" -scheme "$scheme" -configuration "$configuration" -sdk "$sdk" -showBuildSettings 2>/dev/null)
    if [ -z "$settings" ]; then
        caddie cli:red "Error: Unable to read build settings"
        return 1
    fi
    local candidate=""
    local app_info
    app_info=$(printf '%s\n' "$settings" | awk -F ' = ' '
        /^Build settings for action/ {dir=""; name=""; bundle=""; wrapper=""; next}
        $1 ~ /^[[:space:]]*TARGET_BUILD_DIR$/ {dir=$2; gsub(/^[[:space:]]+/, "", dir)}
        $1 ~ /^[[:space:]]*FULL_PRODUCT_NAME$/ {name=$2; gsub(/^[[:space:]]+/, "", name)}
        $1 ~ /^[[:space:]]*WRAPPER_NAME$/ {wrapper=$2; gsub(/^[[:space:]]+/, "", wrapper)}
        $1 ~ /^[[:space:]]*PRODUCT_BUNDLE_IDENTIFIER$/ {bundle=$2; gsub(/^[[:space:]]+/, "", bundle)}
        {
            candidate=name
            if (candidate == "") candidate=wrapper
            if (candidate ~ /\.app$/ && dir != "" && bundle != "") {
                print dir "/" candidate "|" bundle
                exit
            }
        }
    ')
    if [ -z "$app_info" ]; then
        caddie cli:red "Error: Unable to locate built app in build settings"
        return 1
    fi
    printf '%s\n' "$app_info"
    return 0
}

function caddie_swift_xcode_target_set() {
    local value="$1"
    if [ -z "$value" ]; then
        caddie cli:red "Error: Please provide a target name"
        caddie cli:usage "caddie swift:xcode:target:set <name>"
        return 1
    fi
    export CADDIE_SWIFT_XCODE_TARGET="$value"
    caddie cli:check "Xcode target set to: $value"
    return 0
}

function caddie_swift_xcode_scene_set() {
    local value="$1"
    if [ -z "$value" ]; then
        caddie cli:red "Error: Please provide a scene name"
        caddie cli:usage "caddie swift:xcode:scene:set <name>"
        return 1
    fi
    export CADDIE_SWIFT_XCODE_SCENE="$value"
    caddie cli:check "Xcode scene set to: $value"
    return 0
}

function caddie_swift_xcode_scene_get() {
    local value="${CADDIE_SWIFT_XCODE_SCENE:-}"
    if [ -n "$value" ]; then
        caddie cli:green "Xcode scene: $value"
    else
        caddie cli:yellow "No Xcode scene is set"
        caddie cli:thought "Use 'caddie swift:xcode:scene:set <name>' to set it"
    fi
    return 0
}

function caddie_swift_xcode_scene_unset() {
    if [ -n "${CADDIE_SWIFT_XCODE_SCENE:-}" ]; then
        unset CADDIE_SWIFT_XCODE_SCENE
        caddie cli:check "Xcode scene unset"
    else
        caddie cli:yellow "No Xcode scene was set"
    fi
    return 0
}

function caddie_swift_xcode_scene_require() {
    local scheme="$1"
    if [ -n "$scheme" ]; then
        return 0
    fi
    if [ -n "${CADDIE_SWIFT_XCODE_SCENE:-}" ]; then
        return 0
    fi
    caddie cli:red "Error: Xcode scene is not set"
    caddie cli:thought "Set with: caddie swift:xcode:scene:set <name>"
    caddie cli:usage "caddie swift:xcode:scene:set <name>"
    return 1
}

function caddie_swift_xcode_target_get() {
    local value="${CADDIE_SWIFT_XCODE_TARGET:-}"
    if [ -n "$value" ]; then
        caddie cli:green "Xcode target: $value"
    else
        caddie cli:yellow "No Xcode target is set"
        caddie cli:thought "Use 'caddie swift:xcode:target:set <name>' to set it"
    fi
    return 0
}

function caddie_swift_xcode_target_unset() {
    if [ -n "${CADDIE_SWIFT_XCODE_TARGET:-}" ]; then
        unset CADDIE_SWIFT_XCODE_TARGET
        caddie cli:check "Xcode target unset"
    else
        caddie cli:yellow "No Xcode target was set"
    fi
    return 0
}

function caddie_swift_prompt_segment() {
    local scene="${CADDIE_SWIFT_XCODE_SCENE:-}"
    local target="${CADDIE_SWIFT_XCODE_TARGET:-}"
    if [ -z "$scene" ] && [ -z "$target" ]; then
        return 0
    fi
    local label=""
    if [ -n "$scene" ] && [ -n "$target" ]; then
        label="${scene}-${target}"
    elif [ -n "$scene" ]; then
        label="$scene"
    else
        label="$target"
    fi
    printf '%s' "[swift: ${label}]"
    return 0
}

function caddie_swift_xcode_resolve() {
    caddie_swift_require_xcode_project || return 1
    local project_file=$(caddie_swift_xcode_project)
    caddie cli:title "Resolving Swift Package dependencies for Xcode project..."
    xcodebuild -resolvePackageDependencies -project "$project_file"
    local status=$?
    if [ $status -eq 0 ]; then
        caddie cli:check "Package dependencies resolved"
    else
        caddie cli:red "Package resolution failed ($status)"
        caddie cli:thought "If packages aren't added yet, add them in Xcode: Project Settings → Package Dependencies"
    fi
    return $status
}

function caddie_swift_xcode_build_run() {
    local output_mode="$1"
    shift || true
    caddie_swift_require_xcode_project || return 1
    local scheme="$1"
    local destination="${2:-simulator}"
    local sim_name="${3:-iPhone 16}"
    # Shift consumed arguments
    [ -n "$1" ] && shift || true
    [ -n "$1" ] && shift || true
    [ -n "$1" ] && shift || true

    caddie_swift_xcode_scene_require "$scheme" || return 1
    scheme=$(caddie_swift_xcode_scheme "$scheme")
    local project_file=$(caddie_swift_xcode_project)
    local log_label="Building Xcode project '$project_file' (scheme: $scheme)..."
    if [ "$output_mode" != "log" ]; then
        log_label="$log_label (errors only)"
    fi
    caddie cli:title "$log_label"

    # Check if packages are resolved
    if ! grep -q "XCLocalSwiftPackageReference\|XCRemoteSwiftPackageReference" "$project_file/project.pbxproj" 2>/dev/null; then
        caddie cli:yellow "Warning: No Swift Package dependencies found in project"
        caddie cli:thought "Add packages in Xcode: Project Settings → Package Dependencies → Add Package"
        caddie cli:thought "Or use: caddie swift:xcode:packages:check"
    fi

    # Resolve packages first
    caddie_swift_xcode_resolve || caddie cli:yellow "Continuing build despite package resolution warning..."

    local build_status=0
    local log_file=""
    local error_pattern="error:|fatal error:|xcodebuild: error:|clang: error:|ld: error:"

    if [ "$destination" = "simulator" ]; then
        caddie cli:indent "Building for iOS Simulator ($sim_name)..."
        if [ "$output_mode" = "log" ]; then
            xcodebuild \
                -project "$project_file" \
                -scheme "$scheme" \
                -sdk iphonesimulator \
                -destination "platform=iOS Simulator,name=$sim_name" \
                -configuration Debug \
                clean build "$@"
        else
            log_file=$(mktemp -t caddie_xcode_build.XXXXXX)
            if [ -z "$log_file" ]; then
                caddie cli:red "Error: Unable to create build log file"
                return 1
            fi
            xcodebuild \
                -project "$project_file" \
                -scheme "$scheme" \
                -sdk iphonesimulator \
                -destination "platform=iOS Simulator,name=$sim_name" \
                -configuration Debug \
                clean build "$@" >"$log_file" 2>&1
        fi
    elif [ "$destination" = "device" ]; then
        caddie cli:indent "Building for iOS Device..."
        if [ "$output_mode" = "log" ]; then
            xcodebuild \
                -project "$project_file" \
                -scheme "$scheme" \
                -sdk iphoneos \
                -configuration Release \
                clean build "$@"
        else
            log_file=$(mktemp -t caddie_xcode_build.XXXXXX)
            if [ -z "$log_file" ]; then
                caddie cli:red "Error: Unable to create build log file"
                return 1
            fi
            xcodebuild \
                -project "$project_file" \
                -scheme "$scheme" \
                -sdk iphoneos \
                -configuration Release \
                clean build "$@" >"$log_file" 2>&1
        fi
    else
        caddie cli:red "Error: Invalid destination '$destination' (use 'simulator' or 'device')"
        return 1
    fi

    build_status=$?
    if [ $build_status -eq 0 ]; then
        caddie cli:check "Build completed successfully"
    else
        caddie cli:red "Build failed ($build_status)"
        if [ "$output_mode" != "log" ] && [ -n "$log_file" ]; then
            caddie cli:title "Errors"
            if grep -E "$error_pattern" "$log_file" >/dev/null 2>&1; then
                while IFS= read -r line; do
                    caddie cli:indent "$line"
                done < <(grep -E "$error_pattern" "$log_file")
            else
                caddie cli:yellow "No error lines matched the filter"
                caddie cli:thought "Use 'caddie swift:xcode:build:log' for full output"
            fi
        fi
    fi

    if [ -n "$log_file" ]; then
        rm -f "$log_file"
    fi

    return $build_status
}

function caddie_swift_xcode_build() {
    caddie_swift_xcode_build_run "errors" "$@"
    return $?
}

function caddie_swift_xcode_build_log() {
    caddie_swift_xcode_build_run "log" "$@"
    return $?
}

function caddie_swift_xcode_trace_template_candidates() {
    if ! xcrun --find xctrace >/dev/null 2>&1; then
        return 0
    fi

    xcrun xctrace list templates 2>/dev/null | sed -e 's/^[* ]*//' -e '/^==/d' -e '/^$/d' | sort -u
    return 0
}

function caddie_swift_xcode_trace_template_exists() {
    local template="$1"
    if [ -z "$template" ]; then
        return 1
    fi

    if caddie_swift_xcode_trace_template_candidates | grep -Fxq "$template"; then
        return 0
    fi

    return 1
}

function caddie_swift_xcode_trace_template_select() {
    local selection=""
    local template=""
    local -a templates=()

    while IFS= read -r template; do
        [ -n "$template" ] && templates+=("$template")
    done < <(caddie_swift_xcode_trace_template_candidates)

    if [ "${#templates[@]}" -eq 0 ]; then
        caddie cli:red "Error: No xctrace templates found"
        caddie cli:indent "Make sure Xcode is installed"
        return 1
    fi

    caddie cli:title "Select a trace template" >&2
    local i=0
    for template in "${templates[@]}"; do
        caddie cli:indent "${i}) ${template}" >&2
        i=$((i + 1))
    done
    caddie cli:indent "q) Quit" >&2
    caddie cli:blank >&2
    caddie cli:indent "Enter selection:" >&2
    read -r selection

    if [ -z "$selection" ] || [ "$selection" = "q" ]; then
        return 1
    fi

    if ! [[ "$selection" =~ ^[0-9]+$ ]]; then
        caddie cli:red "Error: Invalid selection" >&2
        return 1
    fi

    if [ "$selection" -ge "${#templates[@]}" ]; then
        caddie cli:red "Error: Selection out of range" >&2
        return 1
    fi

    printf '%s\n' "${templates[$selection]}"
    return 0
}

function caddie_swift_xcode_trace_templates() {
    local template=""
    local -a templates=()

    while IFS= read -r template; do
        [ -n "$template" ] && templates+=("$template")
    done < <(caddie_swift_xcode_trace_template_candidates)

    if [ "${#templates[@]}" -eq 0 ]; then
        caddie cli:red "Error: No xctrace templates found"
        caddie cli:indent "Make sure Xcode is installed"
        return 1
    fi

    caddie cli:title "Available Xcode trace templates"
    local i=0
    for template in "${templates[@]}"; do
        caddie cli:indent "${i}) ${template}"
        i=$((i + 1))
    done
    return 0
}

function caddie_swift_terminal_open_tab() {
    local hub_title="$1"
    local hub_command="$2"
    local tab_title="$3"
    local tab_command="$4"

    if [ "$(uname -s)" != "Darwin" ]; then
        return 0
    fi

    if ! command -v osascript >/dev/null 2>&1; then
        return 0
    fi

    osascript - "$hub_title" "$hub_command" "$tab_title" "$tab_command" <<'APPLESCRIPT'
on run argv
    set hubTitle to item 1 of argv
    set hubCommand to item 2 of argv
    set tabTitle to item 3 of argv
    set tabCommand to item 4 of argv

    tell application "Terminal"
        activate
        set hubWindow to my findHubWindow(hubTitle)
        if hubWindow is missing value then
            try
                set hubWindow to (make new window)
            on error
                set hubWindow to front window
            end try
            set hubTab to do script hubCommand in hubWindow
            try
                set custom title of hubTab to hubTitle
            end try
        end if

        set newTab to do script tabCommand in hubWindow
        try
            set custom title of newTab to tabTitle
        end try
    end tell
end run

on findHubWindow(hubTitle)
    tell application "Terminal"
        repeat with w in windows
            repeat with t in tabs of w
                try
                    if custom title of t is hubTitle then return w
                end try
                try
                    if name of t is hubTitle then return w
                end try
            end repeat
        end repeat
    end tell
    return missing value
end findHubWindow
APPLESCRIPT
    return 0
}

function caddie_swift_xcode_play_open_tabs() {
    local app_name="$1"
    local bundle_id="$2"
    local destination="$3"
    local sim_udid="$4"
    local device_udid="$5"
    local trace_template="$6"
    local logs_enabled="$7"
    local logs_all_enabled="$8"

    if [ "$(uname -s)" != "Darwin" ]; then
        caddie cli:yellow "Terminal log/trace tabs are only supported on macOS"
        return 0
    fi

    if ! command -v osascript >/dev/null 2>&1; then
        caddie cli:yellow "osascript not available; skipping log/trace tabs"
        return 0
    fi

    local hub_title="Caddie Swift Hub"
    local hub_command="printf '\\033]1;${hub_title}\\007'; printf '\\033]2;${hub_title}\\007'; echo 'Caddie Swift Logs & Trace Window'; echo 'Use this window for log/trace tabs.'"
    local log_command_base=""
    local tab_title=""
    local tab_command=""
    local predicate=""

    if [ "$destination" = "simulator" ]; then
        if [ -n "$sim_udid" ]; then
            log_command_base="xcrun simctl spawn \"$sim_udid\" log stream"
        else
            log_command_base="xcrun simctl spawn booted log stream"
        fi
    else
        if [ -n "$device_udid" ]; then
            log_command_base="xcrun devicectl device log stream --device \"$device_udid\""
        else
            log_command_base="xcrun devicectl device log stream"
        fi
    fi

    if [ "$logs_enabled" = "true" ]; then
        tab_title="Swift Logs"
        predicate="process == \"$app_name\""
        if [ -n "$bundle_id" ]; then
            predicate="$predicate OR subsystem == \"$bundle_id\""
        fi
        tab_command="printf '\\033]1;${tab_title}\\007'; ${log_command_base} --predicate '$predicate'"
        caddie_swift_terminal_open_tab "$hub_title" "$hub_command" "$tab_title" "$tab_command"
    fi

    if [ "$logs_all_enabled" = "true" ]; then
        tab_title="Swift Logs (All)"
        tab_command="printf '\\033]1;${tab_title}\\007'; ${log_command_base}"
        caddie_swift_terminal_open_tab "$hub_title" "$hub_command" "$tab_title" "$tab_command"
    fi

    if [ -n "$trace_template" ]; then
        if ! xcrun --find xctrace >/dev/null 2>&1; then
            caddie cli:yellow "xctrace not found; skipping trace tab"
            return 0
        fi

        local trace_device="${device_udid:-$sim_udid}"
        if [ -z "$trace_device" ]; then
            trace_device="$app_name"
        fi
        local trace_dir="$HOME/Library/Logs/Caddie/xctrace"
        local trace_stamp=""
        local trace_file=""
        trace_stamp="$(date +%Y%m%d-%H%M%S)"
        trace_file="${trace_dir}/${app_name}-${trace_stamp}.trace"

        tab_title="Swift Trace"
        tab_command="printf '\\033]1;${tab_title}\\007'; mkdir -p \"$trace_dir\"; xcrun xctrace record --template \"$trace_template\" --device \"$trace_device\" --output \"$trace_file\""
        caddie_swift_terminal_open_tab "$hub_title" "$hub_command" "$tab_title" "$tab_command"
    fi

    return 0
}

function caddie_swift_xcode_crash_stream() {
    local app_name="$1"
    local destination="${2:-simulator}"
    local sim_udid="${3:-}"
    local device_udid="${4:-}"

    if [ "$(uname -s)" != "Darwin" ]; then
        caddie cli:yellow "Crash stream is only supported on macOS"
        return 0
    fi

    local hub_title="Caddie Swift Hub"
    local hub_command="printf '\\033]1;${hub_title}\\007'; printf '\\033]2;${hub_title}\\007'; echo 'Caddie Swift Logs & Trace Window'; echo 'Use this window for log/trace tabs.'"
    local log_command_base=""

    if [ "$destination" = "device" ]; then
        if [ -n "$device_udid" ]; then
            log_command_base="xcrun devicectl device log stream --device \"$device_udid\""
        else
            log_command_base="xcrun devicectl device log stream"
        fi
    else
        if [ -n "$sim_udid" ]; then
            log_command_base="xcrun simctl spawn \"$sim_udid\" log stream"
        else
            log_command_base="xcrun simctl spawn booted log stream"
        fi
    fi

    local predicate="subsystem == \"com.apple.crashreporter\" OR process == \"ReportCrash\""
    if [ -n "$app_name" ]; then
        predicate="process == \"$app_name\" OR $predicate"
    fi

    local tab_title="Swift Crash Logs"
    local tab_command="printf '\\033]1;${tab_title}\\007'; ${log_command_base} --predicate '$predicate'"
    caddie_swift_terminal_open_tab "$hub_title" "$hub_command" "$tab_title" "$tab_command"
    return 0
}

function caddie_swift_xcode_crash_stream_all() {
    local destination="${1:-simulator}"
    local sim_udid="${2:-}"
    local device_udid="${3:-}"

    if [ "$(uname -s)" != "Darwin" ]; then
        caddie cli:yellow "Crash stream is only supported on macOS"
        return 0
    fi

    local hub_title="Caddie Swift Hub"
    local hub_command="printf '\\033]1;${hub_title}\\007'; printf '\\033]2;${hub_title}\\007'; echo 'Caddie Swift Logs & Trace Window'; echo 'Use this window for log/trace tabs.'"
    local log_command_base=""

    if [ "$destination" = "device" ]; then
        if [ -n "$device_udid" ]; then
            log_command_base="xcrun devicectl device log stream --device \"$device_udid\""
        else
            log_command_base="xcrun devicectl device log stream"
        fi
    else
        if [ -n "$sim_udid" ]; then
            log_command_base="xcrun simctl spawn \"$sim_udid\" log stream"
        else
            log_command_base="xcrun simctl spawn booted log stream"
        fi
    fi

    local tab_title="Swift Crash Logs (All)"
    local tab_command="printf '\\033]1;${tab_title}\\007'; ${log_command_base}"
    caddie_swift_terminal_open_tab "$hub_title" "$hub_command" "$tab_title" "$tab_command"
    return 0
}

function caddie_swift_xcode_crash_latest() {
    local filter="$1"
    local crash_dir="$HOME/Library/Logs/DiagnosticReports"
    local crash_file=""

    if [ ! -d "$crash_dir" ]; then
        caddie cli:red "Error: Crash report directory not found"
        caddie cli:indent "$crash_dir"
        return 1
    fi

    if [ -n "$filter" ]; then
        crash_file="$(ls -t "$crash_dir"/*"$filter"*.crash 2>/dev/null | head -1)"
    else
        crash_file="$(ls -t "$crash_dir"/*.crash 2>/dev/null | head -1)"
    fi

    if [ -z "$crash_file" ]; then
        caddie cli:yellow "No crash reports found"
        return 1
    fi

    caddie cli:title "Latest crash report"
    caddie cli:indent "Path: $crash_file"
    caddie cli:blank
    sed -n '1,200p' "$crash_file"
    return 0
}

function caddie_swift_xcode_crash_symbolicate() {
    local crash_path="$1"
    local dsym_path="$2"

    if [ -z "$crash_path" ]; then
        caddie cli:red "Error: Provide a crash log path"
        caddie cli:usage "caddie swift:xcode:crash:symbolicate <crash-path> [dSYM-path]"
        return 1
    fi

    if [ ! -f "$crash_path" ]; then
        caddie cli:red "Error: Crash log not found"
        caddie cli:indent "$crash_path"
        return 1
    fi

    local tool=""
    tool="$(xcrun --find symbolicatecrash 2>/dev/null)"
    if [ -z "$tool" ]; then
        caddie cli:red "Error: symbolicatecrash not found"
        caddie cli:indent "Install Xcode and Xcode command line tools"
        return 1
    fi

    if [ -n "$dsym_path" ]; then
        "$tool" -d "$dsym_path" "$crash_path"
        return $?
    fi

    "$tool" "$crash_path"
    return $?
}

function caddie_swift_xcode_clean() {
    caddie_swift_require_xcode_project || return 1
    local scheme="$1"
    caddie_swift_xcode_scene_require "$scheme" || return 1
    scheme=$(caddie_swift_xcode_scheme "$scheme")
    local project_file=$(caddie_swift_xcode_project)

    caddie cli:title "Cleaning Xcode project '$project_file' (scheme: $scheme)..."
    if xcodebuild -project "$project_file" -scheme "$scheme" clean; then
        caddie cli:check "Clean completed"
        return 0
    fi

    caddie cli:red "Clean failed"
    return 1
}

function caddie_swift_xcode_play_run() {
    local logs_enabled="$1"
    local logs_all_enabled="$2"
    local crash_enabled="$3"
    local crash_all_enabled="$4"
    local trace_template="$5"
    shift 5 || true

    caddie_swift_require_xcode_project || return 1
    local first_arg=""
    local scheme=""
    local target=""
    local -a play_args=()

    if [ $# -gt 0 ]; then
        play_args=("$@")
    fi

    if [ "${#play_args[@]}" -gt 0 ]; then
        first_arg="${play_args[0]}"
    fi

    if [ -n "$first_arg" ]; then
        if caddie_swift_xcode_scheme_exists "$first_arg"; then
            scheme="$first_arg"
            target="${play_args[1]:-}"
        else
            target="$first_arg"
        fi
    fi

    caddie_swift_xcode_scene_require "$scheme" || return 1
    scheme=$(caddie_swift_xcode_scheme "$scheme")
    if [ -z "$target" ]; then
        target="${CADDIE_SWIFT_XCODE_TARGET:-}"
    fi
    if [ -z "$target" ]; then
        target="iPhone 16"
    fi

    local sim_udid=""
    local device_udid=""
    local destination=""
    local sdk=""
    local configuration="Debug"

    sim_udid=$(caddie_swift_xcode_simulator_udid "$target")
    if [ -n "$sim_udid" ]; then
        destination="simulator"
        sdk="iphonesimulator"
        configuration="Debug"
    else
        device_udid=$(caddie_swift_xcode_device_udid "$target")
        if [ -z "$device_udid" ]; then
            caddie cli:red "Error: Target '$target' not found as simulator or device"
            caddie cli:thought "Set with: caddie swift:xcode:target:set <name>"
            return 1
        fi
        destination="device"
        sdk="iphoneos"
        configuration="Release"
    fi

    local project_file=$(caddie_swift_xcode_project)
    caddie cli:title "Build and run '$project_file' (scheme: $scheme)"
    caddie cli:indent "Target: $target"

    caddie_swift_xcode_build_run "errors" "$scheme" "$destination" "$target"
    local build_status=$?
    if [ $build_status -ne 0 ]; then
        caddie cli:red "Build failed; skipping run"
        return $build_status
    fi

    local app_info
    app_info=$(caddie_swift_xcode_app_info "$scheme" "$sdk" "$configuration")
    if [ -z "$app_info" ]; then
        caddie cli:red "Error: Unable to resolve app bundle"
        return 1
    fi
    local app_path="${app_info%%|*}"
    local bundle_id="${app_info##*|}"
    if [ -z "$app_path" ] || [ -z "$bundle_id" ]; then
        caddie cli:red "Error: App path or bundle ID missing"
        return 1
    fi
    local app_name=""
    app_name="$(basename "$app_path" .app)"

    if [ "$logs_enabled" = "true" ] || [ "$logs_all_enabled" = "true" ] || [ -n "$trace_template" ]; then
        caddie_swift_xcode_play_open_tabs "$app_name" "$bundle_id" "$destination" "$sim_udid" "$device_udid" "$trace_template" "$logs_enabled" "$logs_all_enabled"
    fi

    if [ "$crash_enabled" = "true" ]; then
        caddie_swift_xcode_crash_stream "$app_name" "$destination" "$sim_udid" "$device_udid"
    fi

    if [ "$crash_all_enabled" = "true" ]; then
        caddie_swift_xcode_crash_stream_all "$destination" "$sim_udid" "$device_udid"
    fi

    if [ "$destination" = "simulator" ]; then
        caddie cli:indent "Launching in simulator..."
        xcrun simctl boot "$sim_udid" >/dev/null 2>&1 || true
        xcrun simctl bootstatus "$sim_udid" -b >/dev/null 2>&1 || true
        if ! xcrun simctl install "$sim_udid" "$app_path"; then
            caddie cli:red "Failed to install app on simulator"
            return 1
        fi
        if xcrun simctl launch "$sim_udid" "$bundle_id"; then
            caddie cli:check "App launched on simulator"
        else
            caddie cli:red "Failed to launch app on simulator"
            return 1
        fi
    else
        if ! command -v xcrun >/dev/null 2>&1; then
            caddie cli:red "Error: xcrun not available"
            return 1
        fi
        if ! xcrun devicectl >/dev/null 2>&1; then
            caddie cli:red "devicectl not available; unable to install/launch on device"
            caddie cli:thought "Open Xcode or install a newer Xcode with devicectl support"
            return 1
        fi
        local device_log=""
        device_log=$(mktemp -t caddie_xcode_play.XXXXXX)
        if [ -z "$device_log" ]; then
            caddie cli:red "Error: Unable to create device log file"
            return 1
        fi
        caddie cli:indent "Installing on device..."
        if ! xcrun devicectl device install app --device "$device_udid" "$app_path" >"$device_log" 2>&1; then
            caddie cli:red "Failed to install app on device"
            caddie cli:indent "Log: $device_log"
            return 1
        fi
        caddie cli:indent "Launching on device..."
        if xcrun devicectl device process launch --device "$device_udid" "$bundle_id" >>"$device_log" 2>&1; then
            caddie cli:check "App launched on device"
            rm -f "$device_log"
        else
            caddie cli:red "Failed to launch app on device"
            caddie cli:indent "Log: $device_log"
            return 1
        fi
    fi

    return 0
}

function caddie_swift_xcode_play() {
    local arg=""
    for arg in "$@"; do
        if [[ "$arg" == --* ]]; then
            caddie cli:red "Error: swift:xcode:play no longer accepts flags"
            caddie cli:thought "Use: caddie swift:xcode:play:logs"
            caddie cli:thought "Use: caddie swift:xcode:play:logs:all"
            caddie cli:thought "Use: caddie swift:xcode:play:crash"
            caddie cli:thought "Use: caddie swift:xcode:play:crash:all"
            caddie cli:thought "Use: caddie swift:xcode:play:trace <template>"
            caddie cli:thought "Use: caddie swift:xcode:play:full [template]"
            return 1
        fi
    done

    caddie_swift_xcode_play_run "false" "false" "false" "false" "" "$@"
    return $?
}

function caddie_swift_xcode_play_logs() {
    caddie_swift_xcode_play_run "true" "false" "false" "false" "" "$@"
    return $?
}

function caddie_swift_xcode_play_logs_all() {
    caddie_swift_xcode_play_run "false" "true" "false" "false" "" "$@"
    return $?
}

function caddie_swift_xcode_play_crash() {
    caddie_swift_xcode_play_run "false" "false" "true" "false" "" "$@"
    return $?
}

function caddie_swift_xcode_play_crash_all() {
    caddie_swift_xcode_play_run "false" "false" "false" "true" "" "$@"
    return $?
}

function caddie_swift_xcode_play_trace() {
    local template=""

    if [ -n "$1" ] && [[ "$1" == --* ]]; then
        caddie cli:red "Error: swift:xcode:play:trace no longer accepts flags"
        caddie cli:usage "caddie swift:xcode:play:trace [template] [scheme] [target]"
        return 1
    fi

    if [ -n "$1" ] && caddie_swift_xcode_trace_template_exists "$1"; then
        template="$1"
        shift || true
    fi

    if [ -z "$template" ]; then
        template="$(caddie_swift_xcode_trace_template_select)" || return 1
    fi

    caddie_swift_xcode_play_run "false" "false" "false" "false" "$template" "$@"
    return $?
}

function caddie_swift_xcode_play_full() {
    local template=""

    if [ -n "$1" ] && [[ "$1" == --* ]]; then
        caddie cli:red "Error: swift:xcode:play:full no longer accepts flags"
        caddie cli:usage "caddie swift:xcode:play:full [template] [scheme] [target]"
        return 1
    fi

    if [ -n "$1" ] && caddie_swift_xcode_trace_template_exists "$1"; then
        template="$1"
        shift || true
    fi

    if [ -z "$template" ]; then
        template="$(caddie_swift_xcode_trace_template_select)" || return 1
    fi

    caddie_swift_xcode_play_run "true" "false" "true" "false" "$template" "$@"
    return $?
}

function caddie_swift_xcode_targets() {
    caddie_swift_require_xcode_project || return 1

    if ! command -v xcrun >/dev/null 2>&1; then
        caddie cli:red "Error: xcrun not available"
        caddie cli:thought "Install Xcode or the command line tools via xcode-select --install"
        return 1
    fi

    local scene="${CADDIE_SWIFT_XCODE_SCENE:-}"
    local target="${CADDIE_SWIFT_XCODE_TARGET:-}"

    caddie cli:title "Xcode Targets"
    if [ -n "$scene" ]; then
        caddie cli:indent "scene: $scene"
    else
        caddie cli:indent "scene: not set"
    fi
    if [ -n "$target" ]; then
        caddie cli:indent "target: $target"
    else
        caddie cli:indent "target: not set"
    fi

    local sim_output=""
    sim_output="$(xcrun simctl list devices available 2>/dev/null || true)"
    if [ -n "$sim_output" ]; then
        caddie cli:blank
        caddie cli:title "Simulators"
        while IFS= read -r line; do
            local trimmed="${line#"${line%%[![:space:]]*}"}"
            [ -n "$trimmed" ] || continue
            if [[ "$trimmed" == "=="* ]]; then
                continue
            fi
            if [[ "$trimmed" == --* ]]; then
                trimmed="${trimmed#-- }"
                trimmed="${trimmed% --}"
                caddie cli:indent "$trimmed"
            else
                caddie cli:indent "  $trimmed"
            fi
        done <<< "$sim_output"
    else
        caddie cli:yellow "No simulators found (simctl unavailable)"
    fi

    local device_output=""
    device_output="$(xcrun xctrace list devices 2>/dev/null || true)"
    if [ -n "$device_output" ]; then
        local devices=""
        devices="$(printf '%s\n' "$device_output" | awk '
            BEGIN { in_devices = 0 }
            /^== Devices ==/ { in_devices = 1; next }
            /^==/ { if (in_devices) exit }
            { if (in_devices && $0 !~ /^[[:space:]]*$/) print }
        ')"
        caddie cli:blank
        if [ -n "$devices" ]; then
            caddie cli:title "Devices"
            while IFS= read -r line; do
                [ -n "$line" ] || continue
                caddie cli:indent "$line"
            done <<< "$devices"
        else
            caddie cli:yellow "No physical devices detected"
        fi
    else
        caddie cli:yellow "xctrace not available; skipping devices list"
    fi

    caddie cli:blank
    caddie cli:thought "Install additional runtimes in Xcode → Settings → Platforms"
    return 0
}

function caddie_swift_xcode_play_watch() {
    caddie_swift_require_xcode_project || return 1
    caddie_swift_xcode_scene_require "" || return 1

    caddie cli:title "Watching for Swift changes"
    caddie cli:indent "Command: caddie swift:xcode:play"
    caddie cli:indent "Filter: *.swift"
    caddie cli:thought "Press Ctrl-C to stop"

    if command -v watchexec >/dev/null 2>&1; then
        caddie cli:indent "Watcher: watchexec"
        watchexec --no-initial --exts swift -- caddie swift:xcode:play
        return $?
    fi

    if command -v fswatch >/dev/null 2>&1; then
        caddie cli:indent "Watcher: fswatch"
        fswatch -o -l 1 -e ".*" -i ".*\\.swift$" . | while read -r _; do
            caddie cli:title "Swift change detected"
            caddie_swift_xcode_play
        done
        return 0
    fi

    if command -v entr >/dev/null 2>&1; then
        caddie cli:indent "Watcher: entr"
        while true; do
            find . -type f -name "*.swift" -print | entr -d caddie swift:xcode:play
            local status=$?
            if [ $status -ne 0 ]; then
                caddie cli:red "entr exited ($status)"
                return $status
            fi
        done
        return 0
    fi

    caddie cli:red "Error: No file watcher found"
    caddie cli:thought "Install watchexec (recommended), fswatch, or entr"
    return 1
}

function caddie_swift_xcode_test_run() {
    local test_scope="$1"
    shift || true
    caddie_swift_require_xcode_project || return 1
    local scheme="$1"
    # Shift consumed arguments
    [ -n "$1" ] && shift || true

    caddie_swift_xcode_scene_require "$scheme" || return 1
    scheme=$(caddie_swift_xcode_scheme "$scheme")
    local project_file=$(caddie_swift_xcode_project)
    local sim_name="${1:-iPhone 16}"
    # Shift simulator name argument so it doesn't get passed to xcodebuild
    [ -n "$1" ] && shift || true

    local -a skip_args=()
    local ui_targets=""
    local ui_status=0
    local log_file=""
    local copy_choice=""
    local error_pattern="error:|fatal error:|xcodebuild: error:|clang: error:|ld: error:"

    if [ "$test_scope" = "unit" ]; then
        caddie cli:title "Running unit tests for '$project_file' (scheme: $scheme)..."
        ui_targets=$(caddie_swift_xcode_ui_test_targets)
        ui_status=$?
        if [ $ui_status -ne 0 ]; then
            caddie cli:red "Unable to detect UI test targets; aborting unit test run"
            return 1
        elif [ -n "$ui_targets" ]; then
            caddie cli:indent "Skipping UI test targets:"
            while IFS= read -r target; do
                [ -n "$target" ] || continue
                caddie cli:indent "  • $target"
                skip_args+=("-skip-testing:$target")
            done <<< "$ui_targets"
        else
            caddie cli:indent "No UI test targets detected"
        fi
    else
        caddie cli:title "Running tests for '$project_file' (scheme: $scheme)..."
    fi

    log_file=$(mktemp -t caddie_xcode_test.XXXXXX)
    if [ -z "$log_file" ]; then
        caddie cli:red "Error: Unable to create test log file"
        return 1
    fi
    if [ "$test_scope" = "unit" ]; then
        export CADDIE_SWIFT_XCODE_TEST_UNIT_LOG="$log_file"
    fi

    local preflight_cmd=()
    local arg
    preflight_cmd=(xcodebuild build-for-testing \
        -project "$project_file" \
        -scheme "$scheme" \
        -sdk iphonesimulator \
        -destination "platform=iOS Simulator,name=$sim_name")
    if [ ${#skip_args[@]} -gt 0 ]; then
        preflight_cmd+=("${skip_args[@]}")
    fi
    if [ $# -gt 0 ]; then
        preflight_cmd+=("$@")
    fi

    {
        printf "%s\n" "Caddie xcodebuild preflight invocation:"
        printf "    "
        for arg in "${preflight_cmd[@]}"; do
            printf "%q " "$arg"
        done
        printf "\n\n"
    } >"$log_file"

    "${preflight_cmd[@]}" >>"$log_file" 2>&1
    local build_status=$?
    if [ $build_status -ne 0 ]; then
        caddie cli:red "Build failed; skipping tests"
        caddie cli:title "Build Errors"
        if grep -E "$error_pattern" "$log_file" >/dev/null 2>&1; then
            while IFS= read -r line; do
                caddie cli:indent "$line"
            done < <(grep -E "$error_pattern" "$log_file")
        else
            caddie cli:yellow "No error lines matched the filter"
            caddie cli:thought "Open the log for full output"
        fi
        caddie cli:indent "Log: $log_file"
        if [ -t 0 ]; then
            caddie cli:indent "Copy log path to clipboard? [Y/n]"
            copy_choice=""
            read -r copy_choice
            if [ -z "$copy_choice" ]; then
                copy_choice="y"
            fi
            case "$copy_choice" in
                y|Y|yes|YES)
                    if command -v pbcopy >/dev/null 2>&1; then
                        printf '%s' "$log_file" | pbcopy
                        caddie cli:check "Log path copied to clipboard"
                    else
                        caddie cli:yellow "Clipboard command not found (pbcopy)"
                    fi
                    ;;
            esac
        fi
        return $build_status
    fi

    local xcode_cmd=()
    xcode_cmd=(xcodebuild test \
        -project "$project_file" \
        -scheme "$scheme" \
        -sdk iphonesimulator \
        -destination "platform=iOS Simulator,name=$sim_name")
    if [ ${#skip_args[@]} -gt 0 ]; then
        xcode_cmd+=("${skip_args[@]}")
    fi
    if [ $# -gt 0 ]; then
        xcode_cmd+=("$@")
    fi

    {
        printf "%s\n" "Caddie xcodebuild invocation:"
        printf "    "
        for arg in "${xcode_cmd[@]}"; do
            printf "%q " "$arg"
        done
        printf "\n\n"
    } >>"$log_file"

    "${xcode_cmd[@]}" >>"$log_file" 2>&1

    local status=$?
    if [ $status -eq 0 ]; then
        if [ "$test_scope" = "unit" ]; then
            caddie cli:check "Unit tests completed successfully"
        else
            caddie cli:check "Tests completed successfully"
        fi
    else
        if [ "$test_scope" = "unit" ]; then
            caddie cli:red "Unit tests failed ($status)"
        else
            caddie cli:red "Tests failed ($status)"
        fi
    fi

    if [ -n "$log_file" ]; then
        caddie cli:indent "Log: $log_file"
        if [ -t 0 ]; then
            caddie cli:indent "Copy log path to clipboard? [Y/n]"
            copy_choice=""
            read -r copy_choice
            if [ -z "$copy_choice" ]; then
                copy_choice="y"
            fi
            case "$copy_choice" in
                y|Y|yes|YES)
                    if command -v pbcopy >/dev/null 2>&1; then
                        printf '%s' "$log_file" | pbcopy
                        caddie cli:check "Log path copied to clipboard"
                    else
                        caddie cli:yellow "Clipboard command not found (pbcopy)"
                    fi
                    ;;
            esac
        fi
        if [ $status -ne 0 ]; then
            caddie cli:thought "Open the log to inspect failures or filter with grep."
        fi
    fi

    return $status
}

function caddie_swift_xcode_test() {
    caddie_swift_xcode_test_run "all" "$@"
    return $?
}

function caddie_swift_xcode_test_unit() {
    caddie_swift_xcode_test_run "unit" "$@"
    return $?
}

function caddie_swift_xcode_test_unit_log_set() {
    local value="$1"
    if [ -z "$value" ]; then
        caddie cli:red "Error: Please provide a log path"
        caddie cli:usage "caddie swift:xcode:test:unit:log:set <path>"
        return 1
    fi
    export CADDIE_SWIFT_XCODE_TEST_UNIT_LOG="$value"
    caddie cli:check "Unit test log set to: $value"
    return 0
}

function caddie_swift_xcode_test_unit_log_get() {
    local value="${CADDIE_SWIFT_XCODE_TEST_UNIT_LOG:-}"
    if [ -n "$value" ]; then
        caddie cli:green "Unit test log: $value"
    else
        caddie cli:yellow "No unit test log is set"
        caddie cli:thought "Use 'caddie swift:xcode:test:unit:log:set <path>' to set it"
    fi
    return 0
}

function caddie_swift_xcode_test_unit_log_unset() {
    if [ -n "${CADDIE_SWIFT_XCODE_TEST_UNIT_LOG:-}" ]; then
        unset CADDIE_SWIFT_XCODE_TEST_UNIT_LOG
        caddie cli:check "Unit test log unset"
    else
        caddie cli:yellow "No unit test log was set"
    fi
    return 0
}

function caddie_swift_xcode_test_unit_failed() {
    caddie_swift_require_xcode_project || return 1
    local scheme="$1"
    [ -n "$1" ] && shift || true

    caddie_swift_xcode_scene_require "$scheme" || return 1
    scheme=$(caddie_swift_xcode_scheme "$scheme")
    local project_file=$(caddie_swift_xcode_project)
    local sim_name="${1:-iPhone 16}"
    [ -n "$1" ] && shift || true

    local log_path="${CADDIE_SWIFT_XCODE_TEST_UNIT_LOG:-}"
    if [ -z "$log_path" ]; then
        caddie cli:red "Error: No unit test log is set"
        caddie cli:usage "caddie swift:xcode:test:unit"
        caddie cli:thought "Or set one: caddie swift:xcode:test:unit:log:set <path>"
        return 1
    fi
    if [ ! -f "$log_path" ]; then
        caddie cli:red "Error: Unit test log not found: $log_path"
        caddie cli:thought "Set a valid path: caddie swift:xcode:test:unit:log:set <path>"
        return 1
    fi

    local failed_tests_raw=""
    local failed_tests=""
    while IFS= read -r line; do
        local raw=""
        raw=$(printf '%s\n' "$line" | sed -E "s/.*Test [Cc]ase '([^']+)' failed.*/\1/")
        if [ -z "$raw" ]; then
            continue
        fi
        if [[ "$raw" == "-["* ]]; then
            raw=${raw#-\[}
            raw=${raw%\]}
            local class_part="${raw% *}"
            local method="${raw#* }"
            raw="${class_part}/${method}"
        fi
        raw=$(printf '%s\n' "$raw" | sed -E 's/\(\)$//')
        if [ -n "$raw" ]; then
            failed_tests_raw+="${raw}"$'\n'
        fi
    done < <(grep -Ei "Test [Cc]ase '.*' failed" "$log_path")

    failed_tests=$(printf '%s' "$failed_tests_raw" | sort -u)
    if [ -z "$failed_tests" ]; then
        caddie cli:check "No failed unit tests found in log"
        return 0
    fi

    local failed_classes=""
    failed_classes=$(printf '%s' "$failed_tests" | awk -F/ '{print $1}' | sort -u)

    local test_target=""
    test_target=$(caddie_swift_xcode_test_bundle "$scheme" 2>/dev/null || true)
    if [ -z "$test_target" ]; then
        test_target=$(grep -E "Test Suite '.*\.xctest'" "$log_path" | head -1 | sed -E "s/.*Test Suite '([^']+)\.xctest'.*/\1/")
    fi
    if [ -z "$test_target" ]; then
        test_target=$(grep -E "Testing target" "$log_path" | head -1 | sed -E "s/.*Testing target ([^ ]+).*/\1/")
    fi
    if [ -z "$test_target" ]; then
        test_target=$(grep -E "Test Suite '[^']+' (started|passed|failed)" "$log_path" | sed -E "s/.*Test Suite '([^']+)'.*/\1/" | grep -v -E "^All tests$" | while IFS= read -r candidate; do
            if ! printf '%s\n' "$failed_classes" | grep -qx "$candidate"; then
                printf '%s\n' "$candidate"
                break
            fi
        done | head -1)
    fi
    if [ -n "$test_target" ]; then
        caddie cli:indent "Using test bundle: $test_target"
    else
        caddie cli:yellow "Test bundle not detected; re-run may fail for test plans"
    fi

    local -a skip_args=()
    local ui_targets=""
    local ui_status=0
    ui_targets=$(caddie_swift_xcode_ui_test_targets)
    ui_status=$?
    if [ $ui_status -ne 0 ]; then
        caddie cli:yellow "Unable to detect UI test targets; continuing without skip list"
    elif [ -n "$ui_targets" ]; then
        while IFS= read -r target; do
            [ -n "$target" ] || continue
            skip_args+=("-skip-testing:$target")
        done <<< "$ui_targets"
    fi
    if [ ${#skip_args[@]} -gt 1 ]; then
        mapfile -t skip_args < <(printf '%s\n' "${skip_args[@]}" | sort -u)
    fi

    local passed=0
    local failed=0
    local total=0
    local test_id=""
    local log_file=""
    local xcode_cmd=()
    local arg=""
    local -a temp_log_files=()

    caddie cli:title "Re-running failed unit tests..."
    while IFS= read -r test_id; do
        [ -n "$test_id" ] || continue
        total=$((total + 1))

        local full_test_id=""
        if [[ "$test_id" == */*/* ]]; then
            full_test_id="$test_id"
        elif [ -n "$test_target" ]; then
            full_test_id="${test_target}/${test_id}"
        else
            full_test_id="$test_id"
        fi

        caddie cli:indent "Running: $full_test_id"

        log_file=$(mktemp -t caddie_xcode_test.XXXXXX)
        if [ -z "$log_file" ]; then
            caddie cli:red "Error: Unable to create test log file"
            failed=$((failed + 1))
            continue
        fi
        temp_log_files+=("$log_file")

        xcode_cmd=(xcodebuild test \
            -project "$project_file" \
            -scheme "$scheme" \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,name=$sim_name" \
            "-only-testing:$full_test_id")
        if [ ${#skip_args[@]} -gt 0 ]; then
            xcode_cmd+=("${skip_args[@]}")
        fi
        if [ $# -gt 0 ]; then
            xcode_cmd+=("$@")
        fi

        {
            printf "%s\n" "Caddie xcodebuild invocation:"
            printf "    "
            for arg in "${xcode_cmd[@]}"; do
                printf "%q " "$arg"
            done
            printf "\n\n"
        } >"$log_file"

        "${xcode_cmd[@]}" >>"$log_file" 2>&1
        local status=$?
        if [ $status -eq 0 ]; then
            caddie cli:check "Passed: $full_test_id"
            passed=$((passed + 1))
        else
            caddie cli:red "Failed: $full_test_id"
            failed=$((failed + 1))
        fi
        caddie cli:indent "Log: $log_file"
    done <<< "$failed_tests"

    caddie cli:blank
    caddie cli:title "Failed test rerun summary"
    caddie cli:indent "Total: $total"
    caddie cli:indent "Passed: $passed"
    caddie cli:indent "Failed: $failed"

    # Clean up temporary log files
    for log_file in "${temp_log_files[@]}"; do
        [ -n "$log_file" ] && rm -f "$log_file"
    done

    if [ $failed -ne 0 ]; then
        return 1
    fi
    return 0
}

function caddie_swift_info() {
    local swift_version="not installed"
    local xcode_version="not installed"
    local scene="${CADDIE_SWIFT_XCODE_SCENE:-}"
    local target="${CADDIE_SWIFT_XCODE_TARGET:-}"

    caddie cli:title "Swift Info"

    if command -v swift >/dev/null 2>&1; then
        swift_version="$(swift --version 2>/dev/null | head -n1 | awk '{print $3}')"
    fi
    if command -v xcodebuild >/dev/null 2>&1; then
        xcode_version="$(xcodebuild -version 2>/dev/null | head -n1 | awk '{print $2}')"
    fi

    caddie cli:indent "swift: $swift_version"
    caddie cli:indent "xcode: $xcode_version"
    if [ -n "$scene" ]; then
        caddie cli:indent "scene: $scene"
    else
        caddie cli:indent "scene: not set"
    fi
    if [ -n "$target" ]; then
        caddie cli:indent "target: $target"
    else
        caddie cli:indent "target: not set"
    fi
    return 0
}

function caddie_swift_help() {
    caddie cli:title "Swift Package Manager Commands"
    caddie cli:usage "caddie swift:<command>"
    caddie cli:blank
    caddie cli:title "Swift Package Manager (Package.swift)"
    caddie cli:indent "info                    Show Swift toolchain info"
    caddie cli:indent "init <name>             Create new Swift package (executable)"
    caddie cli:indent "init:executable <name>  Create executable Swift package"
    caddie cli:indent "init:library <name>     Create library Swift package"
    caddie cli:indent "build [args]              Run swift build"
    caddie cli:indent "run [args]                Run default executable"
    caddie cli:indent "run:tool <target> [--]    Run named executable"
    caddie cli:indent "test [args]               Run swift test"
    caddie cli:indent "test:filter <pattern>     swift test --filter"
    caddie cli:blank
    caddie cli:title "Package Dependencies"
    caddie cli:indent "package:resolve          swift package resolve"
    caddie cli:indent "package:update           swift package update"
    caddie cli:indent "package:clean            Remove build artifacts"
    caddie cli:indent "package:describe         Show dependency graph"
    caddie cli:blank
    caddie cli:title "Xcode Projects (with Swift Packages)"
    caddie cli:indent "xcode:packages:check     Check if packages are added"
    caddie cli:indent "xcode:packages:add <target> <pkg1> <prod1> [...]  Add packages (requires Ruby)"
    caddie cli:indent "xcode:resolve            Resolve package dependencies"
    caddie cli:indent "xcode:build [scheme] [simulator|device] [sim_name]  Build Xcode project (errors only)"
    caddie cli:indent "xcode:build:log [scheme] [simulator|device] [sim_name]  Build with full logs"
    caddie cli:indent "xcode:play [scheme] [target]  Build/run without extra logging"
    caddie cli:indent "xcode:play:logs [scheme] [target]  Build/run with logs tab"
    caddie cli:indent "xcode:play:logs:all [scheme] [target]  Build/run with full logs"
    caddie cli:indent "xcode:play:crash [scheme] [target]  Build/run with crash stream"
    caddie cli:indent "xcode:play:crash:all [scheme] [target]  Build/run with full crash stream"
    caddie cli:indent "xcode:play:trace [template] [scheme] [target]  Build/run with trace tab"
    caddie cli:indent "xcode:play:full [template] [scheme] [target]  Logs + trace + crash stream"
    caddie cli:indent "xcode:play:watch          Watch .swift changes and run xcode:play"
    caddie cli:indent "xcode:targets             List available simulator/device targets"
    caddie cli:indent "xcode:trace:templates     List available trace templates"
    caddie cli:indent "xcode:crash:stream [app]   Stream crash logs in a Terminal tab"
    caddie cli:indent "xcode:crash:stream:all     Stream all device/simulator logs"
    caddie cli:indent "xcode:crash:latest [filter]  Show latest crash report"
    caddie cli:indent "xcode:crash:symbolicate <crash> [dSYM]  Symbolicate a crash log"
    caddie cli:indent "xcode:target:get          Show current Xcode target"
    caddie cli:indent "xcode:target:set <name>   Set Xcode target"
    caddie cli:indent "xcode:target:unset        Clear Xcode target"
    caddie cli:indent "xcode:scene:get           Show current Xcode scene"
    caddie cli:indent "xcode:scene:set <name>    Set Xcode scene (scheme)"
    caddie cli:indent "xcode:scene:unset         Clear Xcode scene"
    caddie cli:indent "Note: xcode build/test/play/clean require a scene unless you pass a scheme"
    caddie cli:indent "xcode:test [scheme] [sim_name]  Run Xcode tests (log to file)"
    caddie cli:indent "xcode:test:unit [scheme] [sim_name]  Run Xcode unit tests (skip UI, log to file)"
    caddie cli:indent "xcode:test:unit:failed [scheme] [sim_name]  Re-run failed unit tests from log"
    caddie cli:indent "xcode:test:unit:log:get       Show last unit test log path"
    caddie cli:indent "xcode:test:unit:log:set <path>  Set last unit test log path"
    caddie cli:indent "xcode:test:unit:log:unset     Clear last unit test log path"
    caddie cli:indent "xcode:clean [scheme]     Clean Xcode build"
    caddie cli:blank
    caddie cli:title "Quality"
    caddie cli:indent "format                  Run swift-format"
    caddie cli:indent "format:lint             Run swift-format lint"
    caddie cli:indent "lint [args]              Run SwiftLint"
    caddie cli:blank
    caddie cli:title "Git"
    caddie cli:indent "gitignore                Write Swift .gitignore"
    return 0
}

function caddie_swift_description() {
    printf '%s\n' 'Swift Package Manager helpers'
    return 0
}

export -f caddie_swift_require_toolchain
export -f caddie_swift_require_package
export -f caddie_swift_init
export -f caddie_swift_init_executable
export -f caddie_swift_init_library
export -f caddie_swift_build
export -f caddie_swift_test
export -f caddie_swift_test_filter
export -f caddie_swift_run
export -f caddie_swift_run_tool
export -f caddie_swift_package_resolve
export -f caddie_swift_package_update
export -f caddie_swift_package_clean
export -f caddie_swift_package_describe
export -f caddie_swift_format
export -f caddie_swift_format_lint
export -f caddie_swift_lint
export -f caddie_swift_gitignore
export -f caddie_swift_require_xcode_project
export -f caddie_swift_xcode_project
export -f caddie_swift_xcode_ui_test_targets
export -f caddie_swift_xcode_scheme
export -f caddie_swift_xcode_test_bundle
export -f caddie_swift_xcode_schemes
export -f caddie_swift_xcode_scheme_exists
export -f caddie_swift_xcode_simulator_udid
export -f caddie_swift_xcode_device_udid
export -f caddie_swift_xcode_app_info
export -f caddie_swift_xcode_scene_set
export -f caddie_swift_xcode_scene_get
export -f caddie_swift_xcode_scene_unset
export -f caddie_swift_xcode_target_set
export -f caddie_swift_xcode_target_get
export -f caddie_swift_xcode_target_unset
export -f caddie_swift_prompt_segment
export -f caddie_swift_xcode_resolve
export -f caddie_swift_xcode_build_run
export -f caddie_swift_xcode_build
export -f caddie_swift_xcode_build_log
export -f caddie_swift_xcode_trace_template_candidates
export -f caddie_swift_xcode_trace_templates
export -f caddie_swift_xcode_play
export -f caddie_swift_xcode_play_logs
export -f caddie_swift_xcode_play_logs_all
export -f caddie_swift_xcode_play_crash
export -f caddie_swift_xcode_play_crash_all
export -f caddie_swift_xcode_play_trace
export -f caddie_swift_xcode_play_full
export -f caddie_swift_xcode_targets
export -f caddie_swift_xcode_play_watch
export -f caddie_swift_xcode_test_run
export -f caddie_swift_xcode_test
export -f caddie_swift_xcode_test_unit
export -f caddie_swift_xcode_test_unit_log_set
export -f caddie_swift_xcode_test_unit_log_get
export -f caddie_swift_xcode_test_unit_log_unset
export -f caddie_swift_xcode_test_unit_failed
export -f caddie_swift_xcode_clean
export -f caddie_swift_xcode_packages_check
export -f caddie_swift_xcode_packages_add
export -f caddie_swift_xcode_crash_stream
export -f caddie_swift_xcode_crash_stream_all
export -f caddie_swift_xcode_crash_latest
export -f caddie_swift_xcode_crash_symbolicate
export -f caddie_swift_info
export -f caddie_swift_help
export -f caddie_swift_description
