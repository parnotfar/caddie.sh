#!/bin/bash

# Caddie.sh - Ruby Environment Management (RVM-based)
# This file provides Ruby development environment management using RVM

# Source CLI module for formatting
source "$HOME/.caddie_modules/.caddie_cli"

function caddie_ruby_description() {
    # caddie:lint:disable
    printf '%s\n' 'Ruby environment management with RVM'
    # caddie:lint:enable
    return 0
}

# Function to show detailed Ruby help
function caddie_ruby_help() {
    caddie cli:title "Ruby Environment Management (RVM-based)"
    caddie cli:blank
    caddie cli:usage "caddie ruby:<command> [args]"
    caddie cli:blank
    caddie cli:title "Environment Management:"
    caddie cli:indent "info                     Show Ruby toolchain info"
    caddie cli:indent "setup                    Setup Ruby development environment with RVM (uses latest stable)"
    caddie cli:indent "install <version>        Install specific Ruby version"
    caddie cli:indent "use <version>            Switch to specific Ruby version"
    caddie cli:indent "list                     List installed Ruby versions"
    caddie cli:indent "current                  Show current Ruby version"
    caddie cli:indent "version                  Show Ruby and RVM version information"
    caddie cli:blank
    caddie cli:title "Version Pinning:"
    caddie cli:indent "pin:set <version>        Pin Ruby version for setup"
    caddie cli:indent "pin:get                  Get pinned Ruby version"
    caddie cli:indent "pin:unset                Unset pinned Ruby version"
    caddie cli:indent "By default, setup installs the latest stable version"
    caddie cli:blank
    caddie cli:title "Gemset Management:"
    caddie cli:indent "gemset:create <name>     Create new gemset"
    caddie cli:indent "gemset:use <name>        Switch to specific gemset"
    caddie cli:indent "gemset:list              List available gemsets"
    caddie cli:indent "gemset:delete <name>     Delete gemset"
    caddie cli:blank
    caddie cli:title "Gem Management:"
    caddie cli:indent "gem:install <gem>        Install Ruby gem"
    caddie cli:indent "gem:uninstall <gem>      Uninstall Ruby gem"
    caddie cli:indent "gem:list                 List installed gems"
    caddie cli:indent "gem:update <gem>         Update Ruby gem"
    caddie cli:indent "gem:outdated             Show outdated gems"
    caddie cli:blank
    caddie cli:title "Project Management:"
    caddie cli:indent "project:init             Initialize Ruby project structure"
    caddie cli:indent "project:test             Run Ruby tests"
    caddie cli:indent "project:build            Build Ruby project"
    caddie cli:indent "project:serve            Serve Ruby web application"
    caddie cli:blank
    caddie cli:title "Bundler Management:"
    caddie cli:indent "bundler:install          Install Bundler dependencies"
    caddie cli:indent "bundler:update           Update Bundler dependencies"
    caddie cli:indent "bundler:exec <command>   Execute command with Bundler"
    caddie cli:blank
    caddie cli:title "Rails Management:"
    caddie cli:indent "rails:new <app_name>     Create new Rails application"
    caddie cli:indent "rails:server             Start Rails server"
    caddie cli:indent "rails:console            Start Rails console"
    caddie cli:indent "rails:generate <type>    Generate Rails component"
    caddie cli:indent "rails:migrate            Run Rails migrations"
    caddie cli:indent "rails:routes             Show Rails routes"
    caddie cli:blank
    caddie cli:title "Examples:"
    caddie cli:indent "caddie ruby:setup"
    caddie cli:indent "caddie ruby:pin:set 3.4.8"
    caddie cli:indent "caddie ruby:install 3.2.2"
    caddie cli:indent "caddie ruby:gemset:create myproject"
    caddie cli:indent "caddie ruby:gem:install rails"
    caddie cli:indent "caddie ruby:rails:new myapp"
    caddie cli:blank
    return 0
}

# Function to setup Ruby development environment
function caddie_ruby_setup() {
    caddie cli:title "Setting up Ruby development environment..."
    
    # Check if RVM is installed
    if ! command -v rvm >/dev/null 2>&1; then
        caddie cli:title "Installing RVM..."
        
        # Try to import GPG keys first to avoid signature verification issues
        caddie cli:indent "Importing GPG keys for RVM verification..."
        if command -v gpg >/dev/null 2>&1; then
            gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB 2>/dev/null || \
            curl -sSL https://rvm.io/mpapis.asc | gpg --import - 2>/dev/null || \
            curl -sSL https://rvm.io/pkuczynski.asc | gpg --import - 2>/dev/null || true
        fi
        
        # Install RVM (with fallback to skip GPG if keys couldn't be imported)
        if curl -sSL https://get.rvm.io | bash -s stable; then
            # Source RVM
            # shellcheck disable=SC1091
            source "$HOME/.rvm/scripts/rvm" 2>/dev/null || true
            
            if command -v rvm >/dev/null 2>&1; then
                caddie cli:check "RVM installed successfully"
            else
                caddie cli:yellow "RVM installed but not immediately available"
                caddie cli:thought "Try: source ~/.rvm/scripts/rvm"
                caddie cli:thought "Or restart your terminal"
                return 1
            fi
        else
            caddie cli:red "Failed to install RVM"
            caddie cli:blank
            caddie cli:title "Manual RVM installation:"
            caddie cli:indent "1. Import GPG keys:"
            caddie cli:indent "   gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB"
            caddie cli:indent "2. Install RVM:"
            caddie cli:indent "   curl -sSL https://get.rvm.io | bash -s stable"
            caddie cli:indent "3. Source RVM:"
            caddie cli:indent "   source ~/.rvm/scripts/rvm"
            caddie cli:indent "4. Retry: caddie ruby:setup"
            return 1
        fi
    else
        caddie cli:check "RVM already installed"
    fi
    
    # Ensure RVM is sourced in this shell session
    if [ -f "$HOME/.rvm/scripts/rvm" ] && ! command -v rvm >/dev/null 2>&1; then
        # shellcheck disable=SC1091
        source "$HOME/.rvm/scripts/rvm" 2>/dev/null || true
    fi
    
    # Note: Ruby build dependencies should be installed via 'make install' or 'make setup-ruby-deps'
    # This includes: openssl@3, readline, libyaml, gmp, autoconf, automake, libtool, pkg-config
    
    # Configure OpenSSL paths for Ruby compilation
    # This is critical for macOS with Homebrew's OpenSSL
    local openssl_prefix=""
    if command -v brew >/dev/null 2>&1; then
        # Try openssl@3 first (preferred), then fallback to openssl
        if brew --prefix openssl@3 >/dev/null 2>&1; then
            openssl_prefix=$(brew --prefix openssl@3)
        elif brew --prefix openssl >/dev/null 2>&1; then
            openssl_prefix=$(brew --prefix openssl)
        fi
        
        if [ -n "$openssl_prefix" ]; then
            caddie cli:indent "Configuring OpenSSL from Homebrew: $openssl_prefix"
            export LDFLAGS="-L${openssl_prefix}/lib ${LDFLAGS:-}"
            export CPPFLAGS="-I${openssl_prefix}/include ${CPPFLAGS:-}"
            export PKG_CONFIG_PATH="${openssl_prefix}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
        else
            caddie cli:yellow "OpenSSL not found via Homebrew - compilation may fail"
            caddie cli:thought "Run: make setup-ruby-deps or: brew install openssl@3"
        fi
    fi
    
    # Determine which Ruby version to install (use getter function instead of direct env var access)
    local ruby_version="${CADDIE_RUBY_VERSION:-}"
    local install_target=""
    
    if [ -n "$ruby_version" ]; then
        # Use pinned version if specified (RVM accepts version with or without ruby- prefix)
        install_target="$ruby_version"
        caddie cli:title "Installing Ruby $ruby_version (pinned via CADDIE_RUBY_VERSION)..."
    else
        # Detect latest stable version
        caddie cli:title "Detecting latest stable Ruby version..."
        
        # Query for latest stable Ruby version
        # RVM's list known shows patterns, not all versions, so we query the actual latest
        local latest_version=""
        if command -v rvm >/dev/null 2>&1; then
            # Update RVM first to get latest version information and patches
            caddie cli:indent "Updating RVM..."
            rvm get stable >/dev/null 2>&1 || rvm get master >/dev/null 2>&1 || true
            
            # Try to get latest version from ruby-lang.org (most reliable source)
            # The downloads page lists versions - we want the first (latest) stable release
            caddie cli:indent "Querying latest Ruby version from ruby-lang.org..."
            local ruby_downloads=$(curl -sSL --max-time 5 https://www.ruby-lang.org/en/downloads/ 2>/dev/null | \
                grep -oE 'ruby-[0-9]+\.[0-9]+\.[0-9]+' | \
                head -1 | \
                sed 's/ruby-//' || echo "")
            
            if [[ "$ruby_downloads" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                latest_version="$ruby_downloads"
            else
                # Fallback: try common recent versions that often have binary builds
                # Prefer versions with better binary support for faster installation
                local recent_versions="3.3.6 3.3.5 3.2.5 3.2.4 3.4.8 3.4.7 3.1.5"
                for version in $recent_versions; do
                    # Check if RVM knows about this version
                    if rvm list known 2>/dev/null | grep -qE "\[ruby-\]${version//./\\.}" || \
                       rvm list known 2>/dev/null | grep -qE "\[ruby-\]${version%%.*}" ; then
                        latest_version="$version"
                        break
                    fi
                done
            fi
        fi
        
        if [ -n "$latest_version" ] && [[ "$latest_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            install_target="$latest_version"
            caddie cli:indent "Latest stable version: $latest_version"
            caddie cli:title "Installing Ruby $latest_version..."
        else
            # Last resort: use RVM's default, but warn user
            caddie cli:title "Installing Ruby (RVM default)..."
            caddie cli:yellow "Could not determine latest version automatically"
            caddie cli:thought "Using RVM's default. To specify a version, use:"
            caddie cli:indent "caddie ruby:pin:set 3.4.8"
            caddie cli:indent "caddie ruby:setup"
            install_target="ruby"
        fi
    fi
    
    # Try to install Ruby (RVM will try binary first, then compile if needed)
    # Build install command with OpenSSL flags if available
    local install_cmd="rvm install \"$install_target\""
    if [ -n "$openssl_prefix" ]; then
        install_cmd="$install_cmd --with-openssl-dir=\"$openssl_prefix\""
        caddie cli:indent "Using OpenSSL from: $openssl_prefix"
    fi
    
    if eval "$install_cmd"; then
        caddie cli:check "Ruby installed successfully"
        # Use the installed version and set as default
        if [ -n "$ruby_version" ]; then
            rvm use "$ruby_version" --default
        elif [[ "$install_target" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            rvm use "$install_target" --default
        else
            rvm use "$install_target" --default
        fi
        caddie cli:check "Ruby set as default"
        caddie cli:indent "Version: $(ruby --version 2>/dev/null || echo 'unknown')"
    else
        caddie cli:red "Failed to install Ruby"
        caddie cli:blank
        caddie cli:title "Troubleshooting Ruby installation:"
        caddie cli:indent "1. Check the build log:"
        caddie cli:indent "   tail -50 ~/.rvm/log/*/make.log"
        caddie cli:blank
        caddie cli:indent "2. Install macOS requirements:"
        caddie cli:indent "   rvm requirements"
        caddie cli:blank
                caddie cli:indent "3. Ensure OpenSSL is installed via Homebrew:"
                caddie cli:indent "   brew install openssl@3"
                caddie cli:blank
                caddie cli:indent "4. Try a slightly older version with better binary support:"
                caddie cli:indent "   caddie ruby:pin:set 3.3.6"
                caddie cli:indent "   caddie ruby:setup"
                caddie cli:blank
                caddie cli:indent "5. Or install all Ruby build dependencies:"
                caddie cli:indent "   make setup-ruby-deps"
        caddie cli:thought "Ruby compilation can fail due to missing system dependencies"
        return 1
    fi
    
    # Install essential gems
    caddie cli:title "Installing essential gems..."
    gem install bundler rails rake rspec pry
    
    caddie cli:check "Ruby development environment setup complete"
    caddie_ruby_version
}

# Function to install specific Ruby version
function caddie_ruby_install() {
    local version="$1"
    
    if [ -z "$version" ]; then
        caddie cli:red "Error: Please provide a Ruby version"
        caddie cli:usage "caddie ruby:install <version>"
        caddie cli:thought "Examples: 3.4.8, 3.3.6, 3.2.2, 3.1.4"
        caddie cli:blank
        caddie cli:thought "To see available versions: rvm list known | grep '^ruby-'"
        return 1
    fi
    
    caddie cli:title "Installing Ruby $version..."
    
    # Configure OpenSSL if available via Homebrew
    local openssl_prefix=""
    if command -v brew >/dev/null 2>&1; then
        if brew --prefix openssl@3 >/dev/null 2>&1; then
            openssl_prefix=$(brew --prefix openssl@3)
        elif brew --prefix openssl >/dev/null 2>&1; then
            openssl_prefix=$(brew --prefix openssl)
        fi
    fi
    
    local install_cmd="rvm install ruby-$version"
    if [ -n "$openssl_prefix" ]; then
        install_cmd="$install_cmd --with-openssl-dir=\"$openssl_prefix\""
        export LDFLAGS="-L${openssl_prefix}/lib ${LDFLAGS:-}"
        export CPPFLAGS="-I${openssl_prefix}/include ${CPPFLAGS:-}"
        export PKG_CONFIG_PATH="${openssl_prefix}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
        caddie cli:indent "Using OpenSSL from: $openssl_prefix"
    fi
    
    if eval "$install_cmd"; then
        caddie cli:check "Ruby $version installed successfully"
        caddie cli:thought "Use 'caddie ruby:use $version' to switch to it"
    else
        caddie cli:x "Failed to install Ruby $version"
        return 1
    fi
}

# Function to switch to specific Ruby version
function caddie_ruby_use() {
    local version="$1"
    
    if [ -z "$version" ]; then
        caddie cli:red "Error: Please provide a Ruby version"
        caddie cli:usage "caddie ruby:use <version>"
        return 1
    fi
    
    caddie cli:title "Switching to Ruby $version..."
    
    if rvm use "ruby-$version"; then
        caddie cli:check "Switched to Ruby $version"
        caddie cli:indent "Current Ruby: $(ruby --version)"
        caddie cli:indent "Current Gem: $(gem --version)"
    else
        caddie cli:x "Failed to switch to Ruby $version"
        return 1
    fi
}

# Function to list installed Ruby versions
function caddie_ruby_list() {
    caddie cli:title "Installed Ruby versions"
    caddie cli:blank
    rvm list
    caddie cli:blank
    caddie cli:indent "Current version: $(ruby --version)"
    return 0
}

# Function to show current Ruby version
function caddie_ruby_current() {
    caddie cli:title "Current Ruby Environment"
    caddie cli:blank
    caddie cli:indent "Ruby: $(ruby --version)"
    caddie cli:indent "Gem: $(gem --version)"
    caddie cli:indent "RVM: $(rvm --version)"
    caddie cli:indent "Gemset: $(rvm gemset name 2>/dev/null || echo 'default')"
    return 0
}

# Function to set pinned Ruby version
function caddie_ruby_pin_set() {
    local version="$1"
    
    if [ -z "$version" ]; then
        caddie cli:red "Error: Please provide a Ruby version"
        caddie cli:usage "caddie ruby:pin:set <version>"
        caddie cli:blank
        caddie cli:title "Example:"
        caddie cli:indent "caddie ruby:pin:set 3.4.8"
        return 1
    fi
    
    export CADDIE_RUBY_VERSION="$version"
    caddie cli:check "Ruby version pin set to: $version"
    caddie cli:thought "Run 'caddie ruby:setup' to install this version"
    return 0
}

# Function to get pinned Ruby version
function caddie_ruby_pin_get() {
    local pinned_version="${CADDIE_RUBY_VERSION:-}"
    
    if [ -n "$pinned_version" ]; then
        caddie cli:green "Pinned Ruby version: $pinned_version"
    else
        caddie cli:yellow "No Ruby version is pinned"
        caddie cli:thought "Use 'caddie ruby:pin:set <version>' to pin a version"
    fi
    return 0
}

# Function to unset pinned Ruby version
function caddie_ruby_pin_unset() {
    if [ -n "${CADDIE_RUBY_VERSION:-}" ]; then
        unset CADDIE_RUBY_VERSION
        caddie cli:check "Ruby version pin unset"
        caddie cli:thought "caddie ruby:setup will now use the latest stable version"
    else
        caddie cli:yellow "No Ruby version was pinned"
    fi
    return 0
}


# Function to create new gemset
function caddie_ruby_gemset_create() {
    local gemset_name="$1"
    
    if [ -z "$gemset_name" ]; then
        caddie cli:red "Error: Please provide a gemset name"
        caddie cli:usage "caddie ruby:gemset:create <name>"
        return 1
    fi
    
    caddie cli:title "Creating gemset '$gemset_name'..."
    
    if rvm gemset create "$gemset_name"; then
        caddie cli:check "Gemset '$gemset_name' created successfully"
        caddie cli:indent "Use 'caddie ruby:gemset:use $gemset_name' to switch to it"
    else
        caddie cli:x "Failed to create gemset '$gemset_name'"
        return 1
    fi
    return 0
}

# Function to switch to specific gemset
function caddie_ruby_gemset_use() {
    local gemset_name="$1"
    
    if [ -z "$gemset_name" ]; then
        caddie cli:red "Error: Please provide a gemset name"
        caddie cli:usage "caddie ruby:gemset:use <name>"
        return 1
    fi
    
    caddie cli:title "Switching to gemset '$gemset_name'..."
    
    if rvm gemset use "$gemset_name"; then
        caddie cli:check "Switched to gemset '$gemset_name'"
        caddie cli:indent "Current gemset: $(rvm gemset name)"
    else
        caddie cli:x "Failed to switch to gemset '$gemset_name'"
        return 1
    fi
    return 0
}

# Function to list available gemsets
function caddie_ruby_gemset_list() {
    caddie cli:title "Available gemsets:"
    caddie cli:blank
    rvm gemset list
    return 0
}

# Function to delete gemset
function caddie_ruby_gemset_delete() {
    local gemset_name="$1"
    
    if [ -z "$gemset_name" ]; then
        caddie cli:red "Error: Please provide a gemset name"
        caddie cli:usage "caddie ruby:gemset:delete <name>"
        return 1
    fi
    
    caddie cli:title "Deleting gemset '$gemset_name'..."
    
    if rvm gemset delete "$gemset_name"; then
        caddie cli:check "Gemset '$gemset_name' deleted successfully"
    else
        caddie cli:x "Failed to delete gemset '$gemset_name'"
        return 1
    fi
    return 0
}

# Function to install Ruby gem
function caddie_ruby_gem_install() {
    local gem_name="$1"
    
    if [ -z "$gem_name" ]; then
        caddie cli:red "Error: Please provide a gem name"
        caddie cli:usage "caddie ruby:gem:install <gem>"
        return 1
    fi
    
    caddie cli:title "Installing gem '$gem_name'..."
    
    if gem install "$gem_name"; then
        caddie cli:check "Gem '$gem_name' installed successfully"
    else
        caddie cli:x "Failed to install gem '$gem_name'"
        return 1
    fi
    return 0
}

# Function to uninstall Ruby gem
function caddie_ruby_gem_uninstall() {
    local gem_name="$1"
    
    if [ -z "$gem_name" ]; then
        caddie cli:red "Error: Please provide a gem name"
        caddie cli:usage "caddie ruby:gem:uninstall <gem>"
        return 1
    fi
    
    caddie cli:title "Uninstalling gem '$gem_name'..."
    
    if gem uninstall "$gem_name"; then
        caddie cli:check "Gem '$gem_name' uninstalled successfully"
    else
        caddie cli:x "Failed to uninstall gem '$gem_name'"
        return 1
    fi
}

# Function to list installed gems
function caddie_ruby_gem_list() {
    caddie cli:title "Installed gems:"
    caddie cli:blank
    gem list
    return 0
}

# Function to update Ruby gem
function caddie_ruby_gem_update() {
    local gem_name="$1"
    
    if [ -z "$gem_name" ]; then
        caddie cli:red "Error: Please provide a gem name"
        caddie cli:usage "caddie ruby:gem:update <gem>"
        return 1
    fi
    
    caddie cli:title "Updating gem '$gem_name'..."
    
    if gem update "$gem_name"; then
        caddie cli:check "Gem '$gem_name' updated successfully"
    else
        caddie cli:x "Failed to update gem '$gem_name'"
        return 1
    fi
    return 0
}

# Function to show outdated gems
function caddie_ruby_gem_outdated() {
    caddie cli:title "Outdated gems:"
    caddie cli:blank
    gem outdated
    return 0
}

# Function to initialize Ruby project structure
function caddie_ruby_project_init() {
    local project_name="$1"
    
    if [ -z "$project_name" ]; then
        project_name="my-ruby-project"
    fi
    
    caddie cli:title "Initializing Ruby project: $project_name"
    
    mkdir -p "$project_name"
    cd "$project_name" || exit
    
    # Create basic project structure
    mkdir -p lib spec bin
    touch "lib/$(echo "$project_name" | tr '-' '_').rb"
    touch spec/spec_helper.rb
    touch "bin/$(echo "$project_name" | tr '-' '_')"
    touch Gemfile
    touch README.md
    touch .gitignore
    
    # Create basic Gemfile
    cat > Gemfile << 'EOF'
source 'https://rubygems.org'

gem 'rake'
gem 'rspec'
gem 'pry'

group :development do
  gem 'rubocop'
  gem 'yard'
end
EOF

    # Create basic .gitignore
    cat > .gitignore << 'EOF'
# Ruby
*.gem
*.rbc
/.config
/coverage/
/InstalledFiles
/pkg/
/spec/reports/
/spec/examples.txt
/test/tmp/
/test/version_tmp/
/tmp/

# Bundler
/.bundle/
/vendor/bundle
/lib/bundler/man/

# RVM
/.ruby-version
/.ruby-gemset

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF

    # Create basic Rakefile
    cat > Rakefile << 'EOF'
require 'rspec/core/rake_task'

RSpec::Core::RakeTask.new(:spec)

task default: :spec
EOF

    caddie cli:check "Ruby project '$project_name' initialized"
    caddie cli:indent "  Created: lib/, spec/, bin/, Gemfile, README.md, .gitignore, Rakefile"
    return 0
}

# Function to run Ruby tests
function caddie_ruby_project_test() {
    if [ ! -f "Gemfile" ]; then
        caddie cli:red "Error: Not in a Ruby project directory (Gemfile not found)"
        return 1
    fi
    
    caddie cli:title "Running Ruby tests..."
    
    if [ -f "Rakefile" ]; then
        bundle exec rake spec
    elif [ -d "spec" ]; then
        bundle exec rspec
    else
        caddie cli:red "No tests found. Create tests in the 'spec' directory"
        return 1
    fi
    return 0
}

# Function to build Ruby project
function caddie_ruby_project_build() {
    if [ ! -f "Gemfile" ]; then
        caddie cli:red "Error: Not in a Ruby project directory (Gemfile not found)"
        return 1
    fi
    
    caddie cli:title "Building Ruby project..."
    
    # Install dependencies
    bundle install
    
    # Run tests
    if [ -d "spec" ]; then
        bundle exec rspec
    fi
    
    caddie cli:check "Ruby project built successfully"
    return 0
}

# Function to serve Ruby web application
function caddie_ruby_project_serve() {
    if [ ! -f "Gemfile" ]; then
        caddie cli:red "Error: Not in a Ruby project directory (Gemfile not found)"
        return 1
    fi
    
    caddie cli:title "Starting Ruby web application..."
    
    # Check if it's a Rails app
    if [ -f "config/application.rb" ]; then
        caddie cli:indent "Detected Rails application"
        bundle exec rails server
    elif [ -f "config.ru" ]; then
        caddie cli:indent "Detected Rack application"
        bundle exec rackup
    elif [ -f "app.rb" ]; then
        caddie cli:indent "Detected Sinatra application"
        bundle exec ruby app.rb
    else
        caddie cli:indent "No web application detected"
        return 1
    fi
    return 0
}

# Function to install Bundler dependencies
function caddie_ruby_bundler_install() {
    if [ ! -f "Gemfile" ]; then
        caddie cli:red "Error: Not in a Ruby project directory (Gemfile not found)"
        return 1
    fi
    
    caddie cli:title "Installing Bundler dependencies..."
    
    if bundle install; then
        caddie cli:check "Dependencies installed successfully"
    else
        caddie cli:red "Failed to install dependencies"
        return 1
    fi
    return 0
}

# Function to update Bundler dependencies
function caddie_ruby_bundler_update() {
    if [ ! -f "Gemfile" ]; then
        caddie cli:red "Error: Not in a Ruby project directory (Gemfile not found)"
        return 1
    fi
    
    caddie cli:title "Updating Bundler dependencies..."
    
    if bundle update; then
        caddie cli:check "Dependencies updated successfully"
    else
        caddie cli:red "Failed to update dependencies"
        return 1
    fi
    return 0
}

# Function to execute command with Bundler
function caddie_ruby_bundler_exec() {
    local command="$1"
    
    if [ -z "$command" ]; then
        caddie cli:red "Error: Please provide a command to execute"
        caddie cli:usage "caddie ruby:bundler:exec <command>"
        return 1
    fi
    
    if [ ! -f "Gemfile" ]; then
        caddie cli:red "Error: Not in a Ruby project directory (Gemfile not found)"
        return 1
    fi
    
    caddie cli:title "Executing with Bundler: $command"
    bundle exec "$command"
    return 0
}

# Function to create new Rails application
function caddie_ruby_rails_new() {
    local app_name="$1"
    
    if [ -z "$app_name" ]; then
        caddie cli:red "Error: Please provide an application name"
        caddie cli:usage "caddie ruby:rails:new <app-name>"
        return 1
    fi
    
    caddie cli:title "Creating new Rails application: $app_name"
    
    # Check if Rails is installed
    if ! gem list rails -i >/dev/null 2>&1; then
        caddie cli:title "Installing Rails..."
        gem install rails
    fi
    
    # Create new Rails app
    
    if rails new "$app_name"; then
        caddie cli:check "Rails application '$app_name' created successfully"
        caddie cli:indent "  Enter directory: cd $app_name"
        caddie cli:indent "  Start server: caddie ruby:rails:server"
    else
        caddie cli:red "Failed to create Rails application"
        return 1
    fi
    return 0
}

# Function to start Rails server
function caddie_ruby_rails_server() {
    if [ ! -f "config/application.rb" ]; then
        caddie cli:red "Error: Not in a Rails application directory"
        return 1
    fi
    
    caddie cli:title "Starting Rails server..."
    bundle exec rails server
    return 0
}

# Function to start Rails console
function caddie_ruby_rails_console() {
    if [ ! -f "config/application.rb" ]; then
        caddie cli:red "Error: Not in a Rails application directory"
        return 1
    fi
    
    caddie cli:title "Starting Rails console..."
    bundle exec rails console
    return 0
}

# Function to generate Rails component
function caddie_ruby_rails_generate() {
    local generator="$1"
    local name="$2"
    
    if [ -z "$generator" ] || [ -z "$name" ]; then
        caddie cli:red "Error: Please provide generator and name"
        caddie cli:usage "caddie ruby:rails:generate <generator> <name>"
        caddie cli:indent "Examples: model User, controller Users, scaffold Post"
        return 1
    fi
    
    if [ ! -f "config/application.rb" ]; then
        caddie cli:red "Error: Not in a Rails application directory"
        return 1
    fi
    
    caddie cli:title "Generating Rails component: $generator $name"
    bundle exec rails generate "$generator" "$name"
    return 0
}

# Function to run Rails migrations
function caddie_ruby_rails_migrate() {
    if [ ! -f "config/application.rb" ]; then
        caddie cli:red "Error: Not in a Rails application directory"
        return 1
    fi
    
    caddie cli:title "Running Rails migrations..."
    bundle exec rails db:migrate
    return 0
}

# Function to show Rails routes
function caddie_ruby_rails_routes() {
    if [ ! -f "config/application.rb" ]; then
        caddie cli:red "Error: Not in a Rails application directory"
        return 1
    fi
    
    caddie cli:title "Rails routes:"
    caddie cli:blank
    bundle exec rails routes
    return 0
}

function caddie_ruby_info() {
    local ruby="not installed"
    local gem="not installed"
    local rvm="not installed"
    local bundler="not installed"
    local rails="not installed"
    local gemset="default"

    caddie cli:title "Ruby Info"

    if command -v ruby >/dev/null 2>&1; then
        ruby="$(ruby --version 2>/dev/null | awk '{print $2}')"
    fi
    if command -v gem >/dev/null 2>&1; then
        gem="$(gem --version 2>/dev/null)"
    fi
    if command -v rvm >/dev/null 2>&1; then
        rvm="$(rvm --version 2>/dev/null | head -n1)"
        gemset="$(rvm gemset name 2>/dev/null || printf 'default')"
    fi
    if command -v bundle >/dev/null 2>&1; then
        bundler="$(bundle --version 2>/dev/null | awk '{print $2}')"
    fi
    if command -v rails >/dev/null 2>&1; then
        rails="$(rails --version 2>/dev/null | awk '{print $2}')"
    fi

    caddie cli:indent "ruby: $ruby"
    caddie cli:indent "gem: $gem"
    caddie cli:indent "rvm: $rvm"
    caddie cli:indent "bundler: $bundler"
    caddie cli:indent "rails: $rails"
    caddie cli:indent "gemset: $gemset"
    return 0
}

# Function to show Ruby and RVM version information
function caddie_ruby_version() {
    caddie cli:title "Ruby Environment Information"
    caddie cli:blank
    caddie cli:indent "Ruby: $(ruby --version)"
    caddie cli:indent "Gem: $(gem --version)"
    caddie cli:indent "RVM: $(rvm --version)"
    caddie cli:indent "Bundler: $(bundle --version 2>/dev/null || echo 'not installed')"
    caddie cli:indent "Rails: $(rails --version 2>/dev/null || echo 'not installed')"
    caddie cli:indent "Current gemset: $(rvm gemset name 2>/dev/null || echo 'default')"
    return 0
}

# Export Ruby functions
export -f caddie_ruby_description
export -f caddie_ruby_setup
export -f caddie_ruby_install
export -f caddie_ruby_use
export -f caddie_ruby_list
export -f caddie_ruby_current
export -f caddie_ruby_gemset_create
export -f caddie_ruby_gemset_use
export -f caddie_ruby_gemset_list
export -f caddie_ruby_gemset_delete
export -f caddie_ruby_gem_install
export -f caddie_ruby_gem_uninstall
export -f caddie_ruby_gem_list
export -f caddie_ruby_gem_update
export -f caddie_ruby_gem_outdated
export -f caddie_ruby_project_init
export -f caddie_ruby_project_test
export -f caddie_ruby_project_build
export -f caddie_ruby_project_serve
export -f caddie_ruby_bundler_install
export -f caddie_ruby_bundler_update
export -f caddie_ruby_bundler_exec
export -f caddie_ruby_rails_new
export -f caddie_ruby_rails_server
export -f caddie_ruby_rails_console
export -f caddie_ruby_rails_generate
export -f caddie_ruby_rails_migrate
export -f caddie_ruby_rails_routes
export -f caddie_ruby_info
export -f caddie_ruby_version
export -f caddie_ruby_pin_set
export -f caddie_ruby_pin_get
export -f caddie_ruby_pin_unset
