#!/bin/bash

# Caddie.sh - JavaScript/Node.js Environment Management (NVM-based)
# This file provides Node.js development environment management using NVM

# Source CLI module for formatting
source "$HOME/.caddie_modules/.caddie_cli"

# Register help information
function caddie_js_description() {
    echo 'JavaScript/Node.js environment management with NVM'
    return 0
}

# Function to setup Node.js development environment
function caddie_js_setup() {
    caddie cli:title "Setting up Node.js development environment..."
    
    # Check if NVM is installed
    if ! command -v nvm >/dev/null 2>&1; then
        caddie cli:title "Installing NVM..."
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
        
        # Source NVM
        export NVM_DIR="$HOME/.nvm"
        # shellcheck disable=SC1091
        [ -s "${NVM_DIR}/nvm.sh" ] && \. "${NVM_DIR}/nvm.sh"
        # shellcheck disable=SC1091
        [ -s "${NVM_DIR}/bash_completion" ] && \. "${NVM_DIR}/bash_completion"
        
        if ! command -v nvm >/dev/null 2>&1; then
            caddie cli:x "Failed to install NVM"
            return 1
        fi
    else
        caddie cli:check "NVM already installed"
    fi
    
    # Install latest LTS Node.js
    caddie cli:title "Installing latest LTS Node.js..."
    
    if nvm install --lts; then
        caddie cli:check "Node.js installed successfully"
        nvm use --lts
        nvm alias default node
        caddie cli:check "Node.js set as default"
    else
        caddie cli:x "Failed to install Node.js"
        return 1
    fi
    
    # Install essential global packages
    caddie cli:title "Installing essential global packages..."
    npm install -g yarn pnpm typescript ts-node nodemon eslint prettier
    
    caddie cli:check "Node.js development environment setup complete"
    caddie_js_version
    return 0
}

# Function to install specific Node.js version
function caddie_js_install() {
    local version="$1"
    
    if [ -z "$version" ]; then
        caddie cli:red "Error: Please provide a Node.js version"
        caddie cli:usage "caddie js:install <version>"
        caddie cli:thought "Examples: 18.17.0, 20.5.0, lts/*"
        return 1
    fi
    
    caddie cli:title "Installing Node.js $version..."
    
    if nvm install "$version"; then
        caddie cli:check "Node.js $version installed successfully"
        caddie cli:thought "Use 'caddie js:use $version' to switch to it"
    else
        caddie cli:x "Failed to install Node.js $version"
        return 1
    fi
    return 0
}

# Function to switch to specific Node.js version
function caddie_js_use() {
    local version="$1"
    
    if [ -z "$version" ]; then
        caddie cli:red "Error: Please provide a Node.js version"
        caddie cli:usage "caddie js:use <version>"
        return 1
    fi
    
    caddie cli:title "Switching to Node.js $version..."
    
    if nvm use "$version"; then
        caddie cli:check "Switched to Node.js $version"
        caddie cli:indent "Current Node.js: $(node --version)"
        caddie cli:indent "Current npm: $(npm --version)"
    else
        caddie cli:x "Failed to switch to Node.js $version"
        return 1
    fi
    return 0
}

# Function to list installed Node.js versions
function caddie_js_list() {
    caddie cli:title "Installed Node.js versions"
    caddie cli:blank
    nvm list
    caddie cli:blank
    caddie cli:indent "Current version: $(node --version)"
    return 0
}



# Function to initialize Node.js project structure
function caddie_js_project_init() {
    local project_name="$1"
    
    if [ -z "$project_name" ]; then
        project_name="my-node-project"
    fi
    
    caddie cli:title "Initializing Node.js project: $project_name"
    
    mkdir -p "$project_name"
    cd "$project_name" || exit
    
    # Initialize npm project
    npm init -y
    
    # Create basic project structure
    mkdir -p src tests docs
    touch src/index.js
    touch tests/index.test.js
    touch README.md
    touch .gitignore
    touch .eslintrc.js
    touch .prettierrc
    
    # Create basic package.json scripts
    node -e "
    const pkg = require('./package.json');
    pkg.scripts = {
        'start': 'node src/index.js',
        'dev': 'nodemon src/index.js',
        'test': 'jest',
        'lint': 'eslint src/',
        'format': 'prettier --write src/',
        'build': 'npm run lint && npm run test'
    };
    fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
    "
    
    # Create basic .gitignore
    cat > .gitignore << 'EOF'
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/
*.lcov

# nyc test coverage
.nyc_output

# Dependency directories
jspm_packages/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Build outputs
dist/
build/

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF

    # Install essential dev dependencies
    npm install --save-dev jest nodemon eslint prettier
    
    caddie cli:check "Node.js project '$project_name' initialized"
    caddie cli:indent "Created: src/, tests/, docs/, package.json, README.md, .gitignore"
    return 0
}

# Function to install project dependencies
function caddie_js_project_install() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Installing project dependencies..."
    
    if [ -f "yarn.lock" ]; then
        yarn install
    elif [ -f "pnpm-lock.yaml" ]; then
        pnpm install
    else
        npm install
    fi
    
    if [ $? -eq 0 ]; then
        caddie cli:check "Dependencies installed successfully"
    else
        caddie cli:x "Failed to install dependencies"
        return 1
    fi
    return 0
}

# Function to update project dependencies
function caddie_js_project_update() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Updating project dependencies..."
    
    if [ -f "yarn.lock" ]; then
        yarn upgrade
    elif [ -f "pnpm-lock.yaml" ]; then
        pnpm update
    else
        npm update
    fi
    
    if [ $? -eq 0 ]; then
        caddie cli:check "Dependencies updated successfully"
    else
        caddie cli:x "Failed to update dependencies"
        return 1
    fi
    return 0
}

# Function to run Node.js tests
function caddie_js_project_test() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Running Node.js tests..."
    
    if [ -f "package.json" ] && grep -q '"test"' package.json; then
        npm test
    elif [ -d "tests" ]; then
        npx jest
    else
        caddie cli:warning "No tests found. Create tests in the 'tests' directory"
        return 1
    fi
    return 0
}

# Function to build Node.js project
function caddie_js_project_build() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Building Node.js project..."
    
    # Install dependencies
    caddie_js_project_install
    
    # Run tests
    if [ -d "tests" ]; then
        caddie_js_project_test
    fi
    
    # Run linting
    if grep -q '"lint"' package.json; then
        npm run lint
    fi
    
    caddie cli:check "Node.js project built successfully"
    return 0
}

# Function to serve Node.js application
function caddie_js_project_serve() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Starting Node.js application..."
    
    # Check for start script
    if grep -q '"start"' package.json; then
        npm start
    elif grep -q '"dev"' package.json; then
        npm run dev
    elif [ -f "src/index.js" ]; then
        node src/index.js
    else
        caddie cli:warning "No start script found. Add 'start' or 'dev' script to package.json"
        return 1
    fi
    return 0
}

# Function to install npm package
function caddie_js_package_install() {
    local package="$1"
    
    if [ -z "$package" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie js:package:install <package>"
        return 1
    fi
    
    caddie cli:title "Installing package '$package'..."
    
    if npm install "$package"; then
        caddie cli:check "Package '$package' installed successfully"
    else
        caddie cli:x "Failed to install package '$package'"
        return 1
    fi
    return 0
}

# Function to uninstall npm package
function caddie_js_package_uninstall() {
    local package="$1"
    
    if [ -z "$package" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie js:package:uninstall <package>"
        return 1
    fi
    
    caddie cli:title "Uninstalling package '$package'..."
    
    if npm uninstall "$package"; then
        caddie cli:check "Package '$package' uninstalled successfully"
    else
        caddie cli:x "Failed to uninstall package '$package'"
        return 1
    fi
    return 0
}

# Function to list installed packages
function caddie_js_package_list() {
    caddie cli:title "Installed packages"
    caddie cli:blank
    npm list --depth=0
    return 0
}

# Function to update npm package
function caddie_js_package_update() {
    local package="$1"
    
    if [ -z "$package" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie js:package:update <package>"
        return 1
    fi
    
    caddie cli:title "Updating package '$package'..."
    
    if npm update "$package"; then
        caddie cli:check "Package '$package' updated successfully"
    else
        caddie cli:x "Failed to update package '$package'"
        return 1
    fi
}

# Function to show outdated packages
function caddie_js_package_outdated() {
    caddie cli:title "Outdated packages"
    caddie cli:blank
    npm outdated
    return 0
}

# Function to audit package security
function caddie_js_package_audit() {
    caddie cli:title "Auditing package security..."
    npm audit
    return 0
}

# Function to run npm script
function caddie_js_package_run() {
    local script="$1"
    
    if [ -z "$script" ]; then
        caddie cli:red "Error: Please provide a script name"
        caddie cli:usage "caddie js:package:run <script>"
        return 1
    fi
    
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Running script: $script"
    npm run "$script"
    return 0
}

# Function to publish npm package
function caddie_js_package_publish() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Publishing npm package..."
    
    # Check if logged in
    if ! npm whoami >/dev/null 2>&1; then
        caddie cli:red "Error: Not logged in to npm"
        caddie cli:thought "Run 'npm login' first"
        return 1
    fi
    
    
    if npm publish; then
        caddie cli:check "Package published successfully"
    else
        caddie cli:x "Failed to publish package"
        return 1
    fi
    return 0
}

# Function to create framework project
function caddie_js_framework_create() {
    local framework="$1"
    local project_name="$2"
    
    if [ -z "$framework" ] || [ -z "$project_name" ]; then
        caddie cli:red "Error: Please provide framework and project name"
        caddie cli:usage "caddie js:framework:create <framework> <name>"
        caddie cli:thought "Frameworks: react, vue, angular, express, next, nuxt"
        return 1
    fi
    
    caddie cli:title "Creating $framework project: $project_name"
    
    case "$framework" in
        "react")
            if npx create-react-app "$project_name"; then
                caddie cli:check "$framework project '$project_name' created successfully"
                caddie cli:indent "Enter directory: cd $project_name"
                caddie cli:indent "Start development: caddie js:framework:serve"
            else
                caddie cli:x "Failed to create $framework project"
                return 1
            fi
            ;;
        "vue")
            if npx @vue/cli create "$project_name"; then
                caddie cli:check "$framework project '$project_name' created successfully"
                caddie cli:indent "Enter directory: cd $project_name"
                caddie cli:indent "Start development: caddie js:framework:serve"
            else
                caddie cli:x "Failed to create $framework project"
                return 1
            fi
            ;;
        "angular")
            if npx @angular/cli new "$project_name"; then
                caddie cli:check "$framework project '$project_name' created successfully"
                caddie cli:indent "Enter directory: cd $project_name"
                caddie cli:indent "Start development: caddie js:framework:serve"
            else
                caddie cli:x "Failed to create $framework project"
                return 1
            fi
            ;;
        "express")
            if npx express-generator "$project_name"; then
                caddie cli:check "$framework project '$project_name' created successfully"
                caddie cli:indent "Enter directory: cd $project_name"
                caddie cli:indent "Start development: caddie js:framework:serve"
            else
                caddie cli:x "Failed to create $framework project"
                return 1
            fi
            ;;
        "next")
            if npx create-next-app "$project_name"; then
                caddie cli:check "$framework project '$project_name' created successfully"
                caddie cli:indent "Enter directory: cd $project_name"
                caddie cli:indent "Start development: caddie js:framework:serve"
            else
                caddie cli:x "Failed to create $framework project"
                return 1
            fi
            ;;
        "nuxt")
            if npx create-nuxt-app "$project_name"; then
                caddie cli:check "$framework project '$project_name' created successfully"
                caddie cli:indent "Enter directory: cd $project_name"
                caddie cli:indent "Start development: caddie js:framework:serve"
            else
                caddie cli:x "Failed to create $framework project"
                return 1
            fi
            ;;
        *)
            caddie cli:red "Error: Unknown framework '$framework'"
            return 1
            ;;
    esac
}

# Function to serve framework application
function caddie_js_framework_serve() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Starting framework application..."
    
    # Check for common framework scripts
    if grep -q '"dev"' package.json; then
        npm run dev
    elif grep -q '"start"' package.json; then
        npm start
    elif grep -q '"serve"' package.json; then
        npm run serve
    else
        caddie cli:warning "No development script found. Check package.json for available scripts"
        return 1
    fi
    return 0
}

# Function to build framework application
function caddie_js_framework_build() {
    if [ ! -f "package.json" ]; then
        caddie cli:red "Error: Not in a Node.js project directory (package.json not found)"
        return 1
    fi
    
    caddie cli:title "Building framework application..."
    
    # Check for build script
    if grep -q '"build"' package.json; then
        npm run build
    else
        caddie cli:warning "No build script found. Add 'build' script to package.json"
        return 1
    fi
    return 0
}

# Function to show Node.js and NVM version information
function caddie_js_version() {
    caddie cli:title "Node.js Environment Information"
    caddie cli:blank
    caddie cli:indent "Node.js: $(node --version)"
    caddie cli:indent "npm: $(npm --version)"
    caddie cli:indent "NVM: $(nvm --version)"
    caddie cli:indent "Yarn: $(yarn --version 2>/dev/null || echo 'not installed')"
    caddie cli:indent "pnpm: $(pnpm --version 2>/dev/null || echo 'not installed')"
    caddie cli:indent "TypeScript: $(tsc --version 2>/dev/null || echo 'not installed')"
    return 0
}

# Function to show JavaScript module help
function caddie_js_help() {
    caddie cli:title "JavaScript Module Help"
    caddie cli:blank
    caddie cli:title "Setup and Installation:"
    caddie cli:indent "setup                    - Install Node.js and NVM"
    caddie cli:indent "install                  - Install additional tools (Yarn, pnpm, TypeScript)"
    caddie cli:indent "use <version>            - Switch to specific Node.js version"
    caddie cli:indent "list                     - List installed Node.js versions"
    caddie cli:indent "version                  - Show current environment information"
    caddie cli:blank
    caddie cli:title "Project Management:"
    caddie cli:indent "project:init [name]      - Initialize new Node.js project"
    caddie cli:indent "project:install          - Install project dependencies"
    caddie cli:indent "project:update           - Update project dependencies"
    caddie cli:indent "project:test             - Run project tests"
    caddie cli:indent "project:build            - Build project"
    caddie cli:indent "project:serve            - Serve project"
    caddie cli:blank
    caddie cli:title "Package Management:"
    caddie cli:indent "package:install <pkg>    - Install package globally or locally"
    caddie cli:indent "package:uninstall <pkg>  - Uninstall package"
    caddie cli:indent "package:list             - List installed packages"
    caddie cli:indent "package:update           - Update packages"
    caddie cli:indent "package:outdated         - Check for outdated packages"
    caddie cli:indent "package:audit            - Security audit"
    caddie cli:indent "package:run <script>     - Run npm script"
    caddie cli:indent "package:publish          - Publish package to npm"
    caddie cli:blank
    caddie cli:title "Framework Support:"
    caddie cli:indent "framework:create <type> <name>  - Create framework project (react, vue, angular, next, nuxt)"
    caddie cli:indent "framework:serve          - Serve framework application"
    caddie cli:indent "framework:build          - Build framework application"
    caddie cli:blank
    caddie cli:title "Examples:"
    caddie cli:indent "caddie js:setup"
    caddie cli:indent "caddie js:use 18.17.0"
    caddie cli:indent "caddie js:project:init my-app"
    caddie cli:indent "caddie js:framework:create react my-react-app"
    caddie cli:blank
    return 0
}

# Export JavaScript functions
export -f caddie_js_description
export -f caddie_js_setup
export -f caddie_js_install
export -f caddie_js_use
export -f caddie_js_list
export -f caddie_js_help
export -f caddie_js_project_init
export -f caddie_js_project_install
export -f caddie_js_project_update
export -f caddie_js_project_test
export -f caddie_js_project_build
export -f caddie_js_project_serve
export -f caddie_js_package_install
export -f caddie_js_package_uninstall
export -f caddie_js_package_list
export -f caddie_js_package_update
export -f caddie_js_package_outdated
export -f caddie_js_package_audit
export -f caddie_js_package_run
export -f caddie_js_package_publish
export -f caddie_js_framework_create
export -f caddie_js_framework_serve
export -f caddie_js_framework_build
export -f caddie_js_version