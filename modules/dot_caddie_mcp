#!/usr/bin/env bash

# Caddie.sh - MCP Server Shortcuts
# This file contains MCP server helper functions

# Source CLI module for formatting
source "$HOME/.caddie_modules/.caddie_cli"

function caddie_mcp_find_repo_root() {
    local dir="$PWD"

    while [ -n "$dir" ] && [ "$dir" != "/" ]; do
        if [ -d "$dir/platform/mcp-server-rust" ]; then
            printf '%s\n' "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done

    return 1
}

function caddie_mcp_resolve_dir() {
    local repo_root=""

    repo_root="$(caddie_mcp_find_repo_root)"
    if [ -z "$repo_root" ]; then
        caddie cli:red "Error: Could not locate platform/mcp-server-rust"
        caddie cli:indent "Run this command from the repo root or any subdirectory."
        return 1
    fi

    printf '%s\n' "$repo_root/platform/mcp-server-rust"
    return 0
}

function caddie_mcp_run() {
    local mcp_dir=""

    mcp_dir="$(caddie_mcp_resolve_dir)" || return 1
    caddie cli:title "MCP server run"

    if ! (cd "$mcp_dir" && caddie rust:run); then
        caddie cli:red "Error: MCP server run failed"
        return 1
    fi

    return 0
}

function caddie_mcp_test() {
    local mcp_dir=""

    mcp_dir="$(caddie_mcp_resolve_dir)" || return 1
    caddie cli:title "MCP server tests"

    if ! (cd "$mcp_dir" && caddie rust:test:all); then
        caddie cli:red "Error: MCP server tests failed"
        return 1
    fi

    return 0
}

function caddie_mcp_build() {
    local mcp_dir=""

    mcp_dir="$(caddie_mcp_resolve_dir)" || return 1
    caddie cli:title "MCP server build"

    if ! (cd "$mcp_dir" && caddie rust:build); then
        caddie cli:red "Error: MCP server build failed"
        return 1
    fi

    return 0
}

function caddie_mcp_help() {
    caddie cli:title "MCP Server Shortcuts"
    caddie cli:blank
    caddie cli:usage "caddie mcp:<command>"
    caddie cli:blank
    caddie cli:indent "mcp:run            Run the MCP server (platform/mcp-server-rust)"
    caddie cli:indent "mcp:test           Run MCP server tests"
    caddie cli:indent "mcp:build          Build the MCP server"
    caddie cli:blank
    caddie cli:indent "Commands resolve platform/mcp-server-rust from the repo root"
    caddie cli:indent "and can be run from any subdirectory."
    caddie cli:blank
    caddie cli:title "Examples"
    caddie cli:indent "caddie mcp:run"
    caddie cli:indent "caddie mcp:test"
    caddie cli:indent "caddie mcp:build"
    return 0
}

function caddie_mcp_description() {
    printf '%s\n' 'MCP server shortcuts for platform/mcp-server-rust'
    return 0
}

function caddie_mcp_commands() {
    printf '%s\n' "mcp:run mcp:test mcp:build"
    return 0
}

export -f caddie_mcp_run
export -f caddie_mcp_test
export -f caddie_mcp_build
export -f caddie_mcp_help
export -f caddie_mcp_description
export -f caddie_mcp_commands
