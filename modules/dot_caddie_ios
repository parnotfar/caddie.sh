#!/bin/bash

# Caddie.sh - iOS Development
# This file contains all iOS-related functions

source "$HOME/.caddie_modules/.caddie_cli"

# Function to setup iOS development environment
function caddie_ios_setup() {
    caddie cli:title "Setting up iOS development environment..."
    
    # Check for Xcode
    if ! command -v xcodebuild >/dev/null 2>&1; then
        caddie cli:x "Xcode not found. Please install Xcode from the App Store"
        return 1
    fi
    
    # Check for Swift
    if ! command -v swift >/dev/null 2>&1; then
        caddie cli:x "Swift not found. Please install Xcode command line tools"
        caddie cli:thought "Run: xcode-select --install"
        return 1
    fi
    
    # Check for CocoaPods
    if ! command -v pod >/dev/null 2>&1; then
        caddie cli:title "Installing CocoaPods..."
        sudo gem install cocoapods
        caddie cli:check "CocoaPods installed successfully"
    fi
    
    caddie cli:check "iOS development environment setup complete"
    caddie cli:indent "Xcode: $(xcodebuild -version | head -n1)"
    caddie cli:indent "Swift: $(swift --version | head -n1)"
    caddie cli:indent "CocoaPods: $(pod --version)"
    return 0
}

# Function to list available simulators
function caddie_ios_simulator() {
    caddie cli:title "Available iOS Simulators"
    caddie cli:blank
    xcrun simctl list devices
    return 0
}

# Function to list connected devices
function caddie_ios_device() {
    caddie cli:title "Connected iOS Devices"
    caddie cli:blank
    xcrun devicectl list devices
    return 0
}

# Function to build iOS project
function caddie_ios_build() {
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    caddie cli:title "Building iOS project..."
    
    # Determine project type
    if [ -f ./*.xcworkspace ]; then
        caddie cli:indent "Building workspace..."
        xcodebuild -workspace ./*.xcworkspace -scheme * -configuration Debug build
    else
        caddie cli:indent "Building project..."
        xcodebuild -project ./*.xcodeproj -scheme * -configuration Debug build
    fi
    
    caddie cli:check "iOS project built successfully"
    return 0
}

# Function to run iOS project
function caddie_ios_run() {
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    caddie cli:title "Running iOS project..."
    
    # Get the first available simulator
    local simulator=$(xcrun simctl list devices | grep "iPhone" | head -n1 | sed 's/.*(\([^)]*\)).*/\1/')
    
    if [ -z "$simulator" ]; then
        caddie cli:red "Error: No iOS simulator found"
        return 1
    fi
    
    caddie cli:indent "Using simulator: $simulator"
    
    # Determine project type and run
    if [ -f ./*.xcworkspace ]; then
        xcodebuild -workspace ./*.xcworkspace -scheme * -destination "platform=iOS Simulator,name=$simulator" build
    else
        xcodebuild -project ./*.xcodeproj -scheme * -destination "platform=iOS Simulator,name=$simulator" build
    fi
    
    caddie cli:check "iOS project ran successfully on simulator"
    return 0
}

# Function to run iOS tests
function caddie_ios_test() {
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    caddie cli:title "Running iOS tests..."
    
    # Get the first available simulator
    local simulator=$(xcrun simctl list devices | grep "iPhone" | head -n1 | sed 's/.*(\([^)]*\)).*/\1/')
    
    if [ -z "$simulator" ]; then
        caddie cli:red "Error: No iOS simulator found"
        return 1
    fi
    
    caddie cli:indent "Using simulator: $simulator"
    
    # Determine project type and test
    if [ -f ./*.xcworkspace ]; then
        xcodebuild -workspace ./*.xcworkspace -scheme * -destination "platform=iOS Simulator,name=$simulator" test
    else
        xcodebuild -project ./*.xcodeproj -scheme * -destination "platform=iOS Simulator,name=$simulator" test
    fi
    
    if xcodebuild -workspace ./*.xcworkspace -scheme * -destination "platform=iOS Simulator,name=$simulator" test; then
        caddie cli:check "iOS tests completed successfully"
    else
        caddie cli:x "Some iOS tests failed"
        return 1
    fi
    return 0
}

# Function to create iOS archive
function caddie_ios_archive() {
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    caddie cli:title "Creating iOS archive..."
    
    # Create archive directory
    mkdir -p build/archive
    
    # Determine project type and archive
    if [ -f ./*.xcworkspace ]; then
        xcodebuild -workspace ./*.xcworkspace -scheme * -configuration Release -archivePath build/archive/App.xcarchive archive
    else
        xcodebuild -project ./*.xcodeproj -scheme * -configuration Release -archivePath build/archive/App.xcarchive archive
    fi
    
    caddie cli:check "iOS archive created successfully"
    caddie cli:indent "Location: build/archive/App.xcarchive"
    return 0
}

# Function to clean iOS build artifacts
function caddie_ios_clean() {
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    caddie cli:title "Cleaning iOS build artifacts..."
    
    # Determine project type and clean
    if [ -f ./*.xcworkspace ]; then
        xcodebuild -workspace ./*.xcworkspace -scheme * clean
    else
        xcodebuild -project ./*.xcodeproj -scheme * clean
    fi
    
    # Remove build directory
    rm -rf build/
    
    caddie cli:check "iOS build artifacts cleaned"
    return 0
}

# Function to install CocoaPods dependencies
function caddie_ios_pod_install() {
    if [ ! -f "Podfile" ]; then
        caddie cli:red "Error: Podfile not found in current directory"
        return 1
    fi
    
    caddie cli:title "Installing CocoaPods dependencies..."
    pod install
    
    caddie cli:check "CocoaPods dependencies installed successfully"
    caddie cli:thought "Use the .xcworkspace file to open the project"
    return 0
}

# Function to update CocoaPods dependencies
function caddie_ios_pod_update() {
    if [ ! -f "Podfile" ]; then
        caddie cli:red "Error: Podfile not found in current directory"
        return 1
    fi
    
    caddie cli:title "Updating CocoaPods dependencies..."
    pod update
    
    caddie cli:check "CocoaPods dependencies updated successfully"
    return 0
}

# Function to show Swift version
function caddie_ios_swift_version() {
    if command -v swift >/dev/null 2>&1; then
        caddie cli:title "Swift Version"
        caddie cli:blank
        swift --version
    else
        caddie cli:x "Swift not found. Please install Xcode command line tools"
        caddie cli:thought "Run: xcode-select --install"
        return 1
    fi
    return 0
}

# Function to show Xcode version
function caddie_ios_xcode_version() {
    if command -v xcodebuild >/dev/null 2>&1; then
        caddie cli:title "Xcode Version"
        caddie cli:blank
        xcodebuild -version
    else
        caddie cli:x "Xcode not found. Please install Xcode from the App Store"
        return 1
    fi
    return 0
}

# iOS Configuration Management
CADDIE_IOS_CONFIG_FILE="$HOME/.caddie_ios_config"

# Function to load iOS configuration
function _caddie_ios_load_config() {
    if [ -f "$CADDIE_IOS_CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CADDIE_IOS_CONFIG_FILE"
    fi
}

# Function to save iOS configuration
function _caddie_ios_save_config() {
    {
        echo "# Caddie iOS Configuration"
        echo "# This file is automatically generated. Do not edit manually."
        echo ""
        [ -n "${CADDIE_IOS_APPLE_ID:-}" ] && echo "CADDIE_IOS_APPLE_ID='${CADDIE_IOS_APPLE_ID}'"
        [ -n "${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}" ] && echo "CADDIE_IOS_APP_SPECIFIC_PASSWORD='${CADDIE_IOS_APP_SPECIFIC_PASSWORD}'"
        [ -n "${CADDIE_IOS_APPLE_PASSWORD:-}" ] && echo "CADDIE_IOS_APPLE_PASSWORD='${CADDIE_IOS_APPLE_PASSWORD}'"
        [ -n "${CADDIE_IOS_BUNDLE_ID:-}" ] && echo "CADDIE_IOS_BUNDLE_ID='${CADDIE_IOS_BUNDLE_ID}'"
        [ -n "${CADDIE_IOS_VERSION:-}" ] && echo "CADDIE_IOS_VERSION='${CADDIE_IOS_VERSION}'"
        [ -n "${CADDIE_IOS_BUILD:-}" ] && echo "CADDIE_IOS_BUILD='${CADDIE_IOS_BUILD}'"
        [ -n "${CADDIE_IOS_TEAM_ID:-}" ] && echo "CADDIE_IOS_TEAM_ID='${CADDIE_IOS_TEAM_ID}'"
        [ -n "${CADDIE_IOS_SCHEME:-}" ] && echo "CADDIE_IOS_SCHEME='${CADDIE_IOS_SCHEME}'"
    } > "$CADDIE_IOS_CONFIG_FILE"
}

# Function to get iOS configuration value
function caddie_ios_config_get() {
    _caddie_ios_load_config
    
    local key="$1"
    
    if [ -z "$key" ]; then
        caddie cli:title "iOS Configuration"
        caddie cli:blank
        caddie cli:indent "apple-id:        ${CADDIE_IOS_APPLE_ID:-<not set>}"
        caddie cli:indent "password:        ${CADDIE_IOS_APP_SPECIFIC_PASSWORD:+<set>}${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-<not set>}"
        caddie cli:indent "bundle-id:       ${CADDIE_IOS_BUNDLE_ID:-<not set>}"
        caddie cli:indent "version:         ${CADDIE_IOS_VERSION:-<not set>}"
        caddie cli:indent "build:           ${CADDIE_IOS_BUILD:-<not set>}"
        caddie cli:indent "team-id:         ${CADDIE_IOS_TEAM_ID:-<not set>}"
        caddie cli:indent "scheme:          ${CADDIE_IOS_SCHEME:-<not set>}"
        caddie cli:blank
        caddie cli:thought "Use 'caddie ios:config:get <key>' to get a specific value"
        caddie cli:thought "Use 'caddie ios:config:set <key> <value>' to set a value"
        return 0
    fi
    
    # Normalize key name
    case "$key" in
        apple-id|apple_id|APPLE_ID)
            key="apple-id"
            local value="${CADDIE_IOS_APPLE_ID:-}"
            ;;
        password|app-specific-password|app_specific_password|APP_SPECIFIC_PASSWORD)
            key="password"
            local value="${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}"
            ;;
        bundle-id|bundle_id|BUNDLE_ID)
            key="bundle-id"
            local value="${CADDIE_IOS_BUNDLE_ID:-}"
            ;;
        version|VERSION)
            key="version"
            local value="${CADDIE_IOS_VERSION:-}"
            ;;
        build|BUILD)
            key="build"
            local value="${CADDIE_IOS_BUILD:-}"
            ;;
        team-id|team_id|TEAM_ID)
            key="team-id"
            local value="${CADDIE_IOS_TEAM_ID:-}"
            ;;
        scheme|SCHEME)
            key="scheme"
            local value="${CADDIE_IOS_SCHEME:-}"
            ;;
        *)
            caddie cli:red "Error: Unknown configuration key '$key'"
            caddie cli:blank
            caddie cli:title "Available keys:"
            caddie cli:indent "apple-id, password, bundle-id, version, build, team-id, scheme"
            return 1
            ;;
    esac
    
    if [ -z "$value" ]; then
        caddie cli:yellow "$key: <not set>"
        return 1
    else
        if [ "$key" = "password" ]; then
            caddie cli:green "$key: <set>"
        else
            caddie cli:green "$key: $value"
        fi
        return 0
    fi
}

# Function to set iOS configuration value
function caddie_ios_config_set() {
    _caddie_ios_load_config
    
    local key="$1"
    local value="$2"
    
    if [ -z "$key" ] || [ -z "$value" ]; then
        caddie cli:red "Error: Both key and value are required"
        caddie cli:usage "caddie ios:config:set <key> <value>"
        caddie cli:blank
        caddie cli:title "Available keys:"
        caddie cli:indent "apple-id          Your Apple ID email"
        caddie cli:indent "password          App-specific password (recommended)"
        caddie cli:indent "bundle-id         Bundle identifier (e.g., com.example.app)"
        caddie cli:indent "version           App version (e.g., 1.0)"
        caddie cli:indent "build             Build number (e.g., 1)"
        caddie cli:indent "team-id           Development team ID"
        caddie cli:indent "scheme            Xcode scheme name"
        caddie cli:blank
        caddie cli:title "Examples:"
        caddie cli:indent "caddie ios:config:set apple-id 'your@apple.id'"
        caddie cli:indent "caddie ios:config:set password 'xxxx-xxxx-xxxx-xxxx'"
        caddie cli:indent "caddie ios:config:set bundle-id 'com.example.app'"
        return 1
    fi
    
    # Normalize key name and set value
    case "$key" in
        apple-id|apple_id|APPLE_ID)
            export CADDIE_IOS_APPLE_ID="$value"
            caddie cli:check "Set apple-id to: $value"
            ;;
        password|app-specific-password|app_specific_password|APP_SPECIFIC_PASSWORD)
            export CADDIE_IOS_APP_SPECIFIC_PASSWORD="$value"
            caddie cli:check "Set password (hidden)"
            ;;
        bundle-id|bundle_id|BUNDLE_ID)
            export CADDIE_IOS_BUNDLE_ID="$value"
            caddie cli:check "Set bundle-id to: $value"
            ;;
        version|VERSION)
            export CADDIE_IOS_VERSION="$value"
            caddie cli:check "Set version to: $value"
            ;;
        build|BUILD)
            export CADDIE_IOS_BUILD="$value"
            caddie cli:check "Set build to: $value"
            ;;
        team-id|team_id|TEAM_ID)
            export CADDIE_IOS_TEAM_ID="$value"
            caddie cli:check "Set team-id to: $value"
            ;;
        scheme|SCHEME)
            export CADDIE_IOS_SCHEME="$value"
            caddie cli:check "Set scheme to: $value"
            ;;
        *)
            caddie cli:red "Error: Unknown configuration key '$key'"
            caddie cli:blank
            caddie cli:title "Available keys:"
            caddie cli:indent "apple-id, password, bundle-id, version, build, team-id, scheme"
            return 1
            ;;
    esac
    
    _caddie_ios_save_config
    return 0
}

# Function to unset iOS configuration value
function caddie_ios_config_unset() {
    _caddie_ios_load_config
    
    local key="$1"
    
    if [ -z "$key" ]; then
        caddie cli:red "Error: Key is required"
        caddie cli:usage "caddie ios:config:unset <key>"
        return 1
    fi
    
    # Normalize key name and unset value
    case "$key" in
        apple-id|apple_id|APPLE_ID)
            unset CADDIE_IOS_APPLE_ID
            caddie cli:check "Unset apple-id"
            ;;
        password|app-specific-password|app_specific_password|APP_SPECIFIC_PASSWORD)
            unset CADDIE_IOS_APP_SPECIFIC_PASSWORD
            caddie cli:check "Unset password"
            ;;
        bundle-id|bundle_id|BUNDLE_ID)
            unset CADDIE_IOS_BUNDLE_ID
            caddie cli:check "Unset bundle-id"
            ;;
        version|VERSION)
            unset CADDIE_IOS_VERSION
            caddie cli:check "Unset version"
            ;;
        build|BUILD)
            unset CADDIE_IOS_BUILD
            caddie cli:check "Unset build"
            ;;
        team-id|team_id|TEAM_ID)
            unset CADDIE_IOS_TEAM_ID
            caddie cli:check "Unset team-id"
            ;;
        scheme|SCHEME)
            unset CADDIE_IOS_SCHEME
            caddie cli:check "Unset scheme"
            ;;
        *)
            caddie cli:red "Error: Unknown configuration key '$key'"
            caddie cli:blank
            caddie cli:title "Available keys:"
            caddie cli:indent "apple-id, password, bundle-id, version, build, team-id, scheme"
            return 1
            ;;
    esac
    
    _caddie_ios_save_config
    return 0
}

# Function to list all iOS configuration
function caddie_ios_config_list() {
    caddie_ios_config_get
    return 0
}

# Function to load project info into config
function caddie_ios_config_load_project() {
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    
    if ! caddie_ios_project_info "$scheme" >/dev/null 2>&1; then
        return 1
    fi
    
    # Load project info into config
    if [ -n "${CADDIE_IOS_BUNDLE_ID:-}" ]; then
        caddie_ios_config_set bundle-id "$CADDIE_IOS_BUNDLE_ID" >/dev/null 2>&1
    fi
    if [ -n "${CADDIE_IOS_VERSION:-}" ]; then
        caddie_ios_config_set version "$CADDIE_IOS_VERSION" >/dev/null 2>&1
    fi
    if [ -n "${CADDIE_IOS_BUILD:-}" ]; then
        caddie_ios_config_set build "$CADDIE_IOS_BUILD" >/dev/null 2>&1
    fi
    if [ -n "${CADDIE_IOS_TEAM_ID:-}" ]; then
        caddie_ios_config_set team-id "$CADDIE_IOS_TEAM_ID" >/dev/null 2>&1
    fi
    if [ -n "$scheme" ]; then
        caddie_ios_config_set scheme "$scheme" >/dev/null 2>&1
    fi
    
    caddie cli:check "Project information loaded into configuration"
    caddie cli:thought "View with: caddie ios:config:get"
    return 0
}

# Function to get project information (bundle ID, version, build number)
function caddie_ios_project_info() {
    _caddie_ios_load_config
    
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local project_file=""
    local workspace_file=""
    
    # Find project files
    project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
    workspace_file=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
    
    # Auto-detect scheme if not provided
    if [ -z "$scheme" ]; then
        if [ -n "$project_file" ]; then
            scheme=$(xcodebuild -list -project "$project_file" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | sed 's/^[[:space:]]*//' | grep -v "^$")
            # Prefer scheme matching project name
            local project_name=$(basename "$project_file" .xcodeproj)
            if xcodebuild -list -project "$project_file" 2>/dev/null | grep -q "^[[:space:]]*${project_name}[[:space:]]*$"; then
                scheme="$project_name"
            fi
        fi
    fi
    
    if [ -z "$scheme" ]; then
        caddie cli:red "Error: Could not determine scheme. Please specify it as an argument."
        caddie cli:usage "caddie ios:project:info [scheme]"
        return 1
    fi
    
    caddie cli:title "Project Information (Scheme: $scheme)"
    caddie cli:blank
    
    # Use xcodebuild -showBuildSettings to get project info
    local build_settings=""
    if [ -n "$workspace_file" ]; then
        build_settings=$(xcodebuild -workspace "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    else
        build_settings=$(xcodebuild -project "$project_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    fi
    
    if [ -z "$build_settings" ]; then
        caddie cli:red "Error: Failed to read build settings"
        return 1
    fi
    
    # Extract values
    local bundle_id=$(echo "$build_settings" | grep "PRODUCT_BUNDLE_IDENTIFIER" | head -1 | sed 's/.*= *//' | xargs)
    local version=$(echo "$build_settings" | grep "MARKETING_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    local build=$(echo "$build_settings" | grep "CURRENT_PROJECT_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    local team_id=$(echo "$build_settings" | grep "DEVELOPMENT_TEAM" | head -1 | sed 's/.*= *//' | xargs)
    local display_name=$(echo "$build_settings" | grep "INFOPLIST_KEY_CFBundleDisplayName" | head -1 | sed 's/.*= *//' | xargs)
    
    if [ -z "$display_name" ]; then
        display_name=$(echo "$build_settings" | grep "PRODUCT_NAME" | head -1 | sed 's/.*= *//' | xargs)
    fi
    
    caddie cli:indent "Display Name: ${display_name:-N/A}"
    caddie cli:indent "Bundle ID: ${bundle_id:-N/A}"
    caddie cli:indent "Version: ${version:-N/A}"
    caddie cli:indent "Build Number: ${build:-N/A}"
    caddie cli:indent "Team ID: ${team_id:-N/A}"
    
    # Export for use by other functions
    export CADDIE_IOS_BUNDLE_ID="$bundle_id"
    export CADDIE_IOS_VERSION="$version"
    export CADDIE_IOS_BUILD="$build"
    export CADDIE_IOS_TEAM_ID="$team_id"
    export CADDIE_IOS_DISPLAY_NAME="$display_name"
    
    return 0
}

# Function to increment build number
function caddie_ios_increment_build() {
    _caddie_ios_load_config
    
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local project_file=""
    
    # Find project file
    project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
    
    if [ -z "$project_file" ]; then
        caddie cli:red "Error: Could not find .xcodeproj file"
        return 1
    fi
    
    # Auto-detect scheme if not provided
    if [ -z "$scheme" ]; then
        local project_name=$(basename "$project_file" .xcodeproj)
        if xcodebuild -list -project "$project_file" 2>/dev/null | grep -q "^[[:space:]]*${project_name}[[:space:]]*$"; then
            scheme="$project_name"
        else
            scheme=$(xcodebuild -list -project "$project_file" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | sed 's/^[[:space:]]*//' | grep -v "^$")
        fi
    fi
    
    if [ -z "$scheme" ]; then
        caddie cli:red "Error: Could not determine scheme. Please specify it as an argument."
        caddie cli:usage "caddie ios:increment:build [scheme]"
        return 1
    fi
    
    caddie cli:title "Incrementing Build Number (Scheme: $scheme)"
    
    # Get current build number
    local build_settings=$(xcodebuild -project "$project_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    local current_build=$(echo "$build_settings" | grep "CURRENT_PROJECT_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    
    if [ -z "$current_build" ]; then
        current_build="1"
    fi
    
    # Increment build number
    local new_build=$((current_build + 1))
    
    caddie cli:indent "Current build: $current_build"
    caddie cli:indent "New build: $new_build"
    
    # Update build number using agvtool if available, otherwise use PlistBuddy
    if command -v agvtool >/dev/null 2>&1; then
        caddie cli:indent "Using agvtool to update build number..."
        agvtool new-version -all "$new_build" >/dev/null 2>&1
    else
        # Try to update in project.pbxproj directly
        caddie cli:indent "Updating build number in project file..."
        # Use sed to update CURRENT_PROJECT_VERSION in project.pbxproj
        sed -i '' "s/CURRENT_PROJECT_VERSION = ${current_build};/CURRENT_PROJECT_VERSION = ${new_build};/g" "$project_file/project.pbxproj" 2>/dev/null || true
        
        # Also update in Info.plist if it exists
        local info_plist=$(find . -name "Info.plist" -type f | head -1)
        if [ -n "$info_plist" ] && [ -f "$info_plist" ]; then
            if command -v /usr/libexec/PlistBuddy >/dev/null 2>&1; then
                /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $new_build" "$info_plist" 2>/dev/null || true
            fi
        fi
    fi
    
    caddie cli:check "Build number incremented to $new_build"
    return 0
}

# Function to create archive for TestFlight
function caddie_ios_archive_testflight() {
    _caddie_ios_load_config
    
    if [ ! -f ./*.xcodeproj ] && [ ! -f ./*.xcworkspace ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi
    
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local project_file=""
    local workspace_file=""
    local archive_path="${2:-./build/archive}"
    
    # Find project files
    project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
    workspace_file=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
    
    # Auto-detect scheme if not provided
    if [ -z "$scheme" ]; then
        if [ -n "$project_file" ]; then
            local project_name=$(basename "$project_file" .xcodeproj)
            if xcodebuild -list -project "$project_file" 2>/dev/null | grep -q "^[[:space:]]*${project_name}[[:space:]]*$"; then
                scheme="$project_name"
            else
                scheme=$(xcodebuild -list -project "$project_file" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | sed 's/^[[:space:]]*//' | grep -v "^$")
            fi
        fi
    fi
    
    if [ -z "$scheme" ]; then
        caddie cli:red "Error: Could not determine scheme. Please specify it as an argument."
        caddie cli:usage "caddie ios:archive:testflight [scheme] [archive_path]"
        return 1
    fi
    
    caddie cli:title "Creating Archive for TestFlight (Scheme: $scheme)"
    
    # Create archive directory
    mkdir -p "$archive_path"
    
    local archive_name="${scheme}.xcarchive"
    local full_archive_path="$archive_path/$archive_name"
    
    # Clean up old archive if it exists
    if [ -d "$full_archive_path" ]; then
        caddie cli:indent "Removing old archive..."
        rm -rf "$full_archive_path"
    fi
    
    caddie cli:indent "Archive path: $full_archive_path"
    
    # Build archive
    local build_cmd=""
    if [ -n "$workspace_file" ]; then
        build_cmd="xcodebuild archive -workspace \"$workspace_file\" -scheme \"$scheme\" -configuration Release -archivePath \"$full_archive_path\" -destination generic/platform=iOS"
    else
        build_cmd="xcodebuild archive -project \"$project_file\" -scheme \"$scheme\" -configuration Release -archivePath \"$full_archive_path\" -destination generic/platform=iOS"
    fi
    
    caddie cli:indent "Building archive..."
    if eval "$build_cmd"; then
        caddie cli:check "Archive created successfully"
        caddie cli:indent "Location: $full_archive_path"
        export CADDIE_IOS_ARCHIVE_PATH="$full_archive_path"
        return 0
    else
        caddie cli:red "Failed to create archive"
        return 1
    fi
}

# Function to export IPA from archive
function caddie_ios_export_ipa() {
    local archive_path="${1:-${CADDIE_IOS_ARCHIVE_PATH:-}}"
    local export_path="${2:-./build/export}"
    local export_options_plist="${3:-}"
    
    if [ -z "$archive_path" ] || [ ! -d "$archive_path" ]; then
        caddie cli:red "Error: Archive path not provided or does not exist"
        caddie cli:usage "caddie ios:export:ipa [archive_path] [export_path] [export_options_plist]"
        return 1
    fi
    
    caddie cli:title "Exporting IPA from Archive"
    
    # Create export directory
    mkdir -p "$export_path"
    
    # Create export options plist if not provided
    if [ -z "$export_options_plist" ]; then
        export_options_plist="$export_path/ExportOptions.plist"
        
        # Get team ID from archive
        local team_id=$(/usr/libexec/PlistBuddy -c "Print :ApplicationProperties:TeamIdentifier" "$archive_path/Info.plist" 2>/dev/null | head -1 | xargs)
        local method="app-store"
        
        caddie cli:indent "Creating export options plist..."
        cat > "$export_options_plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>${method}</string>
    <key>uploadSymbols</key>
    <true/>
    <key>uploadBitcode</key>
    <false/>
    <key>compileBitcode</key>
    <false/>
    <key>signingStyle</key>
    <string>automatic</string>
EOF
        if [ -n "$team_id" ]; then
            cat >> "$export_options_plist" <<EOF
    <key>teamID</key>
    <string>${team_id}</string>
EOF
        fi
        cat >> "$export_options_plist" <<EOF
</dict>
</plist>
EOF
        caddie cli:check "Export options plist created"
    fi
    
    caddie cli:indent "Export path: $export_path"
    
    # Export IPA
    if xcodebuild -exportArchive -archivePath "$archive_path" -exportPath "$export_path" -exportOptionsPlist "$export_options_plist"; then
        local ipa_file=$(find "$export_path" -name "*.ipa" -type f | head -1)
        if [ -n "$ipa_file" ]; then
            caddie cli:check "IPA exported successfully"
            caddie cli:indent "IPA location: $ipa_file"
            export CADDIE_IOS_IPA_PATH="$ipa_file"
            return 0
        else
            caddie cli:red "IPA file not found after export"
            return 1
        fi
    else
        caddie cli:red "Failed to export IPA"
        return 1
    fi
}

# Function to upload to TestFlight
function caddie_ios_upload_testflight() {
    _caddie_ios_load_config
    
    local ipa_path="${1:-${CADDIE_IOS_IPA_PATH:-}}"
    local apple_id="${2:-${CADDIE_IOS_APPLE_ID:-}}"
    local password="${3:-${CADDIE_IOS_APPLE_PASSWORD:-}}"
    local app_specific_password="${4:-${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}}"
    
    if [ -z "$ipa_path" ] || [ ! -f "$ipa_path" ]; then
        caddie cli:red "Error: IPA path not provided or file does not exist"
        caddie cli:usage "caddie ios:upload:testflight [ipa_path] [apple_id] [password]"
        return 1
    fi
    
    caddie cli:title "Uploading to TestFlight"
    
    # Check for credentials
    if [ -z "$apple_id" ]; then
        caddie cli:red "Error: Apple ID not provided"
        caddie cli:thought "Set CADDIE_IOS_APPLE_ID environment variable or pass as argument"
        caddie cli:thought "Example: export CADDIE_IOS_APPLE_ID='your@apple.id'"
        return 1
    fi
    
    # Prefer app-specific password if provided (altool uses --password for both)
    local auth_password=""
    if [ -n "$app_specific_password" ]; then
        auth_password="$app_specific_password"
        caddie cli:indent "Using app-specific password"
    elif [ -n "$password" ]; then
        auth_password="$password"
        caddie cli:indent "Using password (consider using app-specific password)"
    else
        caddie cli:red "Error: Password or app-specific password not provided"
        caddie cli:thought "Set CADDIE_IOS_APP_SPECIFIC_PASSWORD environment variable"
        caddie cli:thought "Get app-specific password from: https://appleid.apple.com/account/manage"
        return 1
    fi
    
    caddie cli:indent "IPA: $ipa_path"
    caddie cli:indent "Apple ID: $apple_id"
    
    # Check if altool is available
    if ! command -v xcrun >/dev/null 2>&1 || ! xcrun altool --help >/dev/null 2>&1; then
        caddie cli:red "Error: xcrun altool not available"
        caddie cli:thought "Please ensure Xcode command line tools are installed"
        return 1
    fi
    
    # Upload using altool
    caddie cli:indent "Uploading..."
    if xcrun altool --upload-app --type ios --file "$ipa_path" --username "$apple_id" --password "$auth_password"; then
        caddie cli:check "Upload completed successfully"
        caddie cli:blank
        caddie cli:title "Next Steps:"
        caddie cli:indent "1. Wait for processing in App Store Connect (5-30 minutes)"
        caddie cli:indent "2. Go to: https://appstoreconnect.apple.com"
        caddie cli:indent "3. Navigate to: My Apps → Your App → TestFlight"
        caddie cli:indent "4. Add build to testing groups when processing completes"
        return 0
    else
        caddie cli:red "Upload failed"
        return 1
    fi
}

# Complete TestFlight workflow: increment build, archive, export, upload
function caddie_ios_testflight() {
    _caddie_ios_load_config
    
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local auto_increment="${2:-yes}"
    local upload="${3:-yes}"
    
    caddie cli:title "TestFlight Upload Workflow"
    caddie cli:blank
    
    # Step 1: Get project info
    if ! caddie_ios_project_info "$scheme"; then
        return 1
    fi
    
    # Step 2: Increment build if requested
    if [ "$auto_increment" = "yes" ]; then
        caddie cli:blank
        if ! caddie_ios_increment_build "$scheme"; then
            caddie cli:yellow "Warning: Failed to increment build number, continuing..."
        fi
        # Refresh project info
        caddie_ios_project_info "$scheme" >/dev/null 2>&1
    fi
    
    # Step 3: Create archive
    caddie cli:blank
    if ! caddie_ios_archive_testflight "$scheme"; then
        return 1
    fi
    
    # Step 4: Export IPA
    caddie cli:blank
    if ! caddie_ios_export_ipa "$CADDIE_IOS_ARCHIVE_PATH"; then
        return 1
    fi
    
    # Step 5: Upload if requested
    if [ "$upload" = "yes" ]; then
        caddie cli:blank
        if ! caddie_ios_upload_testflight "$CADDIE_IOS_IPA_PATH"; then
            caddie cli:yellow "Warning: Upload failed, but archive and IPA were created"
            caddie cli:indent "You can upload manually later using:"
            caddie cli:indent "  caddie ios:upload:testflight \"$CADDIE_IOS_IPA_PATH\""
            return 1
        fi
    else
        caddie cli:blank
        caddie cli:title "Skipping Upload"
        caddie cli:indent "To upload later, run:"
        caddie cli:indent "  caddie ios:upload:testflight \"$CADDIE_IOS_IPA_PATH\""
    fi
    
    caddie cli:blank
    caddie cli:check "TestFlight workflow completed"
    return 0
}

# Function to setup Rust development environment for iOS
function caddie_ios_rust_setup() {
    caddie cli:title "Setting up Rust development environment for iOS..."
    
    # Check if Rust is installed
    if ! command -v rustc &> /dev/null; then
        caddie cli:title "Installing Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
        source "$HOME/.cargo/env"
        caddie cli:check "Rust installed successfully"
    else
        caddie cli:check "Rust already installed: $(rustc --version)"
    fi
    
    # Add iOS-specific Rust targets
    caddie cli:title "Adding iOS Rust targets..."
    rustup target add aarch64-apple-ios x86_64-apple-ios 2>/dev/null || true
    caddie cli:check "iOS Rust targets added successfully"
    
    # Install essential Cargo tools
    caddie cli:title "Installing essential Cargo tools..."
    cargo install cargo-edit cargo-watch cargo-tarpaulin 2>/dev/null || true
    caddie cli:check "Cargo tools installed successfully"
    
    # Validate iOS development environment
    caddie cli:title "Validating iOS development environment..."
    
    if ! command -v xcodebuild >/dev/null 2>&1; then
        caddie cli:x "Xcode not found. Please install Xcode from the App Store"
        return 1
    fi
    
    if ! command -v swift >/dev/null 2>&1; then
        caddie cli:x "Swift not found. Please install Xcode command line tools"
        caddie cli:thought "Run: xcode-select --install"
        return 1
    fi
    
    caddie cli:check "iOS development environment validated"
    caddie cli:indent "Xcode: $(xcodebuild -version | head -n1)"
    caddie cli:indent "Swift: $(swift --version | head -n1)"
    caddie cli:indent "Rust: $(rustc --version)"
    
    caddie cli:check "Rust development environment for iOS setup complete"
    caddie cli:blank
    caddie cli:title "Next steps:"
    caddie cli:indent "1. Build Rust library: cargo build --target aarch64-apple-ios --release --lib"
    caddie cli:indent "2. Create iOS framework structure for Swift integration"
    caddie cli:indent "3. Use the generated .a static libraries in your iOS project"
    return 0
}

# Function to display iOS module help
function caddie_ios_help() {
    caddie cli:title "iOS Development Tools"
    caddie cli:blank
    caddie cli:usage "caddie ios:<command>"
    caddie cli:blank
    caddie cli:title "Environment Setup:"
    caddie cli:indent "setup              Setup iOS development environment"
    caddie cli:indent "rust:setup         Setup Rust development environment for iOS"
    caddie cli:indent "simulator          List available simulators"
    caddie cli:indent "device             List connected devices"
    caddie cli:blank
    caddie cli:title "Project Management:"
    caddie cli:indent "build              Build iOS project"
    caddie cli:indent "run                Run on simulator/device"
    caddie cli:indent "test               Run iOS tests"
    caddie cli:indent "archive            Create archive for distribution"
    caddie cli:indent "clean              Clean build artifacts"
    caddie cli:blank
    caddie cli:title "Project Information:"
    caddie cli:indent "project:info [scheme]          Show bundle ID, version, build number"
    caddie cli:indent "increment:build [scheme]       Increment build number"
    caddie cli:blank
    caddie cli:title "Configuration Management:"
    caddie cli:indent "config:get [key]               Get configuration value(s)"
    caddie cli:indent "config:set <key> <value>       Set configuration value"
    caddie cli:indent "config:unset <key>             Remove configuration value"
    caddie cli:indent "config:list                     List all configuration"
    caddie cli:indent "config:load:project [scheme]   Load project info into config"
    caddie cli:blank
    caddie cli:title "TestFlight Distribution:"
    caddie cli:indent "archive:testflight [scheme] [path]    Create archive for TestFlight"
    caddie cli:indent "export:ipa [archive] [path] [plist]   Export IPA from archive"
    caddie cli:indent "upload:testflight [ipa] [id] [pwd]    Upload IPA to TestFlight"
    caddie cli:indent "testflight [scheme] [increment] [upload]  Complete workflow"
    caddie cli:blank
    caddie cli:title "Dependency Management:"
    caddie cli:indent "pod:install        Install CocoaPods dependencies"
    caddie cli:indent "pod:update         Update CocoaPods dependencies"
    caddie cli:blank
    caddie cli:title "Version Information:"
    caddie cli:indent "swift:version      Show Swift version"
    caddie cli:indent "xcode:version      Show Xcode version"
    caddie cli:blank
    caddie cli:title "Examples:"
    caddie cli:indent "caddie ios:setup"
    caddie cli:indent "caddie ios:project:info"
    caddie cli:indent "caddie ios:config:set apple-id 'your@apple.id'"
    caddie cli:indent "caddie ios:config:set password 'xxxx-xxxx-xxxx-xxxx'"
    caddie cli:indent "caddie ios:config:load:project vCaddie"
    caddie cli:indent "caddie ios:testflight"
    caddie cli:blank
    return 0
}

function caddie_ios_description() {
    # caddie:lint:disable
    echo 'iOS Development'
    # caddie:lint:enable
    return 0
}

# Export iOS functions
export -f caddie_ios_description
export -f caddie_ios_setup
export -f caddie_ios_rust_setup
export -f caddie_ios_simulator
export -f caddie_ios_device
export -f caddie_ios_build
export -f caddie_ios_run
export -f caddie_ios_test
export -f caddie_ios_archive
export -f caddie_ios_clean
export -f caddie_ios_pod_install
export -f caddie_ios_pod_update
export -f caddie_ios_swift_version
export -f caddie_ios_xcode_version
export -f caddie_ios_project_info
export -f caddie_ios_increment_build
export -f caddie_ios_archive_testflight
export -f caddie_ios_export_ipa
export -f caddie_ios_upload_testflight
export -f caddie_ios_testflight
export -f caddie_ios_config_get
export -f caddie_ios_config_set
export -f caddie_ios_config_unset
export -f caddie_ios_config_list
export -f caddie_ios_config_load_project
export -f caddie_ios_help

# Auto-load configuration when module is sourced
_caddie_ios_load_config