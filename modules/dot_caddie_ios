#!/bin/bash

# Caddie.sh - iOS Distribution
# This file contains App Store and TestFlight helpers

source "$HOME/.caddie_modules/.caddie_cli"

# Internal helpers for distribution workflows
function _caddie_ios_find_project_files() {
    local project_file
    local workspace_file

    project_file=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
    workspace_file=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)

    if [ -z "$project_file" ] && [ -z "$workspace_file" ]; then
        caddie cli:red "Error: Not in an iOS project directory (no .xcodeproj or .xcworkspace found)"
        return 1
    fi

    printf '%s\t%s\n' "$project_file" "$workspace_file"
    return 0
}

function _caddie_ios_xcodebuild() {
    local project_file="$1"
    local workspace_file="$2"
    shift 2 || true

    if [ -n "$workspace_file" ]; then
        xcodebuild -workspace "$workspace_file" "$@"
    else
        xcodebuild -project "$project_file" "$@"
    fi
    return $?
}

# Helper function to escape regex metacharacters for sed pattern
function _caddie_ios_escape_sed_pattern() {
    local value="$1"
    # Escape regex metacharacters: . * + ? [ ] ( ) { } ^ $ | \
    # Use multiple sed passes to escape each metacharacter
    printf '%s' "$value" | sed -e 's/\\/\\\\/g' -e 's/\./\\./g' -e 's/\*/\\*/g' -e 's/\+/\\+/g' -e 's/\?/\\?/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/{/\\{/g' -e 's/}/\\}/g' -e 's/\^/\\^/g' -e 's/\$/\\$/g' -e 's/|/\\|/g'
}

# Helper function to escape sed replacement string special characters
function _caddie_ios_escape_sed_replacement() {
    local value="$1"
    # Escape replacement special characters: & \ and the delimiter /
    printf '%s' "$value" | sed 's/[&\\/]/\\&/g'
}

function _caddie_ios_resolve_scheme() {
    local scheme="$1"
    local project_file="$2"
    local workspace_file="$3"
    local usage="$4"

    if [ -z "$scheme" ]; then
        scheme="${CADDIE_IOS_SCHEME:-}"
    fi

    if [ -z "$scheme" ]; then
        local schemes=""
        if [ -n "$workspace_file" ]; then
            schemes=$(xcodebuild -list -workspace "$workspace_file" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v "^$")
        else
            schemes=$(xcodebuild -list -project "$project_file" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//' | grep -v "^$")
        fi

        local base_name=""
        if [ -n "$workspace_file" ]; then
            base_name=$(basename "$workspace_file" .xcworkspace)
        else
            base_name=$(basename "$project_file" .xcodeproj)
        fi

        if echo "$schemes" | grep -q "^${base_name}$"; then
            scheme="$base_name"
        elif echo "$schemes" | grep -q "^vCaddie$"; then
            scheme="vCaddie"
        else
            scheme=$(echo "$schemes" | head -1 | xargs)
        fi
    fi

    if [ -z "$scheme" ]; then
        caddie cli:red "Error: Could not determine scheme. Please specify it as an argument."
        if [ -n "$usage" ]; then
            caddie cli:usage "$usage"
        fi
        return 1
    fi

    printf '%s\n' "$scheme"
    return 0
}

# iOS Configuration Management
CADDIE_IOS_CONFIG_FILE="$HOME/.caddie_ios_config"

function _caddie_ios_keychain_service() {
    local bundle_id="${CADDIE_IOS_BUNDLE_ID:-}"
    if [ -n "$bundle_id" ]; then
        printf '%s\n' "caddie-ios-testflight:${bundle_id}"
    else
        printf '%s\n' "caddie-ios-testflight"
    fi
    return 0
}

function _caddie_ios_keychain_password_read() {
    local apple_id="$1"
    if [ -z "$apple_id" ]; then
        return 1
    fi
    if ! command -v security >/dev/null 2>&1; then
        return 1
    fi
    local service=""
    local password=""
    service=$(_caddie_ios_keychain_service)
    password=$(security find-generic-password -a "$apple_id" -s "$service" -w 2>/dev/null)
    if [ -n "$password" ]; then
        printf '%s' "$password"
        return 0
    fi
    return 1
}

function _caddie_ios_prompt_secret() {
    local prompt="$1"
    local input=""
    local char=""
    local stty_state=""

    if [ ! -t 0 ]; then
        return 1
    fi

    if [ -n "$prompt" ]; then
        caddie cli:indent "$prompt"
    fi

    stty_state=$(stty -g 2>/dev/null || true)
    stty -echo 2>/dev/null || true
    while IFS= read -r -n1 char; do
        case "$char" in
            $'\n'|$'\r')
                break
                ;;
            $'\177'|$'\b')
                if [ -n "$input" ]; then
                    input="${input%?}"
                    printf '\b \b'
                fi
                ;;
            *)
                input+="$char"
                printf '*'
                ;;
        esac
    done
    if [ -n "$stty_state" ]; then
        stty "$stty_state" 2>/dev/null || true
    else
        stty echo 2>/dev/null || true
    fi
    printf '\n'
    printf '%s' "$input"
    return 0
}

function _caddie_ios_api_key_path() {
    local api_key="$1"
    if [ -z "$api_key" ]; then
        return 1
    fi
    local candidate=""
    for candidate in "$HOME/.private_keys/AuthKey_${api_key}.p8" "$HOME/private_keys/AuthKey_${api_key}.p8"; do
        if [ -f "$candidate" ]; then
            printf '%s\n' "$candidate"
            return 0
        fi
    done
    return 1
}

# Function to load iOS configuration
function _caddie_ios_load_config() {
    if [ -f "$CADDIE_IOS_CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CADDIE_IOS_CONFIG_FILE"
    fi
}

# Helper function to escape a value for safe shell assignment
# Escapes single quotes by replacing ' with '\''
function _caddie_ios_escape_value() {
    local value="$1"
    # Replace single quotes with '\'' (end quote, escaped quote, start quote)
    # Build the escaped string by replacing each ' with '\''
    local result=""
    local i=0
    while [ $i -lt ${#value} ]; do
        local char="${value:$i:1}"
        if [ "$char" = "'" ]; then
            result="${result}'\\''"
        else
            result="${result}${char}"
        fi
        i=$((i + 1))
    done
    printf '%s' "$result"
}

# Function to save iOS configuration
function _caddie_ios_save_config() {
    {
        printf "# Caddie iOS Configuration\n"
        printf "# This file is automatically generated. Do not edit manually.\n"
        printf "\n"
        [ -n "${CADDIE_IOS_APPLE_ID:-}" ] && printf "CADDIE_IOS_APPLE_ID='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_APPLE_ID}")"
        [ -n "${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}" ] && printf "CADDIE_IOS_APP_SPECIFIC_PASSWORD='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_APP_SPECIFIC_PASSWORD}")"
        [ -n "${CADDIE_IOS_APPLE_PASSWORD:-}" ] && printf "CADDIE_IOS_APPLE_PASSWORD='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_APPLE_PASSWORD}")"
        [ -n "${CADDIE_IOS_API_KEY:-}" ] && printf "CADDIE_IOS_API_KEY='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_API_KEY}")"
        [ -n "${CADDIE_IOS_API_ISSUER:-}" ] && printf "CADDIE_IOS_API_ISSUER='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_API_ISSUER}")"
        [ -n "${CADDIE_IOS_BUNDLE_ID:-}" ] && printf "CADDIE_IOS_BUNDLE_ID='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_BUNDLE_ID}")"
        [ -n "${CADDIE_IOS_VERSION:-}" ] && printf "CADDIE_IOS_VERSION='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_VERSION}")"
        [ -n "${CADDIE_IOS_BUILD:-}" ] && printf "CADDIE_IOS_BUILD='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_BUILD}")"
        [ -n "${CADDIE_IOS_TEAM_ID:-}" ] && printf "CADDIE_IOS_TEAM_ID='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_TEAM_ID}")"
        [ -n "${CADDIE_IOS_SCHEME:-}" ] && printf "CADDIE_IOS_SCHEME='%s'\n" "$(_caddie_ios_escape_value "${CADDIE_IOS_SCHEME}")"
    } > "$CADDIE_IOS_CONFIG_FILE"
}

# Function to get iOS configuration value
function caddie_ios_config_get() {
    _caddie_ios_load_config
    
    local key="$1"
    
    if [ -z "$key" ]; then
        caddie cli:title "iOS Configuration"
        caddie cli:blank
        caddie cli:indent "apple-id:        ${CADDIE_IOS_APPLE_ID:-<not set>}"
        # Security: Never display password value, only show if set
        if [ -n "${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}" ]; then
            caddie cli:indent "password:        <set>"
        else
            caddie cli:indent "password:        <not set>"
        fi
        if [ -n "${CADDIE_IOS_APPLE_ID:-}" ] && _caddie_ios_keychain_password_read "${CADDIE_IOS_APPLE_ID}" >/dev/null 2>&1; then
            caddie cli:indent "keychain-password: <set>"
        else
            caddie cli:indent "keychain-password: <not set>"
        fi
        caddie cli:indent "api-key:         ${CADDIE_IOS_API_KEY:-<not set>}"
        caddie cli:indent "api-issuer:      ${CADDIE_IOS_API_ISSUER:-<not set>}"
        caddie cli:indent "bundle-id:       ${CADDIE_IOS_BUNDLE_ID:-<not set>}"
        caddie cli:indent "version:         ${CADDIE_IOS_VERSION:-<not set>}"
        caddie cli:indent "build:           ${CADDIE_IOS_BUILD:-<not set>}"
        caddie cli:indent "team-id:         ${CADDIE_IOS_TEAM_ID:-<not set>}"
        caddie cli:indent "scheme:          ${CADDIE_IOS_SCHEME:-<not set>}"
        caddie cli:blank
        caddie cli:thought "Use 'caddie ios:config:get <key>' to get a specific value"
        caddie cli:thought "Use 'caddie ios:config:set <key> <value>' to set a value"
        return 0
    fi
    
    # Normalize key name
    local value=""
    case "$key" in
        apple-id|apple_id|APPLE_ID)
            key="apple-id"
            value="${CADDIE_IOS_APPLE_ID:-}"
            ;;
        password|app-specific-password|app_specific_password|APP_SPECIFIC_PASSWORD)
            key="password"
            value="${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}"
            ;;
        api-key|api_key|API_KEY)
            key="api-key"
            value="${CADDIE_IOS_API_KEY:-}"
            ;;
        api-issuer|api_issuer|API_ISSUER)
            key="api-issuer"
            value="${CADDIE_IOS_API_ISSUER:-}"
            ;;
        bundle-id|bundle_id|BUNDLE_ID)
            key="bundle-id"
            value="${CADDIE_IOS_BUNDLE_ID:-}"
            ;;
        version|VERSION)
            key="version"
            value="${CADDIE_IOS_VERSION:-}"
            ;;
        build|BUILD)
            key="build"
            value="${CADDIE_IOS_BUILD:-}"
            ;;
        team-id|team_id|TEAM_ID)
            key="team-id"
            value="${CADDIE_IOS_TEAM_ID:-}"
            ;;
        scheme|SCHEME)
            key="scheme"
            value="${CADDIE_IOS_SCHEME:-}"
            ;;
        *)
            caddie cli:red "Error: Unknown configuration key '$key'"
            caddie cli:blank
            caddie cli:title "Available keys:"
            caddie cli:indent "apple-id, password, api-key, api-issuer, bundle-id, version, build, team-id, scheme"
            return 1
            ;;
    esac
    
    if [ -z "$value" ]; then
        caddie cli:yellow "$key: <not set>"
        return 1
    else
        if [ "$key" = "password" ]; then
            caddie cli:green "$key: <set>"
        else
            caddie cli:green "$key: $value"
        fi
        return 0
    fi
}

# Function to set iOS configuration value
function caddie_ios_config_set() {
    _caddie_ios_load_config
    
    local key="$1"
    local value="$2"
    
    if [ -z "$key" ] || [ -z "$value" ]; then
        caddie cli:red "Error: Both key and value are required"
        caddie cli:usage "caddie ios:config:set <key> <value>"
        caddie cli:blank
        caddie cli:title "Available keys:"
        caddie cli:indent "apple-id          Your Apple ID email"
        caddie cli:indent "password          App-specific password (recommended)"
        caddie cli:indent "api-key           App Store Connect API key ID"
        caddie cli:indent "api-issuer        App Store Connect API issuer ID"
        caddie cli:indent "bundle-id         Bundle identifier (e.g., com.example.app)"
        caddie cli:indent "version           App version (e.g., 1.0)"
        caddie cli:indent "build             Build number (e.g., 1)"
        caddie cli:indent "team-id           Development team ID"
        caddie cli:indent "scheme            Xcode scheme name"
        caddie cli:blank
        caddie cli:title "Examples:"
        caddie cli:indent "caddie ios:config:set apple-id 'your@apple.id'"
        caddie cli:indent "caddie ios:config:set password 'xxxx-xxxx-xxxx-xxxx'"
        caddie cli:indent "caddie ios:config:set bundle-id 'com.example.app'"
        return 1
    fi
    
    # Normalize key name and set value
    case "$key" in
        apple-id|apple_id|APPLE_ID)
            export CADDIE_IOS_APPLE_ID="$value"
            caddie cli:check "Set apple-id to: $value"
            ;;
        password|app-specific-password|app_specific_password|APP_SPECIFIC_PASSWORD)
            export CADDIE_IOS_APP_SPECIFIC_PASSWORD="$value"
            caddie cli:check "Set password (hidden)"
            ;;
        api-key|api_key|API_KEY)
            export CADDIE_IOS_API_KEY="$value"
            caddie cli:check "Set api-key to: $value"
            ;;
        api-issuer|api_issuer|API_ISSUER)
            export CADDIE_IOS_API_ISSUER="$value"
            caddie cli:check "Set api-issuer to: $value"
            ;;
        bundle-id|bundle_id|BUNDLE_ID)
            export CADDIE_IOS_BUNDLE_ID="$value"
            caddie cli:check "Set bundle-id to: $value"
            ;;
        version|VERSION)
            export CADDIE_IOS_VERSION="$value"
            caddie cli:check "Set version to: $value"
            ;;
        build|BUILD)
            export CADDIE_IOS_BUILD="$value"
            caddie cli:check "Set build to: $value"
            ;;
        team-id|team_id|TEAM_ID)
            export CADDIE_IOS_TEAM_ID="$value"
            caddie cli:check "Set team-id to: $value"
            ;;
        scheme|SCHEME)
            export CADDIE_IOS_SCHEME="$value"
            caddie cli:check "Set scheme to: $value"
            ;;
        *)
            caddie cli:red "Error: Unknown configuration key '$key'"
            caddie cli:blank
            caddie cli:title "Available keys:"
            caddie cli:indent "apple-id, password, api-key, api-issuer, bundle-id, version, build, team-id, scheme"
            return 1
            ;;
    esac
    
    _caddie_ios_save_config
    return 0
}

# Function to unset iOS configuration value
function caddie_ios_config_unset() {
    _caddie_ios_load_config
    
    local key="$1"
    
    if [ -z "$key" ]; then
        caddie cli:red "Error: Key is required"
        caddie cli:usage "caddie ios:config:unset <key>"
        return 1
    fi
    
    # Normalize key name and unset value
    case "$key" in
        apple-id|apple_id|APPLE_ID)
            unset CADDIE_IOS_APPLE_ID
            caddie cli:check "Unset apple-id"
            ;;
        password|app-specific-password|app_specific_password|APP_SPECIFIC_PASSWORD)
            unset CADDIE_IOS_APP_SPECIFIC_PASSWORD
            caddie cli:check "Unset password"
            ;;
        api-key|api_key|API_KEY)
            unset CADDIE_IOS_API_KEY
            caddie cli:check "Unset api-key"
            ;;
        api-issuer|api_issuer|API_ISSUER)
            unset CADDIE_IOS_API_ISSUER
            caddie cli:check "Unset api-issuer"
            ;;
        bundle-id|bundle_id|BUNDLE_ID)
            unset CADDIE_IOS_BUNDLE_ID
            caddie cli:check "Unset bundle-id"
            ;;
        version|VERSION)
            unset CADDIE_IOS_VERSION
            caddie cli:check "Unset version"
            ;;
        build|BUILD)
            unset CADDIE_IOS_BUILD
            caddie cli:check "Unset build"
            ;;
        team-id|team_id|TEAM_ID)
            unset CADDIE_IOS_TEAM_ID
            caddie cli:check "Unset team-id"
            ;;
        scheme|SCHEME)
            unset CADDIE_IOS_SCHEME
            caddie cli:check "Unset scheme"
            ;;
        *)
            caddie cli:red "Error: Unknown configuration key '$key'"
            caddie cli:blank
            caddie cli:title "Available keys:"
            caddie cli:indent "apple-id, password, api-key, api-issuer, bundle-id, version, build, team-id, scheme"
            return 1
            ;;
    esac
    
    _caddie_ios_save_config
    return 0
}

# Function to list all iOS configuration
function caddie_ios_config_list() {
    caddie_ios_config_get
    return 0
}

function caddie_ios_keychain_password_set() {
    _caddie_ios_load_config

    local apple_id="${1:-${CADDIE_IOS_APPLE_ID:-}}"
    local password="$2"
    if [ -z "$apple_id" ] || [ -z "$password" ]; then
        caddie cli:red "Error: Apple ID and password are required"
        caddie cli:usage "caddie ios:keychain:password:set <apple_id> <app-specific-password>"
        return 1
    fi
    if ! command -v security >/dev/null 2>&1; then
        caddie cli:red "Error: security command not available"
        return 1
    fi

    local service=""
    service=$(_caddie_ios_keychain_service)
    if security add-generic-password -a "$apple_id" -s "$service" -w "$password" -U >/dev/null 2>&1; then
        caddie cli:check "Keychain password stored"
        caddie cli:indent "Service: $service"
        caddie cli:indent "Apple ID: $apple_id"
        return 0
    fi

    caddie cli:red "Error: Failed to store keychain password"
    return 1
}

function caddie_ios_keychain_password_get() {
    _caddie_ios_load_config

    local apple_id="${1:-${CADDIE_IOS_APPLE_ID:-}}"
    if [ -z "$apple_id" ]; then
        caddie cli:red "Error: Apple ID is required"
        caddie cli:usage "caddie ios:keychain:password:get <apple_id>"
        return 1
    fi

    local service=""
    service=$(_caddie_ios_keychain_service)
    if _caddie_ios_keychain_password_read "$apple_id" >/dev/null 2>&1; then
        caddie cli:green "Keychain password: <set>"
        caddie cli:indent "Service: $service"
        caddie cli:indent "Apple ID: $apple_id"
        return 0
    fi

    caddie cli:yellow "Keychain password not set"
    caddie cli:thought "Use 'caddie ios:keychain:password:set <apple_id> <app-specific-password>'"
    return 1
}

function caddie_ios_keychain_password_unset() {
    _caddie_ios_load_config

    local apple_id="${1:-${CADDIE_IOS_APPLE_ID:-}}"
    if [ -z "$apple_id" ]; then
        caddie cli:red "Error: Apple ID is required"
        caddie cli:usage "caddie ios:keychain:password:unset <apple_id>"
        return 1
    fi
    if ! command -v security >/dev/null 2>&1; then
        caddie cli:red "Error: security command not available"
        return 1
    fi

    local service=""
    service=$(_caddie_ios_keychain_service)
    if security delete-generic-password -a "$apple_id" -s "$service" >/dev/null 2>&1; then
        caddie cli:check "Keychain password removed"
        caddie cli:indent "Service: $service"
        caddie cli:indent "Apple ID: $apple_id"
        return 0
    fi

    caddie cli:yellow "Keychain password not found"
    return 1
}

# Function to load project info into config
function caddie_ios_config_load_project() {
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    
    if ! caddie_ios_project_info "$scheme" >/dev/null 2>&1; then
        return 1
    fi
    
    # Load project info into config
    if [ -n "${CADDIE_IOS_BUNDLE_ID:-}" ]; then
        caddie_ios_config_set bundle-id "$CADDIE_IOS_BUNDLE_ID" >/dev/null 2>&1
    fi
    if [ -n "${CADDIE_IOS_VERSION:-}" ]; then
        caddie_ios_config_set version "$CADDIE_IOS_VERSION" >/dev/null 2>&1
    fi
    if [ -n "${CADDIE_IOS_BUILD:-}" ]; then
        caddie_ios_config_set build "$CADDIE_IOS_BUILD" >/dev/null 2>&1
    fi
    if [ -n "${CADDIE_IOS_TEAM_ID:-}" ]; then
        caddie_ios_config_set team-id "$CADDIE_IOS_TEAM_ID" >/dev/null 2>&1
    fi
    if [ -n "$scheme" ]; then
        caddie_ios_config_set scheme "$scheme" >/dev/null 2>&1
    fi
    
    caddie cli:check "Project information loaded into configuration"
    caddie cli:thought "View with: caddie ios:config:get"
    return 0
}

# Function to get project information (bundle ID, version, build number)
function caddie_ios_project_info() {
    _caddie_ios_load_config
    local project_file=""
    local workspace_file=""
    if ! IFS=$'\t' read -r project_file workspace_file < <(_caddie_ios_find_project_files); then
        return 1
    fi

    local scheme="$1"
    if ! scheme=$(_caddie_ios_resolve_scheme "$scheme" "$project_file" "$workspace_file" "caddie ios:project:info [scheme]"); then
        return 1
    fi
    
    caddie cli:title "Project Information (Scheme: $scheme)"
    caddie cli:blank
    
    # Use xcodebuild -showBuildSettings to get project info
    local build_settings=""
    build_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    
    if [ -z "$build_settings" ]; then
        caddie cli:red "Error: Failed to read build settings"
        return 1
    fi
    
    # Extract values
    # Match only PRODUCT_BUNDLE_IDENTIFIER (not DERIVE_MACCATALYST_PRODUCT_BUNDLE_IDENTIFIER)
    # Use \b word boundary or explicit pattern to avoid false matches
    local bundle_id=$(echo "$build_settings" | grep -E "^[[:space:]]+PRODUCT_BUNDLE_IDENTIFIER[[:space:]]*=" | head -1 | sed 's/.*=[[:space:]]*//' | xargs)
    local version=$(echo "$build_settings" | grep "MARKETING_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    local build=$(echo "$build_settings" | grep "CURRENT_PROJECT_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    local team_id=$(echo "$build_settings" | grep "DEVELOPMENT_TEAM" | head -1 | sed 's/.*= *//' | xargs)
    local display_name=$(echo "$build_settings" | grep "INFOPLIST_KEY_CFBundleDisplayName" | head -1 | sed 's/.*= *//' | xargs)
    
    if [ -z "$display_name" ]; then
        display_name=$(echo "$build_settings" | grep "PRODUCT_NAME" | head -1 | sed 's/.*= *//' | xargs)
    fi
    
    caddie cli:indent "Display Name: ${display_name:-N/A}"
    caddie cli:indent "Bundle ID: ${bundle_id:-N/A}"
    caddie cli:indent "Version: ${version:-N/A}"
    caddie cli:indent "Build Number: ${build:-N/A}"
    caddie cli:indent "Team ID: ${team_id:-N/A}"
    
    # Export for use by other functions
    export CADDIE_IOS_BUNDLE_ID="$bundle_id"
    export CADDIE_IOS_VERSION="$version"
    export CADDIE_IOS_BUILD="$build"
    export CADDIE_IOS_TEAM_ID="$team_id"
    export CADDIE_IOS_DISPLAY_NAME="$display_name"
    
    return 0
}

function caddie_ios_version_get() {
    _caddie_ios_load_config
    local project_file=""
    local workspace_file=""
    if ! IFS=$'\t' read -r project_file workspace_file < <(_caddie_ios_find_project_files); then
        return 1
    fi

    local scheme="$1"
    if ! scheme=$(_caddie_ios_resolve_scheme "$scheme" "$project_file" "$workspace_file" "caddie ios:version:get [scheme]"); then
        return 1
    fi

    local build_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    local version=$(echo "$build_settings" | grep "MARKETING_VERSION" | head -1 | sed 's/.*= *//' | xargs)

    if [ -n "$version" ]; then
        caddie cli:green "Version: $version"
        return 0
    fi

    caddie cli:yellow "Version: <not set>"
    return 1
}

function caddie_ios_version_set() {
    _caddie_ios_load_config
    local new_version="$1"
    local scheme="$2"

    if [ -z "$new_version" ]; then
        caddie cli:red "Error: Please provide a version number"
        caddie cli:usage "caddie ios:version:set <version> [scheme]"
        return 1
    fi

    local project_file=""
    local workspace_file=""
    if ! IFS=$'\t' read -r project_file workspace_file < <(_caddie_ios_find_project_files); then
        return 1
    fi
    if [ -z "$project_file" ]; then
        caddie cli:red "Error: .xcodeproj is required to update marketing version"
        return 1
    fi

    if ! scheme=$(_caddie_ios_resolve_scheme "$scheme" "$project_file" "$workspace_file" "caddie ios:version:set <version> [scheme]"); then
        return 1
    fi

    caddie cli:title "Setting Marketing Version (Scheme: $scheme)"

    local build_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    local current_version=$(echo "$build_settings" | grep "MARKETING_VERSION" | head -1 | sed 's/.*= *//' | xargs)

    caddie cli:indent "Current version: ${current_version:-<not set>}"
    caddie cli:indent "New version: $new_version"

    local update_success=false
    local verify_version=""
    if command -v agvtool >/dev/null 2>&1; then
        caddie cli:indent "Using agvtool to update marketing version..."
        if agvtool new-marketing-version "$new_version" >/dev/null 2>&1; then
            local check_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
            verify_version=$(echo "$check_settings" | grep "MARKETING_VERSION" | head -1 | sed 's/.*= *//' | xargs)
            if [ "$verify_version" = "$new_version" ]; then
                update_success=true
            else
                caddie cli:yellow "agvtool did not update version, trying fallback method..."
            fi
        else
            caddie cli:yellow "agvtool failed, trying fallback method..."
        fi
    fi

    if [ "$update_success" = false ]; then
        caddie cli:indent "Updating marketing version in project file..."
        local escaped_new_version=$(_caddie_ios_escape_sed_replacement "$new_version")
        if [ -n "$current_version" ]; then
            local escaped_current_version=$(_caddie_ios_escape_sed_pattern "$current_version")
            sed -i '' "s/MARKETING_VERSION = ${escaped_current_version};/MARKETING_VERSION = ${escaped_new_version};/g" "$project_file/project.pbxproj" 2>/dev/null || true
        else
            sed -i '' "s/MARKETING_VERSION = [^;]*;/MARKETING_VERSION = ${escaped_new_version};/g" "$project_file/project.pbxproj" 2>/dev/null || true
        fi
        if grep -Fq "MARKETING_VERSION = ${new_version};" "$project_file/project.pbxproj" 2>/dev/null; then
            update_success=true
        fi
        if [ "$update_success" = false ]; then
            local xcconfig_files=""
            local xcconfig_file=""
            xcconfig_files=$(find . -name "*.xcconfig" -type f 2>/dev/null)
            if [ -n "$xcconfig_files" ]; then
                caddie cli:indent "Updating marketing version in xcconfig files..."
                while IFS= read -r xcconfig_file; do
                    [ -n "$xcconfig_file" ] || continue
                    if grep -q "MARKETING_VERSION" "$xcconfig_file"; then
                        sed -i '' -E "s/^[[:space:]]*MARKETING_VERSION[[:space:]]*=.*/MARKETING_VERSION = ${escaped_new_version}/" "$xcconfig_file" 2>/dev/null || true
                    fi
                done <<< "$xcconfig_files"
            fi
        fi

        local info_plist=$(find . -name "Info.plist" -type f | head -1)
        if [ -n "$info_plist" ] && [ -f "$info_plist" ]; then
            if command -v /usr/libexec/PlistBuddy >/dev/null 2>&1; then
                /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $new_version" "$info_plist" 2>/dev/null \
                    || /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string $new_version" "$info_plist" 2>/dev/null \
                    || true
            fi
        fi
    fi

    local verify_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    verify_version=$(echo "$verify_settings" | grep "MARKETING_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    if [ "$verify_version" = "$new_version" ]; then
        caddie cli:check "Marketing version set to $new_version (verified)"
        export CADDIE_IOS_VERSION="$new_version"
        return 0
    fi

    caddie cli:red "Error: Version update failed verification (expected $new_version, got ${verify_version:-<empty>})"
    caddie cli:thought "Check if MARKETING_VERSION is controlled by xcconfig or build settings overrides."
    return 1
}

# Function to increment build number
function caddie_ios_increment_build() {
    _caddie_ios_load_config
    local project_file=""
    local workspace_file=""
    if ! IFS=$'\t' read -r project_file workspace_file < <(_caddie_ios_find_project_files); then
        return 1
    fi
    if [ -z "$project_file" ]; then
        caddie cli:red "Error: .xcodeproj is required to update build number"
        return 1
    fi

    local scheme="$1"
    if ! scheme=$(_caddie_ios_resolve_scheme "$scheme" "$project_file" "$workspace_file" "caddie ios:increment:build [scheme]"); then
        return 1
    fi
    
    caddie cli:title "Incrementing Build Number (Scheme: $scheme)"
    
    # Get current build number
    local build_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
    local current_build=$(echo "$build_settings" | grep "CURRENT_PROJECT_VERSION" | head -1 | sed 's/.*= *//' | xargs)
    
    if [ -z "$current_build" ]; then
        current_build="1"
    fi
    
    # Increment build number
    local new_build=$((current_build + 1))
    
    caddie cli:indent "Current build: $current_build"
    caddie cli:indent "New build: $new_build"
    
    local update_success=false
    
    # Update build number using agvtool if available, otherwise use direct file editing
    if command -v agvtool >/dev/null 2>&1; then
        caddie cli:indent "Using agvtool to update build number..."
        if agvtool new-version -all "$new_build" >/dev/null 2>&1; then
            update_success=true
        else
            caddie cli:yellow "agvtool failed, trying fallback method..."
        fi
    fi
    
    # Fallback: Update in project.pbxproj directly
    if [ "$update_success" = false ]; then
        caddie cli:indent "Updating build number in project file..."
        # Use sed to update CURRENT_PROJECT_VERSION in project.pbxproj
        # Escape regex metacharacters in both pattern and replacement
        local escaped_current_build=$(_caddie_ios_escape_sed_pattern "$current_build")
        local escaped_new_build=$(_caddie_ios_escape_sed_replacement "$new_build")
        if sed -i '' "s/CURRENT_PROJECT_VERSION = ${escaped_current_build};/CURRENT_PROJECT_VERSION = ${escaped_new_build};/g" "$project_file/project.pbxproj" 2>/dev/null; then
            # Check if the update actually occurred (use fixed string match for grep)
            if grep -Fq "CURRENT_PROJECT_VERSION = ${new_build};" "$project_file/project.pbxproj" 2>/dev/null; then
                update_success=true
            fi
        fi
        
        # Also update in Info.plist if it exists
        local info_plist=$(find . -name "Info.plist" -type f | head -1)
        if [ -n "$info_plist" ] && [ -f "$info_plist" ]; then
            if command -v /usr/libexec/PlistBuddy >/dev/null 2>&1; then
                /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $new_build" "$info_plist" 2>/dev/null || true
            fi
        fi
    fi
    
    # Verify the update succeeded by reading back the build number
    if [ "$update_success" = true ]; then
        # Re-read build settings to verify
        local verify_build_settings=$(_caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -showBuildSettings 2>/dev/null)
        local verify_build=$(echo "$verify_build_settings" | grep "CURRENT_PROJECT_VERSION" | head -1 | sed 's/.*= *//' | xargs)
        
        if [ "$verify_build" = "$new_build" ]; then
            caddie cli:check "Build number incremented to $new_build (verified)"
            return 0
        else
            caddie cli:red "Error: Build number update failed verification (expected $new_build, got ${verify_build:-<empty>})"
            caddie cli:thought "The build number may not have been updated correctly. Please check your project settings."
            return 1
        fi
    else
        caddie cli:red "Error: Failed to update build number"
        caddie cli:thought "Please check that your project is properly configured for versioning."
        caddie cli:thought "You may need to set CURRENT_PROJECT_VERSION in your project settings."
        return 1
    fi
}

# Function to create archive for TestFlight
function caddie_ios_archive_testflight() {
    _caddie_ios_load_config

    local project_file=""
    local workspace_file=""
    if ! IFS=$'\t' read -r project_file workspace_file < <(_caddie_ios_find_project_files); then
        return 1
    fi

    local scheme="$1"
    local archive_path="${2:-./build/archive}"

    if ! scheme=$(_caddie_ios_resolve_scheme "$scheme" "$project_file" "$workspace_file" "caddie ios:archive:testflight [scheme] [archive_path]"); then
        return 1
    fi
    
    caddie cli:title "Creating Archive for TestFlight (Scheme: $scheme)"
    
    # Create archive directory
    mkdir -p "$archive_path"
    
    local archive_name="${scheme}.xcarchive"
    local full_archive_path="$archive_path/$archive_name"
    
    # Clean up old archive if it exists
    if [ -d "$full_archive_path" ]; then
        caddie cli:indent "Removing old archive..."
        rm -rf "$full_archive_path"
    fi
    
    caddie cli:indent "Archive path: $full_archive_path"
    
    caddie cli:indent "Building archive..."
    if _caddie_ios_xcodebuild "$project_file" "$workspace_file" -scheme "$scheme" -configuration Release -archivePath "$full_archive_path" -destination "generic/platform=iOS" archive; then
        caddie cli:check "Archive created successfully"
        caddie cli:indent "Location: $full_archive_path"
        export CADDIE_IOS_ARCHIVE_PATH="$full_archive_path"
        return 0
    else
        caddie cli:red "Failed to create archive"
        return 1
    fi
}

function caddie_ios_archive() {
    caddie_ios_archive_testflight "$@"
    return $?
}

# Function to export IPA from archive
function caddie_ios_export_ipa() {
    local archive_path="${1:-${CADDIE_IOS_ARCHIVE_PATH:-}}"
    local export_path="${2:-./build/export}"
    local export_options_plist="${3:-}"
    
    if [ -z "$archive_path" ] || [ ! -d "$archive_path" ]; then
        caddie cli:red "Error: Archive path not provided or does not exist"
        caddie cli:usage "caddie ios:export:ipa [archive_path] [export_path] [export_options_plist]"
        return 1
    fi
    
    caddie cli:title "Exporting IPA from Archive"
    
    # Create export directory
    mkdir -p "$export_path"
    
    # Create export options plist if not provided
    if [ -z "$export_options_plist" ]; then
        export_options_plist="$export_path/ExportOptions.plist"
        
        # Get team ID from archive
        local team_id=$(/usr/libexec/PlistBuddy -c "Print :ApplicationProperties:TeamIdentifier" "$archive_path/Info.plist" 2>/dev/null | head -1 | xargs)
        local method="app-store-connect"
        
        caddie cli:indent "Creating export options plist..."
        cat > "$export_options_plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>${method}</string>
    <key>uploadSymbols</key>
    <true/>
    <key>uploadBitcode</key>
    <false/>
    <key>compileBitcode</key>
    <false/>
    <key>signingStyle</key>
    <string>automatic</string>
EOF
        if [ -n "$team_id" ]; then
            cat >> "$export_options_plist" <<EOF
    <key>teamID</key>
    <string>${team_id}</string>
EOF
        fi
        cat >> "$export_options_plist" <<EOF
</dict>
</plist>
EOF
        caddie cli:check "Export options plist created"
    fi
    
    caddie cli:indent "Export path: $export_path"
    
    # Export IPA
    if xcodebuild -exportArchive -archivePath "$archive_path" -exportPath "$export_path" -exportOptionsPlist "$export_options_plist"; then
        local ipa_file=$(find "$export_path" -name "*.ipa" -type f | head -1)
        if [ -n "$ipa_file" ]; then
            caddie cli:check "IPA exported successfully"
            caddie cli:indent "IPA location: $ipa_file"
            export CADDIE_IOS_IPA_PATH="$ipa_file"
            return 0
        else
            caddie cli:red "IPA file not found after export"
            return 1
        fi
    else
        caddie cli:red "Failed to export IPA"
        return 1
    fi
}

# Function to upload to TestFlight
function caddie_ios_upload_testflight() {
    _caddie_ios_load_config
    
    local ipa_path="${1:-${CADDIE_IOS_IPA_PATH:-}}"
    local apple_id="${2:-${CADDIE_IOS_APPLE_ID:-}}"
    local password="${3:-${CADDIE_IOS_APPLE_PASSWORD:-}}"
    local app_specific_password="${4:-${CADDIE_IOS_APP_SPECIFIC_PASSWORD:-}}"
    local api_key="${5:-${CADDIE_IOS_API_KEY:-}}"
    local api_issuer="${6:-${CADDIE_IOS_API_ISSUER:-}}"
    
    if [ -z "$ipa_path" ] || [ ! -f "$ipa_path" ]; then
        caddie cli:red "Error: IPA path not provided or file does not exist"
        caddie cli:usage "caddie ios:upload:testflight [ipa_path] [apple_id] [password]"
        return 1
    fi
    
    caddie cli:title "Uploading to TestFlight"

    # Prefer App Store Connect API key if configured
    if [ -n "$api_key" ] || [ -n "$api_issuer" ]; then
        if [ -z "$api_key" ] || [ -z "$api_issuer" ]; then
            caddie cli:red "Error: API key and issuer are both required for API auth"
            caddie cli:thought "Set them with: caddie ios:config:set api-key <key>"
            caddie cli:thought "Set them with: caddie ios:config:set api-issuer <issuer>"
            return 1
        fi
        if ! _caddie_ios_api_key_path "$api_key" >/dev/null 2>&1; then
            caddie cli:red "Error: API key file not found for key $api_key"
            caddie cli:thought "Place AuthKey_${api_key}.p8 in ~/.private_keys or ~/private_keys"
            return 1
        fi
        if ! command -v xcrun >/dev/null 2>&1 || ! xcrun altool --help >/dev/null 2>&1; then
            caddie cli:red "Error: xcrun altool not available"
            caddie cli:thought "Please ensure Xcode command line tools are installed"
            return 1
        fi
        caddie cli:indent "Using App Store Connect API key"
        caddie cli:indent "API Key: $api_key"
        caddie cli:indent "Issuer: $api_issuer"
        caddie cli:indent "IPA: $ipa_path"
        if xcrun altool --upload-app --type ios --file "$ipa_path" --apiKey "$api_key" --apiIssuer "$api_issuer"; then
            caddie cli:check "Upload completed successfully"
            caddie cli:blank
            caddie cli:title "Next Steps:"
            caddie cli:indent "1. Wait for processing in App Store Connect (5-30 minutes)"
            caddie cli:indent "2. Go to: https://appstoreconnect.apple.com"
            caddie cli:indent "3. Navigate to: My Apps → Your App → TestFlight"
            caddie cli:indent "4. Add build to testing groups when processing completes"
            return 0
        else
            caddie cli:red "Upload failed"
            return 1
        fi
    fi
    
    # Check for credentials
    if [ -z "$apple_id" ]; then
        caddie cli:red "Error: Apple ID not provided"
        caddie cli:thought "Set it with: caddie ios:config:set apple-id <email>"
        caddie cli:thought "Example: caddie ios:config:set apple-id 'your@apple.id'"
        return 1
    fi
    
    # Prefer app-specific password if provided (altool uses --password for both)
    local auth_password=""
    if [ -z "$app_specific_password" ] && [ -z "$password" ]; then
        app_specific_password=$(_caddie_ios_keychain_password_read "$apple_id")
        if [ -n "$app_specific_password" ]; then
            caddie cli:indent "Using app-specific password from keychain"
        fi
    fi
    if [ -n "$app_specific_password" ]; then
        auth_password="$app_specific_password"
        caddie cli:indent "Using app-specific password"
    elif [ -n "$password" ]; then
        auth_password="$password"
        caddie cli:indent "Using password (consider using app-specific password)"
    else
        if [ -t 0 ]; then
            local prompt_password=""
            prompt_password=$(_caddie_ios_prompt_secret "Enter app-specific password (masked):")
            if [ -n "$prompt_password" ]; then
                auth_password="$prompt_password"
                caddie cli:indent "Using password from prompt"
            fi
        fi
        if [ -z "$auth_password" ]; then
            caddie cli:red "Error: Password or app-specific password not provided"
            caddie cli:thought "Set it with: caddie ios:config:set password <app-specific-password>"
            caddie cli:thought "Or store in keychain: caddie ios:keychain:password:set <apple_id> <app-specific-password>"
            caddie cli:thought "Get app-specific password from: https://appleid.apple.com/account/manage"
            return 1
        fi
    fi
    
    caddie cli:indent "IPA: $ipa_path"
    caddie cli:indent "Apple ID: $apple_id"
    
    # Check if altool is available
    if ! command -v xcrun >/dev/null 2>&1 || ! xcrun altool --help >/dev/null 2>&1; then
        caddie cli:red "Error: xcrun altool not available"
        caddie cli:thought "Please ensure Xcode command line tools are installed"
        return 1
    fi
    
    # Upload using altool
    caddie cli:indent "Uploading..."
    if xcrun altool --upload-app --type ios --file "$ipa_path" --username "$apple_id" --password "$auth_password"; then
        caddie cli:check "Upload completed successfully"
        caddie cli:blank
        caddie cli:title "Next Steps:"
        caddie cli:indent "1. Wait for processing in App Store Connect (5-30 minutes)"
        caddie cli:indent "2. Go to: https://appstoreconnect.apple.com"
        caddie cli:indent "3. Navigate to: My Apps → Your App → TestFlight"
        caddie cli:indent "4. Add build to testing groups when processing completes"
        if [ -t 0 ]; then
            caddie cli:blank
            caddie cli:indent "Store app-specific password in keychain? [Y/n]"
            local store_choice=""
            read -r store_choice
            if [ -z "$store_choice" ]; then
                store_choice="y"
            fi
            case "$store_choice" in
                y|Y|yes|YES)
                    caddie_ios_keychain_password_set "$apple_id" "$auth_password" >/dev/null 2>&1 || true
                    caddie cli:check "Keychain password stored"
                    ;;
            esac
        fi
        return 0
    else
        caddie cli:red "Upload failed"
        return 1
    fi
}

# Complete TestFlight workflow: increment build, archive, export, upload
function caddie_ios_testflight() {
    _caddie_ios_load_config
    
    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local auto_increment="${2:-yes}"
    local upload="${3:-yes}"
    
    caddie cli:title "TestFlight Upload Workflow"
    caddie cli:blank
    
    # Step 1: Get project info
    if ! caddie_ios_project_info "$scheme"; then
        return 1
    fi
    
    # Step 2: Increment build if requested
    if [ "$auto_increment" = "yes" ]; then
        caddie cli:blank
        if ! caddie_ios_increment_build "$scheme"; then
            caddie cli:red "Error: Failed to increment build number"
            caddie cli:blank
            caddie cli:title "Options:"
            caddie cli:indent "1. Fix the build number issue and try again"
            caddie cli:indent "2. Manually increment build number in Xcode"
            caddie cli:indent "3. Continue without incrementing (may cause TestFlight rejection if duplicate)"
            caddie cli:blank
            caddie cli:thought "To continue anyway, run: caddie ios:testflight $scheme no"
            return 1
        fi
        # Refresh project info
        caddie_ios_project_info "$scheme" >/dev/null 2>&1
    fi
    
    # Step 3: Create archive
    caddie cli:blank
    if ! caddie_ios_archive_testflight "$scheme"; then
        return 1
    fi
    
    # Step 4: Export IPA
    caddie cli:blank
    if ! caddie_ios_export_ipa "$CADDIE_IOS_ARCHIVE_PATH"; then
        return 1
    fi
    
    # Step 5: Upload if requested
    if [ "$upload" = "yes" ]; then
        caddie cli:blank
        if ! caddie_ios_upload_testflight "$CADDIE_IOS_IPA_PATH"; then
            caddie cli:yellow "Warning: Upload failed, but archive and IPA were created"
            caddie cli:indent "You can upload manually later using:"
            caddie cli:indent "  caddie ios:upload:testflight \"$CADDIE_IOS_IPA_PATH\""
            return 1
        fi
    else
        caddie cli:blank
        caddie cli:title "Skipping Upload"
        caddie cli:indent "To upload later, run:"
        caddie cli:indent "  caddie ios:upload:testflight \"$CADDIE_IOS_IPA_PATH\""
    fi
    
    caddie cli:blank
    caddie cli:check "TestFlight workflow completed"
    return 0
}

function caddie_ios_testflight_publish() {
    _caddie_ios_load_config

    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local archive_path="${2:-./build/archive}"
    local export_path="${3:-./build/export}"
    local export_options_plist="${4:-}"

    caddie cli:title "TestFlight Publish"
    caddie cli:blank

    if ! caddie_ios_project_info "$scheme"; then
        return 1
    fi

    caddie cli:blank
    if ! caddie_ios_increment_build "$scheme"; then
        caddie cli:red "Error: Failed to increment build number"
        return 1
    fi

    # Refresh project info after increment
    caddie_ios_project_info "$scheme" >/dev/null 2>&1

    caddie cli:blank
    if ! caddie_ios_archive_testflight "$scheme" "$archive_path"; then
        return 1
    fi

    caddie cli:blank
    if ! caddie_ios_export_ipa "$CADDIE_IOS_ARCHIVE_PATH" "$export_path" "$export_options_plist"; then
        return 1
    fi

    caddie cli:blank
    if ! caddie_ios_upload_testflight "$CADDIE_IOS_IPA_PATH"; then
        return 1
    fi

    caddie cli:blank
    caddie cli:check "TestFlight publish completed"
    return 0
}

function caddie_ios_testflight_publish_increment_false() {
    _caddie_ios_load_config

    local scheme="${1:-${CADDIE_IOS_SCHEME:-}}"
    local archive_path="${2:-./build/archive}"
    local export_path="${3:-./build/export}"
    local export_options_plist="${4:-}"

    caddie cli:title "TestFlight Publish (No Increment)"
    caddie cli:blank
    caddie cli:thought "Build numbers must be unique in App Store Connect"

    if ! caddie_ios_project_info "$scheme"; then
        return 1
    fi

    caddie cli:blank
    if ! caddie_ios_archive_testflight "$scheme" "$archive_path"; then
        return 1
    fi

    caddie cli:blank
    if ! caddie_ios_export_ipa "$CADDIE_IOS_ARCHIVE_PATH" "$export_path" "$export_options_plist"; then
        return 1
    fi

    caddie cli:blank
    if ! caddie_ios_upload_testflight "$CADDIE_IOS_IPA_PATH"; then
        return 1
    fi

    caddie cli:blank
    caddie cli:check "TestFlight publish completed"
    return 0
}

# Function to setup Rust development environment for iOS
# Function to display iOS module help
function caddie_ios_help() {
    caddie cli:title "iOS Distribution Tools"
    caddie cli:blank
    caddie cli:usage "caddie ios:<command>"
    caddie cli:blank
    caddie cli:title "Project Information:"
    caddie cli:indent "project:info [scheme]          Show bundle ID, version, build number"
    caddie cli:indent "version:get [scheme]           Show marketing version"
    caddie cli:indent "version:set <version> [scheme] Set marketing version"
    caddie cli:indent "increment:build [scheme]       Increment build number"
    caddie cli:blank
    caddie cli:title "Configuration Management:"
    caddie cli:indent "config:get [key]               Get configuration value(s)"
    caddie cli:indent "config:set <key> <value>       Set configuration value"
    caddie cli:indent "config:unset <key>             Remove configuration value"
    caddie cli:indent "config:list                    List all configuration"
    caddie cli:indent "config:load:project [scheme]   Load project info into config"
    caddie cli:blank
    caddie cli:title "Keychain Auth:"
    caddie cli:indent "keychain:password:set <apple_id> <app-specific-password>  Store password in keychain"
    caddie cli:indent "keychain:password:get <apple_id>        Check if keychain password is set"
    caddie cli:indent "keychain:password:unset <apple_id>      Remove keychain password"
    caddie cli:blank
    caddie cli:title "App Store / TestFlight:"
    caddie cli:indent "archive [scheme] [path]        Create archive for distribution"
    caddie cli:indent "archive:testflight [scheme] [path]    Create archive for TestFlight"
    caddie cli:indent "export:ipa [archive] [path] [plist]   Export IPA from archive"
    caddie cli:indent "upload:testflight [ipa] [id] [pwd]    Upload IPA to TestFlight"
    caddie cli:indent "testflight [scheme] [increment] [upload]  Complete workflow"
    caddie cli:indent "testflight:publish [scheme] [archive] [export] [plist]  Increment + archive + export + upload"
    caddie cli:indent "testflight:publish:increment:false [scheme] [archive] [export] [plist]  Archive + export + upload"
    caddie cli:blank
    caddie cli:title "Notes:"
    caddie cli:indent "Build/run/test commands live in the Swift module (caddie swift:xcode:...)"
    caddie cli:blank
    return 0
}

function caddie_ios_description() {
    # caddie:lint:disable
    echo 'iOS App Store and TestFlight helpers'
    # caddie:lint:enable
    return 0
}

# Export iOS functions
export -f caddie_ios_description
export -f caddie_ios_archive
export -f caddie_ios_project_info
export -f caddie_ios_version_get
export -f caddie_ios_version_set
export -f caddie_ios_increment_build
export -f caddie_ios_archive_testflight
export -f caddie_ios_export_ipa
export -f caddie_ios_upload_testflight
export -f caddie_ios_testflight
export -f caddie_ios_testflight_publish
export -f caddie_ios_testflight_publish_increment_false
export -f caddie_ios_config_get
export -f caddie_ios_config_set
export -f caddie_ios_config_unset
export -f caddie_ios_config_list
export -f caddie_ios_config_load_project
export -f caddie_ios_keychain_password_set
export -f caddie_ios_keychain_password_get
export -f caddie_ios_keychain_password_unset
export -f caddie_ios_help

# Auto-load configuration when module is sourced
_caddie_ios_load_config
