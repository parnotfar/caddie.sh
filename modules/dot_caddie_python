#!/bin/bash

# Caddie.sh - Python Environment Management
# This file contains all Python-related functions

# Source CLI module for formatting
source "$HOME/.caddie_modules/.caddie_cli"

# Function to create a new Python virtual environment
function caddie_python_create() {
    local env_name="$1"
    
    if [ -z "$env_name" ]; then
        caddie cli:red "Error: Please provide a name for the virtual environment"
        caddie cli:usage "caddie python:create <name>"
        return 1
    fi
    
    local env_path="$HOME/.virtualenvs/$env_name"
    
    if [ -d "$env_path" ]; then
        caddie cli:red "Error: Virtual environment '$env_name' already exists"
        return 1
    fi
    
    caddie cli:title "Creating virtual environment '$env_name'..."
    python3 -m venv "$env_path"
    caddie cli:check "Virtual environment '$env_name' created successfully"
    caddie cli:indent "Location: $env_path"
    caddie cli:indent "Activate with: caddie python:activate $env_name"
    return 0
}

# Function to activate a Python virtual environment
function caddie_python_activate() {
    local env_name="$1"
    
    if [ -z "$env_name" ]; then
        caddie cli:red "Error: Please provide a name for the virtual environment"
        caddie cli:usage "caddie python:activate <name>"
        return 1
    fi
    
    local env_path="$HOME/.virtualenvs/$env_name"
    
    if [ ! -d "$env_path" ]; then
        caddie cli:red "Error: Virtual environment '$env_name' does not exist"
        caddie cli:thought "Create it with: caddie python:create $env_name"
        return 1
    fi
    
    caddie cli:title "Activating virtual environment '$env_name'..."
    # shellcheck disable=SC1091
    source "$env_path/bin/activate"
    caddie cli:check "Virtual environment '$env_name' activated"
    caddie cli:indent "Python: $(which python)"
    caddie cli:indent "Pip: $(which pip)"
    return 0
}

# Function to deactivate current Python virtual environment
function caddie_python_deactivate() {
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is currently active"
        return 0
    fi
    
    caddie cli:title "Deactivating virtual environment..."
    deactivate
    caddie cli:check "Virtual environment deactivated"
    return 0
}

# Function to list all Python virtual environments
function caddie_python_list() {
    local venv_dir="$HOME/.virtualenvs"
    
    if [ ! -d "$venv_dir" ]; then
        caddie cli:warning "No virtual environments found"
        caddie cli:thought "Create one with: caddie python:create <name>"
        return 0
    fi
    
    caddie cli:title "Available Python virtual environments"
    caddie cli:blank
    
    for env in "$venv_dir"/*; do
        if [ -d "$env" ]; then
            local env_name
            local env_name=$(basename "$env")
            if [ "$env" = "$VIRTUAL_ENV" ]; then
                caddie cli:check "$env_name (active)"
            else
                caddie cli:indent "$env_name"
            fi
        fi
    done
    return 0
}

# Function to remove a Python virtual environment
function caddie_python_remove() {
    local env_name="$1"
    
    if [ -z "$env_name" ]; then
        caddie cli:red "Error: Please provide a name for the virtual environment"
        caddie cli:usage "caddie python:remove <name>"
        return 1
    fi
    
    local env_path="$HOME/.virtualenvs/$env_name"
    
    if [ ! -d "$env_path" ]; then
        caddie cli:red "Error: Virtual environment '$env_name' does not exist"
        return 1
    fi
    
    if [ "$env_path" = "$VIRTUAL_ENV" ]; then
        caddie cli:red "Error: Cannot remove currently active virtual environment"
        caddie cli:thought "Deactivate it first with: caddie python:deactivate"
        return 1
    fi
    
    caddie cli:title "Removing virtual environment '$env_name'..."
    rm -rf "$env_path"
    caddie cli:check "Virtual environment '$env_name' removed successfully"
    return 0
}

# Function to show current Python environment
function caddie_python_current() {
    if [ -n "$VIRTUAL_ENV" ]; then
        caddie cli:title "Current Python environment"
        caddie cli:indent "Virtual Environment: $VIRTUAL_ENV"
        caddie cli:indent "Python: $(which python)"
        caddie cli:indent "Python Version: $(python --version)"
        caddie cli:indent "Pip: $(which pip)"
        caddie cli:indent "Pip Version: $(pip --version | cut -d' ' -f1-2)"
    else
        caddie cli:warning "No virtual environment is currently active"
        caddie cli:indent "System Python: $(which python3)"
        caddie cli:indent "System Python Version: $(python3 --version)"
    fi
    return 0
}

# Function to install a Python package
function caddie_python_install() {
    local package="$1"
    
    if [ -z "$package" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie python:install <package>"
        return 1
    fi
    
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
        read -p "Continue with system Python? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    caddie cli:title "Installing package '$package'..."
    pip install "$package"
    caddie cli:check "Package '$package' installed successfully"
    return 0
}

# Function to uninstall a Python package
function caddie_python_uninstall() {
    local package="$1"
    
    if [ -z "$package" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie python:uninstall <package>"
        return 1
    fi
    
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
        read -p "Continue with system Python? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    caddie cli:title "Uninstalling package '$package'..."
    pip uninstall -y "$package"
    caddie cli:check "Package '$package' uninstalled successfully"
    return 0
}

# Function to freeze current Python environment
function caddie_python_freeze() {
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
        read -p "Continue with system Python? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    caddie cli:title "Generating requirements.txt..."
    
    if pip freeze > requirements.txt; then
        caddie cli:check "requirements.txt generated successfully"
        caddie cli:indent "Packages: $(wc -l < requirements.txt)"
    else
        caddie cli:x "Failed to generate requirements.txt"
        return 1
    fi
    return 0
}

# Function to sync Python environment from requirements.txt
function caddie_python_sync() {
    if [ ! -f "requirements.txt" ]; then
        caddie cli:red "Error: requirements.txt not found in current directory"
        return 1
    fi
    
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
        read -p "Continue with system Python? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    caddie cli:title "Installing packages from requirements.txt..."
    pip install -r requirements.txt
    caddie cli:check "Packages installed successfully from requirements.txt"
    return 0
}

# Function to upgrade a Python package
function caddie_python_upgrade() {
    local package="$1"
    
    if [ -z "$package" ]; then
        caddie cli:red "Error: Please provide a package name"
        caddie cli:usage "caddie python:upgrade <package>"
        return 1
    fi
    
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
        read -p "Continue with system Python? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    caddie cli:title "Upgrading package '$package'..."
    pip install --upgrade "$package"
    caddie cli:check "Package '$package' upgraded successfully"
    return 0
}

# Function to show outdated Python packages
function caddie_python_outdated() {
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
        read -p "Continue with system Python? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    caddie cli:title "Checking for outdated packages..."
    pip list --outdated
    return 0
}

# Function to initialize Python project structure
function caddie_python_init() {
    caddie cli:title "Initializing Python project structure..."
    
    # Create basic project structure
    mkdir -p src tests docs
    touch src/__init__.py
    touch tests/__init__.py
    touch README.md
    touch .gitignore
    
    # Add common .gitignore entries
    cat >> .gitignore << EOF
# Python
__pycache__/
*.py[cod]
*.pyc
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual environments
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF

    # Create basic setup.py if it doesn't exist
    if [ ! -f "setup.py" ]; then
        cat > setup.py << EOF
from setuptools import setup, find_packages

setup(
    name="$(basename $(pwd))",
    version="0.1.0",
    packages=find_packages(where="src"),
    package_dir={"": "src"},
    python_requires=">=3.7",
    install_requires=[],
    extras_require={
        "dev": [
            "pytest>=6.0",
            "black",
            "flake8",
            "mypy",
        ],
    },
)
EOF
    fi
    
    caddie cli:check "Python project structure initialized"
    caddie cli:indent "Created: src/, tests/, docs/, README.md, .gitignore, setup.py"
    return 0
}

# Function to run Python tests
function caddie_python_test() {
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
    fi
    
    caddie cli:title "Running Python tests..."
    
    # Try pytest first, then unittest
    if command -v pytest >/dev/null 2>&1; then
        pytest
    elif [ -d "tests" ]; then
        python -m unittest discover tests
    else
        caddie cli:warning "No tests found. Create tests in the 'tests' directory"
        return 1
    fi
    return 0
}

# Function to run Python linting
function caddie_python_lint() {
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
    fi
    
    caddie cli:title "Running Python linting..."
    
    # Try flake8 first, then pylint
    if command -v flake8 >/dev/null 2>&1; then
        flake8 src/ tests/
    elif command -v pylint >/dev/null 2>&1; then
        pylint src/ tests/
    else
        caddie cli:warning "No linter found. Install flake8 or pylint"
        return 1
    fi
    return 0
}

# Function to format Python code
function caddie_python_format() {
    if [ -z "$VIRTUAL_ENV" ]; then
        caddie cli:warning "No virtual environment is active"
        caddie cli:thought "Consider activating one with: caddie python:activate <name>"
    fi
    
    caddie cli:title "Formatting Python code..."
    
    # Try black first, then autopep8
    if command -v black >/dev/null 2>&1; then
        black src/ tests/
    elif command -v autopep8 >/dev/null 2>&1; then
        autopep8 --in-place --recursive src/ tests/
    else
        caddie cli:warning "No formatter found. Install black or autopep8"
        return 1
    fi
    return 0
}

function caddie_python_description() {
    # caddie:lint:disable
    echo 'Python environment management'
    # caddie:lint:enable
    return 0
}

# Function to display Python module help
function caddie_python_help() {
    caddie cli:title "Python Environment Management"
    caddie cli:blank
    caddie cli:usage "caddie python:<command>"
    caddie cli:blank
    caddie cli:title "Virtual Environment Management:"
    caddie cli:indent "create <name>     Create new virtual environment"
    caddie cli:indent "activate <name>   Activate environment"
    caddie cli:indent "deactivate        Deactivate current environment"
    caddie cli:indent "list              List all environments"
    caddie cli:indent "remove <name>     Remove environment"
    caddie cli:indent "current           Show current environment"
    caddie cli:blank
    caddie cli:title "Package Management:"
    caddie cli:indent "install <pkg>     Install package in current env"
    caddie cli:indent "uninstall <pkg>   Uninstall package"
    caddie cli:indent "freeze            Generate requirements.txt"
    caddie cli:indent "sync              Install from requirements.txt"
    caddie cli:indent "upgrade <pkg>     Upgrade specific package"
    caddie cli:indent "outdated          Show outdated packages"
    caddie cli:blank
    caddie cli:title "Project Management:"
    caddie cli:indent "init              Initialize Python project structure"
    caddie cli:indent "test              Run tests"
    caddie cli:indent "lint              Run linting"
    caddie cli:indent "format            Format code"
    caddie cli:blank
    caddie cli:title "Examples:"
    caddie cli:indent "caddie python:create myenv"
    caddie cli:indent "caddie python:activate myenv"
    caddie cli:indent "caddie python:install requests"
    caddie cli:indent "caddie python:freeze"
    caddie cli:indent "caddie python:init"
    caddie cli:blank
    return 0
}

# Export Python functions
export -f caddie_python_description
export -f caddie_python_create
export -f caddie_python_activate
export -f caddie_python_deactivate
export -f caddie_python_list
export -f caddie_python_remove
export -f caddie_python_current
export -f caddie_python_install
export -f caddie_python_uninstall
export -f caddie_python_freeze
export -f caddie_python_sync
export -f caddie_python_upgrade
export -f caddie_python_outdated
export -f caddie_python_init
export -f caddie_python_test
export -f caddie_python_lint
export -f caddie_python_format
export -f caddie_python_help