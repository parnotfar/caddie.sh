#!/bin/bash

# Caddie.sh - Rust Environment Management
# This file contains all Rust-related functions

# Function to create a new Rust project
caddie_rust_new() {
    local project_name="$1"
    
    if [ -z "$project_name" ]; then
        echo "Error: Please provide a project name"
        echo "Usage: caddie rust:new <name>"
        return 1
    fi
    
    if [ -d "$project_name" ]; then
        echo "Error: Directory '$project_name' already exists"
        return 1
    fi
    
    echo "Creating new Rust project '$project_name'..."
    cargo new "$project_name"
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust project '$project_name' created successfully"
        echo "  Location: $(pwd)/$project_name"
        echo "  Enter directory: cd $project_name"
        echo "  Build project: caddie rust:build"
    else
        echo "✗ Failed to create Rust project '$project_name'"
        return 1
    fi
}

# Function to build current Rust project
caddie_rust_build() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Building Rust project..."
    cargo build
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust project built successfully"
    else
        echo "✗ Failed to build Rust project"
        return 1
    fi
}

# Function to run current Rust project
caddie_rust_run() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Running Rust project..."
    cargo run
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust project ran successfully"
    else
        echo "✗ Failed to run Rust project"
        return 1
    fi
}

# Function to run Rust tests
caddie_rust_test() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Running Rust tests..."
    cargo test
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust tests completed successfully"
    else
        echo "✗ Some Rust tests failed"
        return 1
    fi
}

# Function to check Rust project without building
caddie_rust_check() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Checking Rust project..."
    cargo check
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust project check passed"
    else
        echo "✗ Rust project check failed"
        return 1
    fi
}

# Function to clean Rust build artifacts
caddie_rust_clean() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Cleaning Rust build artifacts..."
    cargo clean
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust build artifacts cleaned"
    else
        echo "✗ Failed to clean Rust build artifacts"
        return 1
    fi
}

# Function to update Rust dependencies
caddie_rust_update() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Updating Rust dependencies..."
    cargo update
    
    if [ $? -eq 0 ]; then
        echo "✓ Rust dependencies updated"
    else
        echo "✗ Failed to update Rust dependencies"
        return 1
    fi
}

# Function to add a Rust dependency
caddie_rust_add() {
    local crate="$1"
    
    if [ -z "$crate" ]; then
        echo "Error: Please provide a crate name"
        echo "Usage: caddie rust:add <crate>"
        return 1
    fi
    
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Adding dependency '$crate'..."
    cargo add "$crate"
    
    if [ $? -eq 0 ]; then
        echo "✓ Dependency '$crate' added successfully"
    else
        echo "✗ Failed to add dependency '$crate'"
        return 1
    fi
}

# Function to remove a Rust dependency
caddie_rust_remove() {
    local crate="$1"
    
    if [ -z "$crate" ]; then
        echo "Error: Please provide a crate name"
        echo "Usage: caddie rust:remove <crate>"
        return 1
    fi
    
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Removing dependency '$crate'..."
    cargo remove "$crate"
    
    if [ $? -eq 0 ]; then
        echo "✓ Dependency '$crate' removed successfully"
    else
        echo "✗ Failed to remove dependency '$crate'"
        return 1
    fi
}

# Function to search crates.io
caddie_rust_search() {
    local query="$1"
    
    if [ -z "$query" ]; then
        echo "Error: Please provide a search query"
        echo "Usage: caddie rust:search <query>"
        return 1
    fi
    
    echo "Searching crates.io for '$query'..."
    cargo search "$query"
}

# Function to show outdated Rust dependencies
caddie_rust_outdated() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Checking for outdated Rust dependencies..."
    
    # Try cargo-outdated if available, otherwise show current versions
    if command -v cargo-outdated >/dev/null 2>&1; then
        cargo outdated
    else
        echo "Installing cargo-outdated for better outdated dependency checking..."
        cargo install cargo-outdated
        if [ $? -eq 0 ]; then
            cargo outdated
        else
            echo "Showing current dependency versions:"
            cargo tree
        fi
    fi
}

# Function to run Rust security audit
caddie_rust_audit() {
    if [ ! -f "Cargo.toml" ]; then
        echo "Error: Not in a Rust project directory (Cargo.toml not found)"
        return 1
    fi
    
    echo "Running Rust security audit..."
    
    # Try cargo-audit if available, otherwise install it
    if command -v cargo-audit >/dev/null 2>&1; then
        cargo audit
    else
        echo "Installing cargo-audit for security auditing..."
        cargo install cargo-audit
        if [ $? -eq 0 ]; then
            cargo audit
        else
            echo "✗ Failed to install cargo-audit"
            return 1
        fi
    fi
}

# Function to switch Rust toolchain
caddie_rust_toolchain() {
    local version="$1"
    
    if [ -z "$version" ]; then
        echo "Error: Please provide a toolchain version"
        echo "Usage: caddie rust:toolchain <version>"
        echo "Examples: stable, beta, nightly, 1.70.0"
        return 1
    fi
    
    echo "Switching to Rust toolchain '$version'..."
    rustup default "$version"
    
    if [ $? -eq 0 ]; then
        echo "✓ Switched to Rust toolchain '$version'"
        echo "  Current version: $(rustc --version)"
    else
        echo "✗ Failed to switch to Rust toolchain '$version'"
        return 1
    fi
}

# Function to add Rust compilation target
caddie_rust_target() {
    local target="$1"
    
    if [ -z "$target" ]; then
        echo "Error: Please provide a target"
        echo "Usage: caddie rust:target <target>"
        echo "Examples: x86_64-unknown-linux-gnu, aarch64-apple-darwin"
        return 1
    fi
    
    echo "Adding Rust target '$target'..."
    rustup target add "$target"
    
    if [ $? -eq 0 ]; then
        echo "✓ Added Rust target '$target'"
    else
        echo "✗ Failed to add Rust target '$target'"
        return 1
    fi
}

# Function to install Rust component
caddie_rust_component() {
    local component="$1"
    
    if [ -z "$component" ]; then
        echo "Error: Please provide a component name"
        echo "Usage: caddie rust:component <component>"
        echo "Examples: clippy, rustfmt, rust-src"
        return 1
    fi
    
    echo "Installing Rust component '$component'..."
    rustup component add "$component"
    
    if [ $? -eq 0 ]; then
        echo "✓ Installed Rust component '$component'"
    else
        echo "✗ Failed to install Rust component '$component'"
        return 1
    fi
}

# Function to display Rust module help
caddie_rust_help() {
    echo "Rust Development Tools"
    echo "====================="
    echo ""
    echo "Usage: caddie rust:<command>"
    echo ""
    echo "Project Management:"
    echo "  new <name>        Create new Rust project"
    echo "  build             Build current project"
    echo "  run               Run current project"
    echo "  test              Run tests"
    echo "  check             Check without building"
    echo "  clean             Clean build artifacts"
    echo ""
    echo "Dependency Management:"
    echo "  update            Update dependencies"
    echo "  add <crate>       Add dependency to Cargo.toml"
    echo "  remove <crate>    Remove dependency"
    echo "  search <query>    Search crates.io"
    echo "  outdated          Show outdated dependencies"
    echo "  audit             Security audit"
    echo ""
    echo "Toolchain Management:"
    echo "  toolchain <ver>   Switch toolchain (stable/beta/nightly)"
    echo "  target <target>   Add compilation target"
    echo "  component <comp>  Install component (clippy/rustfmt/etc)"
    echo ""
    echo "Examples:"
    echo "  caddie rust:new myproject"
    echo "  caddie rust:build"
    echo "  caddie rust:add serde"
    echo "  caddie rust:toolchain nightly"
    echo "  caddie rust:component clippy"
}

# Export Rust functions
export -f caddie_rust_new
export -f caddie_rust_build
export -f caddie_rust_run
export -f caddie_rust_test
export -f caddie_rust_check
export -f caddie_rust_clean
export -f caddie_rust_update
export -f caddie_rust_add
export -f caddie_rust_remove
export -f caddie_rust_search
export -f caddie_rust_outdated
export -f caddie_rust_audit
export -f caddie_rust_toolchain
export -f caddie_rust_target
export -f caddie_rust_component
export -f caddie_rust_help
